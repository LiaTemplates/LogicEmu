var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var f=a[d];f in c||(c[f]={});c=c[f]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.fill",function(a){return a?a:function(a,c,d){var b=this.length||0;0>c&&(c=Math.max(0,b+c));if(null==d||d>b)d=b;d=Number(d);0>d&&(d=Math.max(0,b+d));for(c=Number(c||0);c<d;c++)this[c]=a;return this}},"es6","es3");
$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var f=c++;return{value:b(f,a[f]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.values",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a,c){return c})}},"es8","es3");var doNotAddToParent="doNotAddToParent";
function makeElement(a,b){b=b||document.body;a=document.createElement(a);b!=doNotAddToParent&&b.appendChild(a);return a}function makeElementAt(a,b,c,d){a=makeElement(a,d);a.style.position="absolute";a.style.left=""+Math.floor(b)+"px";a.style.top=""+Math.floor(c)+"px";return a}
function makeAbsElement(a,b,c,d,f,e){a=makeElement(a,e);a.style.position="absolute";a.style.left=""+Math.floor(b)+"px";a.style.top=""+Math.floor(c)+"px";a.style.width=""+Math.floor(d)+"px";a.style.height=""+Math.floor(f)+"px";return a}function removeElement(a){a&&a.parentNode&&a.parentNode.contains(a)&&a.parentNode.removeChild(a)}function removeAllChildren(a){for(;a.firstChild;)a.removeChild(a.firstChild)}function makeDiv(a,b,c,d,f){return makeAbsElement("div",a,b,c,d,f)}
function styleUIElementBorder(a){a.style.border="1px solid #888"}function highlightUIElementBorder(a,b){a.style.border="2px solid "+(b||"black")}
function styleUIElement(a,b){styleUIElementBorder(a);a.style.height="20px";a.style.width="80px";a.style.margin="1px";a.style.padding="0";a.style.backgroundColor="#eee";a.style.cursor="pointer";a.style.boxShadow="0.5px 0.5px #aaa";a.style.textAligh="center";a.style.boxSizing="border-box";a.style.font="400 13px Arial";1==b&&(a.style.width="20px");2==b&&(a.style.width="40px");3==b&&(a.style.width="60px")}function makeUIElement(a,b,c){a=makeElement(a,b);styleUIElement(a,c);return a}
function makeUISpacer(a,b){b=makeElement("span",b);b.style.width=a+"px";b.style.display="inline-block"}function bind(a,b){var c=Array.prototype.slice.call(arguments,1),d=function(){return a.apply(this,c.concat(Array.prototype.slice.call(arguments)))};d.bound_f=a;d.bound_arg=b;return d}function textHasAt(a,b,c){return a.substr(b,c.length)==c}
function clone(a){if(null==a||"object"!=typeof a)return a;if(a instanceof Array){for(var b=[],c=0,d=a.length;c<d;c++)b[c]=clone(a[c]);return b}if(a instanceof Object){b=new a.constructor;for(c in a)a.hasOwnProperty(c)&&(b[c]=clone(a[c]));return b}throw Error("Cloning this object not supported.");}
function getCGIParameterByName(a,b){b=b||window.location.href;a=a.replace(/[\[\]]/g,"\\$&");return(a=(new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)")).exec(b))?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null}function getFragmentParameterByName(a,b){b=b||window.location.href;a=a.replace(/[\[\]]/g,"\\$&");return(a=(new RegExp("[#&]"+a+"(=([^&#]*)|&|#|$)")).exec(b))?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null}
function setFragment(a,b){history&&history.replaceState?b?history.replaceState(void 0,void 0,"#"+a+"="+b):window.location.hash&&history.replaceState(void 0,void 0,"#"):b?window.location.hash="#"+a+"="+b:window.location.hash&&(window.location.hash="")}function clearFragment(){setFragment("",null)}function getUrlWithoutQueries(){var a=window.location.href,b=a.indexOf("?");0<=b&&(a=a.substr(0,b));b=a.indexOf("#");0<=b&&(a=a.substr(0,b));return a}
function clearSelection(){document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()}function localStorageSupported(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}}function setLocalStorage(a,b){localStorageSupported()&&(localStorage[b]=a)}function getLocalStorage(a){if(localStorageSupported())return localStorage[a]}
var AUTOUPDATE=1,UPDATE_ALGORITHM=2,AUTO_CHOOSE_MODE=!0,NORMALAUTOSECONDS=.05,NORMALTIMERSECONDS=.1,AUTOSECONDS=NORMALAUTOSECONDS,TIMERSECONDS=NORMALTIMERSECONDS,TWIDDLE_PROBABILITY=.1,USE_BRESENHAM=!0,origtext="",origtitle=null,BACKSLASH_ALTERNATIVE=";",DQUOT_ALTERNATIVE="`",ASTERIX_ALTERNATIVE=".",graphics_mode=1,graphics_mode_browser=graphics_mode,graphics_mode_actual=graphics_mode_browser,worldDiv=makeDiv(10,128,0,0),renderingMessageDiv=makeDiv(10,128,0,0),numticks=0,tw=9,th=9,TYPE_index=0,TYPE_NULL=
TYPE_index++,TYPE_LOOSE_WIRE_EXPLICIT=TYPE_index++,TYPE_LOOSE_WIRE_IMPLICIT=TYPE_index++,TYPE_UNKNOWN_DEVICE=TYPE_index++,TYPE_SWITCH_OFF=TYPE_index++,TYPE_SWITCH_ON=TYPE_index++,TYPE_LED=TYPE_index++,TYPE_LED_RGB=TYPE_index++,TYPE_PUSHBUTTON_OFF=TYPE_index++,TYPE_PUSHBUTTON_ON=TYPE_index++,TYPE_TIMER_OFF=TYPE_index++,TYPE_TIMER_ON=TYPE_index++,TYPE_AND=TYPE_index++,TYPE_OR=TYPE_index++,TYPE_XOR=TYPE_index++,TYPE_NAND=TYPE_index++,TYPE_NOR=TYPE_index++,TYPE_XNOR=TYPE_index++,TYPE_FLIPFLOP=TYPE_index++,
TYPE_COUNTER=TYPE_index++,TYPE_CONSTANT=TYPE_index++,TYPE_DELAY=TYPE_index++,TYPE_ROM=TYPE_index++,TYPE_MUX=TYPE_index++,TYPE_IC=TYPE_index++,TYPE_IC_PASSTHROUGH=TYPE_index++,TYPE_VTE=TYPE_index++,TYPE_TRISTATE=TYPE_index++,TYPE_TRISTATE_INV=TYPE_index++,TYPE_RANDOM=TYPE_index++,TYPE_TOC=TYPE_index++,NUMBER_index=0,NUMBER_NONE=NUMBER_index++,NUMBER_LED=NUMBER_index++,NUMBER_TIMER=NUMBER_index++,NUMBER_ROM=NUMBER_index++,NUMBER_ICCALL=NUMBER_index++,NUMBER_ICDEF=NUMBER_index++,NUMBER_GLOBAL=NUMBER_index++,
NUMBER_BUS=NUMBER_index++,NUMBER_COMMENT=NUMBER_index++,typesymbols={};typesymbols[TYPE_NULL]="`";typesymbols[TYPE_SWITCH_OFF]="s";typesymbols[TYPE_SWITCH_ON]="S";typesymbols[TYPE_LED]="l";typesymbols[TYPE_LED_RGB]="L";typesymbols[TYPE_PUSHBUTTON_OFF]="p";typesymbols[TYPE_PUSHBUTTON_ON]="P";typesymbols[TYPE_TIMER_OFF]="r";typesymbols[TYPE_TIMER_ON]="R";typesymbols[TYPE_AND]="a";typesymbols[TYPE_OR]="o";typesymbols[TYPE_XOR]="e";typesymbols[TYPE_NAND]="A";typesymbols[TYPE_NOR]="O";
typesymbols[TYPE_XNOR]="E";typesymbols[TYPE_FLIPFLOP]="c";typesymbols[TYPE_CONSTANT]="c";typesymbols[TYPE_RANDOM]="?";typesymbols[TYPE_DELAY]="d";typesymbols[TYPE_TRISTATE]="z";typesymbols[TYPE_TRISTATE_INV]="Z";var devicemap={a:!0,A:!0,o:!0,O:!0,e:!0,E:!0,s:!0,S:!0,l:!0,L:!0,r:!0,R:!0,p:!0,P:!0,j:!0,k:!0,d:!0,t:!0,q:!0,Q:!0,c:!0,C:!0,y:!0,b:!0,B:!0,M:!0,i:!0,T:!0,z:!0,Z:!0,"?":!0},devicemapin=clone(devicemap);devicemapin["#"]=!0;var devicemaparea=clone(devicemapin);devicemaparea.$=!0;
var ffmap={j:!0,k:!0,d:!0,t:!0,q:!0,Q:!0,c:!0,C:!0,y:!0},rommap={b:!0,B:!0},inputmap={"^":!0,">":!0,v:!0,"<":!0,m:!0,"]":!0,w:!0,"[":!0,U:!0,G:!0,V:!0,W:!0},dinputmap={"^":!0,">":!0,v:!0,"<":!0,m:!0,"]":!0,w:!0,"[":!0},wiremap={"-":!0,"|":!0,"+":!0,"*":!0,ASTERIX_ALTERNATIVE:!0,"/":!0,"\\":!0,x:!0,g:!0,"=":!0,"(":!0,")":!0,n:!0,u:!0,",":!0,"%":!0,"&":!0,X:!0},antennamap={"(":!0,")":!0,n:!0,u:!0},diagonalmap={x:!0,V:!0,W:!0,"/":!0,"\\":!0,X:!0},knownmap={"-":!0,"|":!0,"+":!0,"*":!0,ASTERIX_ALTERNATIVE:!0,
"/":!0,"\\":!0,x:!0,g:!0,a:!0,A:!0,o:!0,O:!0,e:!0,E:!0,s:!0,S:!0,l:!0,L:!0,r:!0,R:!0,p:!0,P:!0,c:!0,C:!0,y:!0,j:!0,k:!0,t:!0,d:!0,q:!0,Q:!0,b:!0,B:!0,M:!0,"^":!0,">":!0,v:!0,"<":!0,m:!0,"]":!0,w:!0,"[":!0,U:!0,G:!0,V:!0,W:!0,"#":!0,"=":!0,i:!0,T:!0,"(":!0,")":!0,n:!0,u:!0,",":!0,"%":!0,"&":!0,X:!0,$:!0,z:!0,Z:!0,"?":!0,toc:!0},digitmap={0:!0,1:!0,2:!0,3:!0,4:!0,5:!0,6:!0,7:!0,8:!0,9:!0},defsubs={},callsubs=[],defsubs_order=[];
function DefSub(){this.components=[];this.translateindex={};this.translateindex2={};this.inputs=[];this.outputs=[];this.index=-2;this.error=!1;this.errormessage=null;this.externalinputs=[];this.markError=function(a){for(var b=0;b<this.components.length;b++)this.components[b].error=!0,a&&!this.components[b].errormessage&&(this.components[b].errormessage=a);this.error=!0;a&&(console.log(a),this.errormessage||(this.errormessage=a))};this.collectComponents=function(a,b){this.components=[];this.translateindex=
{};this.translateindex2={};for(var c=[],d=[],f=0;f<b.length;f++){var e=b[f];if(e.defsubindex==a){var g=this.components.length;this.components.push(e);this.translateindex[e.index]=g;this.translateindex2[g]=e.index;if(e.type==TYPE_LED){var k=e.corecell.x;e=e.corecell.y;var m=-1;e+1<h&&"^"==world[e+1][k].circuitsymbol?m=0:0<k&&">"==world[e][k-1].circuitsymbol?m=1:0<e&&"v"==world[e-1][k].circuitsymbol?m=2:k+1<w&&"<"==world[e][k+1].circuitsymbol?m=3:k+1<w&&0<e&&"V"==world[e-1][k+1].circuitsymbol?m=4:k+
1<w&&e+1<h&&"V"==world[e+1][k+1].circuitsymbol?m=5:0<k&&e+1<h&&"V"==world[e+1][k-1].circuitsymbol?m=6:0<k&&0<e&&"V"==world[e-1][k-1].circuitsymbol?m=7:k+1<w&&0<e&&2==world[e-1][k+1].circuitextra&&("v"==world[e-1][k+1].circuitsymbol||"<"==world[e-1][k+1].circuitsymbol)?m=4:k+1<w&&e+1<h&&2==world[e+1][k+1].circuitextra&&("<"==world[e+1][k+1].circuitsymbol||"^"==world[e+1][k+1].circuitsymbol)?m=5:0<k&&e+1<h&&2==world[e+1][k-1].circuitextra&&("^"==world[e+1][k-1].circuitsymbol||">"==world[e+1][k-1].circuitsymbol)?
m=6:0<k&&0<e&&2==world[e-1][k-1].circuitextra&&(">"==world[e-1][k-1].circuitsymbol||"v"==world[e-1][k-1].circuitsymbol)&&(m=7);0<=m&&d.push([g,m,k,e])}}}for(f=0;f<this.externalinputs.length;f++){a=this.externalinputs[f][0];b=this.externalinputs[f][1];m={};m[b*w+a]=!0;var q=[[a,b]];for(g=[];0<q.length;){var l=q.pop();g.push(l);for(var p=0;4>p;p++){var r=getNeighbor(l[0],l[1],p);r&&(k=r.x,e=r.y,m[e*w+k]||"#"!=r.circuitsymbol&&"$"!=r.circuitsymbol||(m[e*w+k]=!0,q.push([k,e])))}}m=-1;for(q=0;q<g.length;q++){k=
g[q][0];e=g[q][1];for(p=0;8>p;p++)if((r=getNeighbor(k,e,p))&&"#"!=r.circuitsymbol&&"$"!=r.circuitsymbol&&"s"!=r.circuitsymbol&&connected2(k,e,p)){m=getOppositeDir(p);break}if(0<=m)break}e=world[b][a].components[0];if(!e){this.markError("component not found for chip template");return}k=this.translateindex[e.index];0<=m&&c.push([k,m,a,b])}f=function(a,b){if(a[1]<b[1])return-1;if(a[1]>b[1])return 1;if(0==a[1])return a[2]-b[2];if(1==a[1])return b[3]-a[3];if(2==a[1])return b[2]-a[2];if(3==a[1])return a[3]-
b[3];if(4==a[1])return a[2]+a[3]-(b[2]+b[3]);if(5==a[1])return a[2]-a[3]-(b[2]-b[3]);if(6==a[1])return b[2]+b[3]-(a[2]+a[3]);if(7==a[1])return b[2]-b[3]-(a[2]-a[3])};c.sort(f);d.sort(f);this.inputs=c;this.outputs=d};this.init=function(){this.collectComponents(this.index,components);this.error&&this.markError(void 0)}}
function CallSub(a){this.components=[];this.wcomponents=[];this.cells=[];this.subindex=-2;this.inputs=[];this.outputs=[];this.outputvalues=[];this.inited=!1;this.defsub=null;this.error=!1;this.errormessage=null;this.subsubs=[];this.markError=function(a){for(var b=0;b<this.wcomponents.length;b++)this.wcomponents[b].error=!0,a&&!this.wcomponents[b].errormessage&&(this.wcomponents[b].errormessage=a);this.error=!0;a&&(console.log(a),this.errormessage||(this.errormessage=a))};this.copyComponents=function(a){this.components=
[];a=defsubs[this.subindex];for(var b=0;b<a.components.length;b++){var d=new Component;this.components.push(d);d.index=components.length;components.push(d)}for(b=0;b<a.components.length;b++){var f=a.components[b];d=this.components[b];d.issub=!0;d.value=f.value;d.prevvalue=f.prevvalue;d.type=f.type;d.inputs=[];d.inputs_negated=f.inputs_negated;d.inputs_x=f.inputs_x;d.inputs_y=f.inputs_y;d.inputs_x2=f.inputs_x2;d.inputs_y2=f.inputs_y2;d.input_ff_types=f.input_ff_types;d.cells=f.cells;d.corecell=f.corecell;
d.updated=f.updated;d.error=f.error;d.errormessage=f.errormessage;d.previnputs=clone(f.previnputs);d.ff_cycle=f.ff_cycle;d.ff_cycle_time=f.ff_cycle_time;d.master=null;d.rom=null;d.mux=null;d.ff=null;d.rom_out_pos=f.rom_out_pos;d.number=f.number;d.defsubindex=f.defsubindex;d.callsubindex=f.callsubindex;d.rgbcolor=f.rgbcolor;d.clocked=f.clocked;for(var e=0;e<f.inputs.length;e++){var g=this.components[a.translateindex[f.inputs[e].index]];g||(g=f.inputs[e]);d.inputs[e]=g}f.master&&(d.master=this.components[a.translateindex[f.master.index]]);
f.rom&&(e=new ROM,d.rom=e,e.onehot=f.rom.onehot,e.array=f.rom.ram?clone(f.rom.array):f.rom.array,e.output=clone(f.rom.output),e.x0=f.rom.x0,e.y0=f.rom.y0,e.x1=f.rom.x1,e.y1=f.rom.y1,e.master=d,e.master_orig_x=f.rom.master_orig_x,e.master_orig_y=f.rom.master_orig_y,e.error=f.rom.error,e.errormessage=f.rom.errormessage,e.addressdir=f.rom.addressdir,e.addresslsbpos=f.rom.addresslsbpos,e.worddir=f.rom.worddir,e.wordlsbpos=f.rom.wordlsbpos,e.selected=clone(f.rom.selected),e.num_address_inputs=f.rom.num_address_inputs,
e.ram=f.rom.ram,e.decoder=f.rom.decoder,e.encoder=f.rom.encoder);f.mux&&(e=new Mux,d.mux=e,e.master=d,e.error=f.mux.error,e.errormessage=f.mux.errormessage,e.dataindir=f.mux.dataindir,e.datainlsbpos=f.mux.datainlsbpos,e.selindir=f.mux.selindir,e.selinlsbpos=f.mux.selinlsbpos,e.output=clone(f.mux.output),e.numdatain=f.mux.numdatain,e.numselin=f.mux.numselin,e.numdataout=f.mux.numdataout,e.numselout=f.mux.numselout,e.demux=f.mux.demux,e.swap=f.mux.swap,e.bussize=f.mux.bussize,e.x0=f.mux.x0,e.y0=f.mux.y0,
e.x1=f.mux.x1,e.y1=f.mux.y1);f.ff&&(e=new FF,e.value=f.ff.value,e.numcC=f.ff.numcC,d.ff=e);f.tristate&&(e=new TriState,e.component=d,e.invin=f.tristate.invin,e.invout=f.tristate.invout,d.tristate=e);if(f.type==TYPE_SWITCH_OFF||f.type==TYPE_SWITCH_ON)d.type=TYPE_IC_PASSTHROUGH,d.inputs=[],d.inputs_x=[],d.inputs_y=[],d.inputs_x2=[],d.inputs_y2=[],d.inputs_negated=[]}this.components.length&&(this.components[0].callsub=this);for(b=0;b<this.components.length;b++)if(d=this.components[b],f=a.components[b],
f.callsub&&(e=new CallSub,this.subsubs.push(e),d.callsub=e,e.subindex=f.callsub.subindex,e.cells=f.callsub.cells,!e.init(this)))return!1;return!0};this.init=function(a){if(!this.inited){this.inited=!0;for(var b=[],d=[],f=0;f<this.cells.length;f++){var e=world[this.cells[f][1]][this.cells[f][0]];if("$"!=e.circuitsymbol)for(var g=0;g<e.components.length;g++){var k=e.components[g];a&&k&&(k=a.components[a.defsub.translateindex[k.index]]);if(k){this.master||(this.master=k,k.callsub=this);this.wcomponents.push(k);
for(var m=e.x,q=e.y,l=0;l<k.inputs.length;l++){for(var p=k.inputs_x[l],r=k.inputs_y[l],v=-1,t=0;8>t;t++){var u=getNeighbor(m,q,t);if(null!=u&&u.x==p&&u.y==r){v=t;break}}if(-1==v)return console.log("bug with IC input near "+m+", "+q),this.markError("bug with IC inputs near "+m+", "+q),!1;b.push([k.inputs[l],v,p,r,k.inputs_negated[l]])}connected2(m,q,g)&&"$"!=getNeighbor(m,q,g).circuitsymbol&&d.push([k,g,m,q])}}}f=defsubs[this.subindex];if(!f)return this.markError("IC template (which should be defined with a capital I) with this id does not exist, id: "+
this.subindex),!1;if(f.error)return this.markError(f.errormessage),!1;this.defsub=f;if(!this.copyComponents(a))return this.markError("copyComponents failed"),!1;var z=0;0<=this.chipdir&&(z=this.defsub.chipdir-this.chipdir&3);a=function(a,b){if(a[1]!=b[1]){var d=a[1]&4|a[1]+z&3,c=b[1]&4|b[1]+z&3;if(d<c)return-1;if(d>c)return 1}if(0==a[1])return a[2]-b[2];if(1==a[1])return b[3]-a[3];if(2==a[1])return b[2]-a[2];if(3==a[1])return a[3]-b[3];if(4==a[1])return a[2]+a[3]-(b[2]+b[3]);if(5==a[1])return a[2]-
a[3]-(b[2]-b[3]);if(6==a[1])return b[2]+b[3]-(a[2]+a[3]);if(7==a[1])return b[2]-b[3]-(a[2]-a[3])};b.sort(a);d.sort(a);this.inputs=b;this.outputs=d;return b.length!=f.inputs.length?(this.markError("unequal inputs amount in "+this.subindex+": IC instance: "+b.length+", IC template: "+f.inputs.length),!1):d.length!=f.outputs.length?(this.markError("unequal outputs amount in "+this.subindex+": IC instance: "+d.length+", IC template: "+f.outputs.length),!1):!0}};this.init2=function(a){if(!this.error){for(a=
0;a<this.subsubs.length;a++)this.subsubs[a].init2();var b=this.defsub,d=this.inputs,f=this.outputs;for(a=0;a<d.length;a++){var e=this.components[b.inputs[a][0]];e.inputs.push(d[a][0]);e.inputs_negated.push(d[a][4]);e.inputs_x.push(-1);e.inputs_y.push(-1);e.inputs_x2.push(-1);e.inputs_y2.push(-1)}for(a=0;a<f.length;a++)d=f[a][0],d.inputs=[this.components[b.outputs[a][0]]],d.inputs_negated=[!1],d.inputs_x=[-1],d.inputs_y=[-1],d.inputs_x2=[-1],d.inputs_y2=[-1],d.input_ff_types=[0],d.type=TYPE_IC_PASSTHROUGH}}}
function newOrder(a,b){for(var c=[],d=0;d<a.length;d++)c[d]=a[b[d]];for(d=0;d<a.length;d++)a[d]=c[d]}
function getIO2(a,b,c,d,f){for(var e=[],g=[],k=[],m=[],q=[],l=[],p=[],r=[],v=0;v<f.inputs.length;v++){var t=f.inputs_x[v],u=f.inputs_y[v];if(t==a-1)m.push(u);else if(t==c)g.push(u);else if(u==b-1)e.push(t);else if(u==d)k.push(t);else return null}for(t=a;t<c;t++)connected2(t,b,0)&&q.push(t),connected2(t,d-1,2)&&p.push(t);for(u=b;u<d;u++)connected2(a,u,3)&&r.push(u),connected2(c-1,u,1)&&l.push(u);return[[e,e.length],[g,g.length],[k,k.length],[m,m.length],[q,q.length],[l,l.length],[p,p.length],[r,r.length]]}
function getIO3(a,b,c,d,f){var e=[],g=0,k=[],m=0,q=[],l=0,p=[],r=0;if(0==f.inputs.length)return null;for(var v=0;v<f.inputs.length;v++){var t=f.inputs_x[v],u=f.inputs_y[v];if(t==a-1)p.push(u),r=1;else if(t==c)k.push(u),m=1;else if(u==b-1)e.push(t),g=1;else if(u==d)q.push(t),l=1;else return null}for(t=a;t<c;t++){if(connected2(t,b,0)){if(1==g)return null;e.push(t);g=2}if(connected2(t,d-1,2)){if(1==l)return null;q.push(t);l=2}}for(u=b;u<d;u++){if(connected2(a,u,3)){if(1==r)return null;p.push(u);r=2}if(connected2(c-
1,u,1)){if(1==m)return null;k.push(u);m=2}}a=[[e,e.length,g],[k,k.length,m],[q,q.length,l],[p,p.length,r]];for(v=c=b=0;4>v;v++)1==a[v][2]&&b++,2==a[v][2]&&c++;a[4]=b;a[5]=c;return a}
function ROM(){this.onehot=!1;this.array=[];this.output=[];this.y1=this.x1=this.y0=this.x0=0;this.master=null;this.master_orig_y=this.master_orig_x=0;this.error=!1;this.errormessage=null;this.addressdir=-1;this.addresslsbpos=0;this.worddir=-1;this.wordlsbpos=0;this.selected=[];this.num_address_inputs=-1;this.priority=this.encoder=this.decoder=this.ram=!1;this.lines=[];this.bits=[];this.lines_inv=[];this.bits_inv=[];this.updateRamDisplay=function(a,b){if(1==this.worddir){var c=this.bits[a];var d=this.wordlsbpos?
this.lines[this.lines.length-1-b]:this.lines[b]}else d=this.bits[a],c=this.wordlsbpos?this.lines[this.lines.length-1-b]:this.lines[b];c<this.x1&&d<this.y1&&c>=this.x0&&d>=this.y0&&(c=world[d][c],c.displaysymbol=this.array[b][a]?"B":"b",c.renderer.init2(c,c.displaysymbol,c.displaysymbol))};this.binaryToUnary=function(a){for(var b=0,c=1,d=0;d<this.num_address_inputs;d++)b+=a[d]*c,c*=2;return b};this.update=function(a){if(!this.error){for(var b=this.ram&&a[this.num_address_inputs],c=0;c<this.output.length;c++)this.output[c]=
!1;for(var d=0;d<this.selected.length;d++)this.selected[d]=!1;if(this.priority){if(a.length!=this.num_address_inputs+1||0!=a[a.length-1]){var f=-1;for(d=0;d<this.num_address_inputs;d++)a[d]&&(f=d);for(c=0;c<this.output.length;c++)this.output[c]=c==f}}else if(this.encoder){if(a.length!=this.num_address_inputs+1||0!=a[a.length-1])for(d=0;d<this.num_address_inputs;d++)if(a[d])for(c=0;c<this.output.length;c++)d>>c&1&&(this.output[c]=!0)}else if(this.decoder){if(a.length!=this.num_address_inputs+1||0!=
a[a.length-1])f=this.binaryToUnary(a),this.output[f]=!0}else if(this.onehot)for(d=0;d<this.num_address_inputs;d++){if(a[d]){if(b)for(c=0;c<this.array[d].length;c++)this.array[d][c]=a[this.num_address_inputs+1+c],this.updateRamDisplay(c,d);for(c=0;c<this.array[d].length;c++)this.output[c]|=this.array[d][c];this.selected[d]=!0}}else if(f=this.binaryToUnary(a),f<this.array.length){if(b)for(c=0;c<this.array[f].length;c++)this.array[f][c]=a[this.num_address_inputs+1+c],this.updateRamDisplay(c,f);for(c=
0;c<this.array[f].length;c++)this.output[c]=this.array[f][c];f<this.selected.length&&(this.selected[f]=!0)}}};this.init1=function(a,b,c,d){this.x0=a;this.y0=b;this.x1=c;this.y1=d;this.master=null;for(var f=b;f<d;f++){for(var e=a;e<c;e++){var g=world[f][e];if(!rommap[g.circuitsymbol]&&"#"!=g.circuitsymbol&&"$"!=g.circuitsymbol)return!1;if(g.components[0]){this.master=g.components[0];this.master_orig_x=e;this.master_orig_y=f;break}}if(this.master)break}if(!this.master)return!1;for(f=b;f<d;f++)for(e=
a;e<c;e++)g=world[f][e],g.components[0]?g.components[0].master=this.master:g.components[0]=this.master;this.master.rom=this;this.master.type=TYPE_ROM;return!0};this.getDirs=function(a){for(var b=this.x0,c=this.y0,d=this.x1,f=this.y1,e=0,g=0,k=-1,m=-1,q=-1,l=-1,p=0;4>p;p++)1==a[p][2]&&(e++,k=p,1==a[p][1]&&(q=p),1<a[p][1]&&(l=p)),2==a[p][2]&&(g++,m=p);if(1!=g)return null;g=m;var r=m&1;m=0==g||1==g?1:0;var v=r+1&1,t=0==g||3==g?0:1,u=[],z=[];p=[];for(var y=[],x=[],E=[],B=b;B<d;B++)E[B]=0,p[B-b]=-1;for(var C=
c;C<f;C++)for(x[C]=0,y[C-c]=-1,B=b;B<d;B++)if("b"==world[C][B].circuitsymbol||"B"==world[C][B].circuitsymbol)E[B]++,x[C]++;for(B=b;B<d;B++)E[B]&&(p[B-b]=u.length,u.push(B));for(C=c;C<f;C++)if(x[C]&&(y[C-c]=z.length,z.push(C),x[C]!=u.length))return null;for(B=b;B<d;B++)if(E[B]&&E[B]!=z.length)return null;1==r&&(x=u,u=z,z=x,x=p,p=y,y=x);this.lines=z;this.bits=u;this.lines_inv=y;this.bits_inv=p;B=z.length;C=u.length;if(3==e)for(p=0;4>p;p++)if(1==a[p][2]&&p!=(g+2&3)&&1!=a[p][1]){k=p;break}2==e&&(k=l);
var D=k&1,F=0==k||1==k?0:1,G=0;E=x=y=p=-1;if(1==B){if(1>e||2<e)return null;if(2==e&&(-1==l||-1==q))return!1;if(D!=r)return null;e=a[k][1];q=a[g][1];if(q==C&&e<C)e=2;else if(e==C&&q<C)e=3;else if(e==C&&q==C)e=4;else return null}else{l=a[k][1];q=a[g][1];if(q!=C)return null;if(1==e)e=0,D!=r&&l==B&&(G=1);else if(3==e){e=1;p=k+2&3;y=p&1;x=g+2&3;E=x&1;if(1!=a[p][1]||a[x][1]!=C)return null;l==B&&(G=1)}else return null}G&&(F=t);if(!G||2==e||3==e||4==e){if(0==D)for(C=c-1;C<=f;C++)0>C||C>=h||(0<b&&"0"==world[C][b-
1].metasymbol&&(F=0),d+1<w&&"0"==world[C][d+1].metasymbol&&(F=1));if(1==D)for(B=b-1;B<=d;B++)0>B||B>=w||(0<c&&"0"==world[c-1][b].metasymbol&&(F=0),f+1<h&&"0"==world[f+1][B].metasymbol&&(F=1))}b={type:e,onehot:G,word:[v,t],address:[k,k&1,a[k][0],a[k][1],F],out:[g,r,a[g][0],a[g][1],m]};1==e?(b.rwinput=[p,y,a[p][0],a[p][1],-1],b.datainput=[x,E,a[x][0],a[x][1],m]):(b.rwinput=[-1,-1,0,0,-1],b.datainput=[-1,-1,0,0,-1]);b.lines=z;b.bits=u;return b};this.sortInputs=function(a,b,c){for(var d=this.x0,f=this.y0,
e=this.x1,g=this.y1,k=this.worddir,m=[],q=0;q<this.master.inputs.length;q++)m[q]=q;var l=this;m=m.sort(function(k,m){var p=l.master.inputs_x[k];k=l.master.inputs_y[k];var q=l.master.inputs_x[m];m=l.master.inputs_y[m];var r=k<f?0:p>=e?1:k>=g?2:p<d?3:-1,t=m<f?0:q>=e?1:m>=g?2:q<d?3:-1;if(r!=t){if(r==a)return-1;if(t==a||r==b)return 1;if(t==b)return-1}t=r==a?c:0;return 0==(r&1)&&t?q-p:0==(r&1)?p-q:t?m-k:k-m});newOrder(this.master.inputs,m);newOrder(this.master.inputs_negated,m);newOrder(this.master.inputs_x,
m);newOrder(this.master.inputs_y,m);newOrder(this.master.inputs_x2,m);newOrder(this.master.inputs_y2,m);m=[[this.master,this.master_orig_x,this.master_orig_y]];for(var p=f;p<g;p++)for(var r=d;r<e;r++)q=world[p][r],rommap[q.circuitsymbol]&&q.components[0]&&q.components[0]!=this.master&&m.push([q.components[0],r,p]);if(this.decoder||this.encoder||this.priority){p={};for(q=0;q<m.length;q++)p[0==this.addressdir?m[q][1]:m[q][2]]=!0;k=[];for(var v in p)k.push(v);l=this;k.sort(function(a,b){return l.addresslsbpos?
b-a:a-b});v={};for(q=0;q<k.length;q++)v[k[q]]=q;for(q=0;q<m.length;q++){var t=m[q][0];r=m[q][1];p=m[q][2];t.rom_out_pos=0==this.addressdir?v[r]:v[p]}}else for(q=0;q<m.length;q++)t=m[q][0],r=m[q][1],p=m[q][2],t.rom_out_pos=this.bits_inv[0==k?p-f:r-d]};this.init2=function(){var a=this.x0,b=this.y0,c=this.x1,d=this.y1;if(!this.master)return!1;var f=getIO3(a,b,c,d,this.master);if(!f||1!=f[5])return!1;f=this.getDirs(f);if(!f)return!1;this.addressdir=f.address[1];this.addresslsbpos=f.address[4];this.worddir=
f.word[0];this.wordlsbpos=f.word[1];this.onehot=f.onehot;this.ram=1==f.type;this.decoder=2==f.type;this.encoder=3==f.type;this.priority=4==f.type;if(this.decoder||this.priority)this.array=[];else if(0==this.worddir)for(var e=0;e<this.lines.length;e++){var g=this.lines[e],k=0==this.wordlsbpos?e:this.lines.length-e-1;this.array[k]=[];for(var m=0;m<this.bits.length;m++){var q=this.bits[m],l=world[q][g].circuitsymbol;this.array[k][m]="B"==l}}else for(m=0;m<this.lines.length;m++)for(q=this.lines[m],k=
0==this.wordlsbpos?m:this.lines.length-m-1,this.array[k]=[],e=0;e<this.bits.length;e++)g=this.bits[e],l=world[q][g].circuitsymbol,this.array[k][e]="B"==l;this.output.length=f.out[3];this.selected.length=this.lines.length;if(this.ram)for(e=f.address[3],this.onehot||(20<e&&(e=20),e=1<<e),a=0==this.worddir?d-b:c-a,b=this.array.length;b<e;b++)for(this.array[b]=[],c=0;c<a;c++)this.array[b][c]=!1;this.num_address_inputs=f.address[3];this.sortInputs(f.address[0],f.datainput[0],f.address[4]);return!0}}
function Mux(){this.master=null;this.error=!1;this.errormessage=null;this.dataindir=-1;this.datainlsbpos=0;this.selinlsbpos=this.selindir=-1;this.output=[];this.numselout=this.numdataout=this.numselin=this.numdatain=0;this.swap=this.demux=!1;this.bussize=1;this.y1=this.x1=this.y0=this.x0=-1;this.update=function(a){for(var b=0,c=1,d=0;d<this.numselin;d++){var f=this.numdatain+d;b+=c*a[f];c+=c}if(1==this.bussize)if(this.demux){for(d=0;d<this.numdataout;d++)this.output[d]=!1;this.output[b]=a[0]}else if(this.swap)for(d=
0;d<this.numdataout;d++)this.output[d]=a[d^b];else this.output[0]=b<this.numdatain?a[b]:!1;else if(this.demux){for(d=0;d<this.numdataout;d++)this.output[d]=!1;for(d=0;d<this.bussize;d++)this.output[b*this.bussize+d]=a[d]}else if(this.swap)for(d=0;d<this.numdataout;d++)f=d%this.bussize,this.output[d]=a[(Math.floor(d/this.bussize)^b)*this.bussize+f];else for(d=0;d<this.bussize;d++)f=b*this.bussize+d,this.output[d]=f<this.numdatain?a[f]:!1;for(d=0;d<this.numselout;d++)this.output[this.numdataout+d]=
a[this.numdatain+d]};this.setError=function(a){this.error=!0;this.errormessage||(this.errormessage=a)};this.init1=function(a,b,c,d){this.master=null;this.x0=a;this.y0=b;this.x1=c;this.y1=d;for(var f=b;f<d;f++){for(var e=a;e<c;e++){var g=world[f][e];if("M"==g.circuitsymbol){this.master=g.components[0]||g.components[1];break}}if(this.master)break}if(!this.master)return this.setError("no master component found"),!1;for(f=b;f<d;f++)for(e=a;e<c;e++)g=world[f][e],g.components[0]&&(g.components[0].master=
this.master),g.components[1]&&(g.components[1].master=this.master);this.master.mux=this;this.master.type=TYPE_MUX;return!0};this.getDirs=function(a){for(var b=0,c=0,d=[-1,-1,-1],f=[-1,-1,-1],e=[-1,-1,-1],g=[-1,-1,-1],k=!1,m=-1,q=0;4>q;q++){var l=getOppositeDir(q);if(1==a[q][2]&&2==a[l][2]&&a[q][1]<a[l][1]){k=!0;m=q;break}}if(k){for(q=0;4>q;q++){if(1==a[q][2]){b++;if(2<b)return this.setError("too many input sides"),null;q==m?(d[0]=q,d[2]=a[q][1]):(e[0]=q,e[2]=a[q][1])}if(2==a[q][2]){c++;if(2<c)return this.setError("too many output sides"),
null;q==getOppositeDir(m)?(f[0]=q,f[2]=a[q][1]):(g[0]=q,g[2]=a[q][1])}}if(2>f[2])return this.setError("must have multiple outputs"),null;if(f[2]<1<<e[2])return this.setError("too few data outputs"),null}else{for(q=0;4>q;q++){if(1==a[q][2]){b++;if(2<b)return this.setError("too many input sides"),null;1==b&&(d[0]=q,d[2]=a[q][1]);2==b&&(e[0]=q,e[2]=a[q][1],e[2]>d[2]&&(m=e,e=d,d=m))}if(2==a[q][2]){c++;if(2<c)return this.setError("too many output sides"),null;1==c&&(f[0]=q,f[2]=a[q][1]);2==c&&(g[0]=q,
g[2]=a[q][1])}}if(2>d[2])return this.setError("must have multiple data inputs"),null;if(d[2]<1<<e[2])return this.setError("too few data inputs"),null}2==c&&g[0]==getOppositeDir(d[0])&&(m=g,g=f,f=m);if(-1==d[0])return this.setError("no data in"),null;if(-1==f[0])return this.setError("no data out"),null;if(-1==e[0])return this.setError("no sel in"),null;if(d[0]!=getOppositeDir(f[0]))return this.setError("data dir not opposite"),null;if(-1!=g[0]){if(e[0]!=getOppositeDir(g[0]))return this.setError("sel dir not opposite"),
null;if(g[2]!=e[2])return this.setError("passthrough sel output not matching amount"),null}else g[2]=0;a=0;if(0==e[0]||3==e[0])a=1;d[1]=f[1]=a;a=0;if(2==e[0]||3==e[0])a=1;e[1]=g[1]=a;a=!1;d[2]==f[2]&&(a=!0);return[d,f,e,g,k,a]};this.sortIO=function(a){for(var b=this.x0,c=this.y0,d=this.x1,f=this.y1,e=[],g=0;g<this.master.inputs.length;g++)e[g]=g;var k=this;e=e.sort(function(a,e){var g=k.master.inputs_x[a];a=k.master.inputs_y[a];var m=k.master.inputs_x[e];e=k.master.inputs_y[e];var l=a<c?0:g>=d?1:
a>=f?2:g<b?3:-1,p=e<c?0:m>=d?1:e>=f?2:m<b?3:-1;if(l!=p){if(l==k.dataindir)return-1;if(p==k.dataindir||l==k.selindir)return 1;if(p==k.selindir)return-1}p=l==k.dataindir?k.datainlsbpos:k.selinlsbpos;return 0==(l&1)&&p?m-g:0==(l&1)?g-m:p?e-a:a-e});newOrder(this.master.inputs,e);newOrder(this.master.inputs_negated,e);newOrder(this.master.inputs_x,e);newOrder(this.master.inputs_y,e);newOrder(this.master.inputs_x2,e);newOrder(this.master.inputs_y2,e);e=function(a){if(0==a)return[b,c,1,0,1,d-b];if(1==a)return[d-
1,c,0,1,0,f-c];if(2==a)return[b,f-1,1,0,1,d-b];if(3==a)return[b,c,0,1,0,f-c]};var m=0,q=e(getOppositeDir(this.dataindir)),l=a[getOppositeDir(this.dataindir)];for(g=0;g<l[0].length;g++){var p=g;this.datainlsbpos&&(p=l[0].length-g-1);p=l[0][p]-(this.dataindir&1?this.y0:this.x0);var r=q[0]+q[2]*p,v=q[1]+q[3]*p;p=q[4];r=world[v][r];"M"!=r.circuitsymbol&&"#"!=r.circuitsymbol||!r.components[p]||(r.components[p].rom_out_pos=m++)}q=e(getOppositeDir(this.selindir));l=a[getOppositeDir(this.selindir)];for(g=
0;g<l[0].length;g++)p=g,this.selinlsbpos&&(p=l[0].length-g-1),p=l[0][p]-(this.selindir&1?this.y0:this.x0),r=q[0]+q[2]*p,v=q[1]+q[3]*p,p=q[4],r=world[v][r],"M"!=r.circuitsymbol&&"#"!=r.circuitsymbol||!r.components[p]||(r.components[p].rom_out_pos=m++)};this.init2=function(){if(!this.master)return!1;var a=getIO3(this.x0,this.y0,this.x1,this.y1,this.master);if(!a)return this.setError("getting io error"),!1;var b=this.getDirs(a);if(!b)return this.setError("getting dirs error"),!1;this.demux=b[4];this.swap=
b[5];this.dataindir=b[0][0];this.datainlsbpos=b[0][1];this.selindir=b[2][0];this.selinlsbpos=b[2][1];this.output=[];this.numdatain=b[0][2];this.numselin=b[2][2];this.numdataout=b[1][2];this.numselout=b[3][2];b=1<<this.numselin;this.bussize=this.demux?this.numdatain:this.swap?Math.ceil(this.numdatain/b):this.numdataout;this.output.length=this.numdataout+this.numselout;this.sortIO(a);return!0}}
function VTE(){this.y1=this.x1=this.y0=this.x0=0;this.text=null;this.numoutputs=this.numinputs=-1;this.cursory=this.cursorx=0;this.prevread=this.prevwrite=!1;this.output=[0,0,0,0,0,0,0,0];this.counter=this.decimalinput=this.decimaldisplay=!1;this.previnput2=this.previnput=this.countervalue=0;this.keybuffer=[];this.newline=function(){var a=this.x1-this.x0,b=this.y1-this.y0;if(this.cursory+1<b)this.cursory++;else{for(var c=0;c+1<b;c++)this.text[c]=this.text[c+1];this.text[b-1]=[];for(c=0;c<a;c++)this.text[b-
1][c]=" "}this.cursorx=0};this.update=function(a){if(this.counter){var b=this.x1-this.x0-1,c=this.y1-this.y0-1,d=Math.max(this.x1-this.x0,this.y1-this.y0);a[0]&&!this.previnput&&this.countervalue++;this.previnput=a[0];1<a.length&&(a[1]&&!this.previnput2&&(this.countervalue=0),this.previnput2=a[1]);var f=this.countervalue;a=""+f;for(var e=0;e<d;e++){var g=e<a.length?a[a.length-e-1]:"";this.text[c][b]=g;b--;0>b&&(b=this.x1-1,c--)}b=1;for(e=0;e<this.numoutputs;e++)this.output[e]=f&b?1:0,b*=2}else if(this.decimaldisplay){f=
0;b=1;for(e=0;e<this.numinputs;e++)f+=a[e]*b,b*=2;b=this.x1-this.x0-1;c=this.y1-this.y0-1;a=""+f;for(e=0;e<this.numinputs;e++)g=e<a.length?a[a.length-e-1]:"",this.text[c][b]=g,b--,0>b&&(b=this.x1-this.x0-1,c--)}else if(this.decimalinput){a="";for(e=c=b=0;e<this.numoutputs;e++)g=this.text[c][b],a+=g,b++,b>=this.x1-this.x0&&(b=0,c++);f="0"==a[0]&&"x"==a[1]?parseInt(a):parseInt(a,10);b=(1<<this.numoutputs)-1;if(f>b){for(e=0;e<a.length;e++)this.doBackspace();f=b;a=""+f;for(e=0;e<a.length;e++)this.addChar(a[e])}b=
1;for(e=0;e<this.numoutputs;e++)a=f&b?1:0,0>f&&1<<e>-f&&(a=1),this.output[e]=a,b*=2}else{f=0;b=1;e=a[this.numinputs];c=a[this.numinputs+1];g=this.prevwrite;d=this.prevread;this.prevwrite=e;this.prevread=c;if(e&&!g){for(e=0;e<this.numinputs;e++)f+=a[e]*b,b*=2;if(10==f||13==f){this.newline();return}if(32>f||126<f)f=63;this.cursorx>=this.x1-this.x0&&this.newline();this.text[this.cursory][this.cursorx]=String.fromCharCode(f);this.cursorx++}this.output[this.numoutputs]=0==this.keybuffer.length;if(c&&!d&&
0<this.keybuffer.length)for(0<this.keybuffer.length&&(f=this.keybuffer.shift()),b=1,e=0;e<this.numoutputs;e++)this.output[e]=f&b?1:0,b*=2}};this.addChar=function(a){this.cursorx>=this.x1-this.x0&&this.newline();this.text[this.cursory][this.cursorx]=a;this.cursorx++};this.typeKeyboard=function(a){this.keybuffer.push(a&255);if(10==a||13==a)this.newline();else{if(32>a||126<a)a=63;this.addChar(String.fromCharCode(a))}};this.doBackspace=function(){this.cursorx--;0>this.cursorx&&(0<this.cursory?(this.cursorx=
this.x1-this.x0,this.cursory--):this.cursorx=0);this.text[this.cursory][this.cursorx]=""};this.init1=function(a,b,c,d){this.x0=a;this.y0=b;this.x1=c;this.y1=d;this.master=null;for(var f=b;f<d;f++)for(var e=a;e<c;e++){var g=world[f][e];if("T"!=g.symbol)return!1;if(g.components[0]){this.master=g.components[0];this.master_orig_x=e;this.master_orig_y=f;break}}if(!this.master)return!1;for(f=b;f<d;f++)for(e=a;e<c;e++)g=world[f][e],g.components[0]?g.components[0].master=this.master:g.components[0]=this.master;
this.master.vte=this;return!0};this.getDirs=function(a){for(var b=-1,c=-1,d=-1,f=-1,e=-1,g=-1,k=-1,m=-1,q=-1,l=-1,p=-1,r=0;4>r;r++)if(0!=a[r][1]||0!=a[r+4][1])if(1<a[r+4][1]){if(-1!=b||0<a[r][1])return null;b=r;c=r&1;p=0==r||1==r?1:0}else if(1<a[r][1]){if(-1!=d||0<a[r+4][1])return null;d=r;l=3==r||2==r?1:0}else if(1==a[r][1]&&0==a[r+4][1]){if(-1!=f&&-1!=g)return null;-1!=f?(g=r,k=r&1):(f=r,e=r&1)}else if(1==a[r][1]&&1==a[r+4][1]){if(-1!=m)return null;m=r;q=r&1}else return this.errormessage="ERROR: Unknown input/output count combination for VTE",
console.log(this.errormessage),null;if(-1==m&&-1==f&&-1==b&&-1!=d&&-1==g)this.decimaldisplay=!0;else if(-1==m&&-1!=f&&-1==b&&-1==d&&-1==g)d=f,l=1==d||2==d?1:0,f=e=-1,this.decimaldisplay=!0;else if(-1==m&&-1==f&&-1!=b&&-1==d&&-1==g)this.decimalinput=!0;else if(-1==m&&-1!=f&&-1!=b&&-1==d&&(e==c||k==c))this.counter=this.decimaldisplay=!0,-1==g?(d=f,f=-1):(e==c?(d=f,f=g,e=k):d=g,l=1==d||2==d?1:0),this.cursorx=this.cursory=-1;else if(-1!=g||-1==m&&-1==f||-1!=f!=(-1!=d)||-1!=m!=(-1!=b))return null;return{input:-1==
d?[-1,-1,[],-1,-1]:[d,d&1,a[d][0],a[d][1],l],write:-1==d?[-1,-1,[],-1,-1]:[f,e,[],-1,l],output:-1==b?[-1,-1,[],-1,-1]:[b,c,a[b+4][0],a[b+4][1],p],read:-1==b?[-1,-1,[],-1,-1]:[m,q,[],-1,p]}};this.sortIO=function(a){for(var b=this.x0,c=this.y0,d=this.x1,f=this.y1,e=a.input[0],g=a.output[0],k=a.output[1],m=a.write[0],q=a.input[4],l=a.output[4],p=[],r=0;r<this.master.inputs.length;r++)p[r]=r;var v=this;p=p.sort(function(a,g){var k=v.master.inputs_x[a];a=v.master.inputs_y[a];var l=v.master.inputs_x[g];
g=v.master.inputs_y[g];var p=a<c?0:k>=d?1:a>=f?2:k<b?3:-1,r=g<c?0:l>=d?1:g>=f?2:l<b?3:-1;if(p!=r){if(p==e)return-1;if(r==e)return 1;if(p==m)return-1;if(r==m)return 1}return p!=e&&r!=e&&p==r?0:0==(p&1)&&q?l-k:0==(p&1)?k-l:q?g-a:a-g});newOrder(this.master.inputs,p);newOrder(this.master.inputs_negated,p);newOrder(this.master.inputs_x,p);newOrder(this.master.inputs_y,p);newOrder(this.master.inputs_x2,p);newOrder(this.master.inputs_y2,p);p={};for(r=0;r<a.output[2].length;r++)p[a.output[2][r]]=r;for(a=
c;a<f;a++)for(r=b;r<d;r++){var t=world[a][r];t.components[0]&&(t=t.components[0],a<=c&&0==g||r>=d-1&&1==g||a>=f-1&&2==g||r<=b&&3==g?t.rom_out_pos=l?this.numoutputs-1-(1==k?p[a]:p[r]):1==k?p[a]:p[r]:t.rom_out_pos=this.numoutputs)}0<this.numoutputs&&(activeVTE=this,document.activeElement.blur())};this.init2=function(){var a=this.x0,b=this.y0,c=this.x1,d=this.y1;if(!this.master)return!1;var f=getIO2(a,b,c,d,this.master);if(!f)return!1;f=this.getDirs(f);if(!f)return!1;this.numinputs=f.input[3];this.numoutputs=
f.output[3];this.sortIO(f);a=c-a;b=d-b;this.text=[];for(d=0;d<b;d++)for(this.text[d]=[],c=0;c<a;c++)this.text[d][c]=" ";return!0}}
function countFFComponents(a){for(var b={numc:0,numC:0,numq:0,numQ:0,numff:0,numd:0,numy:0},c=0;c<a.length;c++){var d=world[a[c][1]][a[c][0]];"c"==d.circuitsymbol&&b.numc++;"C"==d.circuitsymbol&&b.numC++;"q"==d.circuitsymbol&&b.numq++;"Q"==d.circuitsymbol&&b.numQ++;"d"==d.circuitsymbol&&b.numd++;"y"==d.circuitsymbol&&b.numy++;ffmap[d.circuitsymbol]&&b.numff++}return b}
function getFFType(a){a=countFFComponents(a);var b=0<a.numC,c=TYPE_FLIPFLOP;if(1==a.numff){if(a.numc||a.numC)c=TYPE_COUNTER;a.numd&&(c=TYPE_DELAY)}return[c,b]}
function FF(){this.cells=[];this.numcC=0;this.value=!1;this.update=function(a){};this.init1=function(a){var b=[],c=countFFComponents(a);this.numcC=c.numc+c.numC;for(var d=0;d<a.length;d++)b.push(world[a[d][1]][a[d][0]]);c.numC&&(this.value=!0);this.master=b[0].components[0];for(d=0;d<b.length;d++)b[d].components[0].master=this.master,b[d].components[0].type=TYPE_FLIPFLOP;this.master.ff=this;this.cells=b;return!0};this.init2=function(){return!0}}
function TriState(){this.component=null;this.invout=this.invin=!1;this.init=function(a){this.component=a;a.type==TYPE_TRISTATE_INV&&(this.invout=this.invin=!0);for(var b=[],c=0;c<a.inputs.length;c++)b[c]=c;b=b.sort(function(b,c){return a.inputs_x2[b]==a.inputs_x2[c]?a.inputs_y2[b]-a.inputs_y2[c]:a.inputs_x2[b]-a.inputs_x2[c]});newOrder(a.inputs,b);newOrder(a.inputs_x,b);newOrder(a.inputs_y,b);newOrder(a.inputs_x2,b);newOrder(a.inputs_y2,b);newOrder(a.inputs_negated,b);for(c=0;c+2<a.inputs.length;c++)if(a.inputs_x2[c]==
a.inputs_x2[c+1]&&a.inputs_x2[c]==a.inputs_x2[c+2]&&a.inputs_y2[c]==a.inputs_y2[c+1]&&a.inputs_y2[c]==a.inputs_y2[c+2]){a.error=!0;a.errormessage="Invalid tristate buffer input combination: max 2 inputs per z. More makes no sense IRL so we do not simulate it to avoid confusion.";break}};this.update=function(){var a=this.component,b=this.invout?!0:!1,c=-1,d=-1;0<a.inputs.length&&(c=a.inputs_x2[0],d=a.inputs_y2[0]);for(var f=this.invin?!1:!0,e=0;e<a.inputs.length;e++){var g=a.inputs[e].value;a.inputs_negated[e]&&
(g=!g);this.invin?g&&(f=!0):g||(f=!1);var k=g=-2;e+1<a.inputs.length&&(g=a.inputs_x2[e+1],k=a.inputs_y2[e+1]);if(g!=c||k!=d){c=g;d=k;if(this.invout){if(!f){b=!1;break}}else if(f){b=!0;break}f=this.invin?!1:!0}}return b}}var buses=[];function Bus(){this.connections={}}var highlightedcomponent=null;
function Component(){this.prevvalue=this.value=!1;this.type=TYPE_NULL;this.inputs=[];this.inputs_negated=[];this.cells=[];this.corecell=null;this.updated=!1;this.index=-1;this.error=!1;this.errormessage=null;this.previnputs=[];this.ff_cycle=!1;this.ff_cycle_time=0;this.input_ff_types=[];this.tristate=this.ff=this.vte=this.mux=this.rom=this.master=null;this.rom_out_pos=-1;this.inputs_x=[];this.inputs_y=[];this.inputs_x2=[];this.inputs_y2=[];this.number=-1;this.callsubindex=this.defsubindex=-2;this.callsub=
null;this.rgbcolor=0;this.changed=this.clocked=this.issub=!1;this.changedticks=0;this.markError=function(a){this.error=!0;a||(a="component error");for(var b=0;b<this.cells.length;b++)world[this.cells[b][1]][this.cells[b][0]].markError(a);a&&!this.errormessage&&(this.errormessage=a)};this.sortInputsNESW=function(){for(var a=this,b=[],c=0;c<this.inputs.length;c++)b[c]=c;var d=a.corecell.x,f=a.corecell.y;b=b.sort(function(b,c){var e=a.inputs_x[b];b=a.inputs_y[b];var g=a.inputs_x[c];c=a.inputs_y[c];var q=
b<f?0:e>d?1:b>f?2:3,l=c<f?0:g>d?1:c>f?2:3;return q!=l?q-l:0==q?e-g:1==q?c-b:2==q?g-e:3==q?b-c:0});newOrder(this.inputs,b);newOrder(this.inputs_negated,b);newOrder(this.inputs_x,b);newOrder(this.inputs_y,b);newOrder(this.inputs_x2,b);newOrder(this.inputs_y2,b);newOrder(this.input_ff_types,b)};this.hasLength2CycleWithTwoInputs=function(){if(this.type==TYPE_FLIPFLOP||this.type==TYPE_VTE||this.type==TYPE_ROM)return!1;for(var a,b=0;b<this.inputs.length;b++)if(a=this.inputs[b],a!=this&&a.type!=TYPE_FLIPFLOP&&
a.type!=TYPE_VTE&&a.type!=TYPE_ROM)for(var c=0;c<a.inputs.length;c++)if(a.inputs[c]==this){for(var d=null,f=0;f<this.inputs.length+a.inputs.length;f++){var e=f<this.inputs.length?this.inputs[f]:a.inputs[f-this.inputs.length];if(e!=this&&e!=a){d=e;break}}for(var g=null;f<this.inputs.length+a.inputs.length;f++)if(e=f<this.inputs.length?this.inputs[f]:a.inputs[f-this.inputs.length],e!=this&&e!=a){g=e;break}if(d&&g)return!0}return!1};this.getNewValue=function(a,b){if(this.type!=TYPE_LOOSE_WIRE_IMPLICIT&&
this.type!=TYPE_LOOSE_WIRE_EXPLICIT){if(this.type==TYPE_CONSTANT)return this.value;if(this.type!=TYPE_SWITCH_OFF){if(this.type==TYPE_SWITCH_ON)return 0==b||0<a;if(this.type==TYPE_LED)return 0<a;if(this.type!=TYPE_PUSHBUTTON_OFF){if(this.type==TYPE_PUSHBUTTON_ON)return 0==b||0<a;if(this.type!=TYPE_TIMER_OFF){if(this.type==TYPE_TIMER_ON)return this.clocked&&(0==b||0<a);if(this.type==TYPE_AND)return 0==b;if(this.type==TYPE_OR||this.type==TYPE_IC_PASSTHROUGH)return 0!=a;if(this.type==TYPE_XOR)return 1==
(a&1);if(this.type==TYPE_NAND)return 0!=b;if(this.type==TYPE_NOR)return 0==a;if(this.type==TYPE_XNOR)return 0==(a&1);if(this.type==TYPE_DELAY||this.type==TYPE_COUNTER||this.type==TYPE_FLIPFLOP||this.type==TYPE_ROM||this.type==TYPE_MUX||this.type==TYPE_VTE)return this.value;if(this.type==TYPE_RANDOM)return.5>Math.random()}}}}return!1};this.setInitialValue=function(){var a=this.getNewValue(0,this.inputs.length);if(this.type==TYPE_FLIPFLOP){this.ff&&(a=this.ff.value);this.master&&this.master.ff&&(a=
this.master.ff.value);for(var b=0;b<this.inputs.length;b++)this.previnputs[b]=!0}if(this.type==TYPE_COUNTER||this.type==TYPE_RANDOM)for(b=0;b<this.inputs.length;b++)this.previnputs[b]=!0;this.type==TYPE_DELAY&&0>this.number&&(this.number=1);this.prevvalue=this.value=a};this.update=function(){if(!this.updated){this.updated=!0;this.master&&this.master.update();var a=0,b=0,c=0,d=0,f=0,e=0,g=0,k=0,m=0,q=0,l=0,p=0,r=0,v=[];if(!(3==UPDATE_ALGORITHM&&this.ff_cycle&&5<this.ff_cycle_time&&this.type!=TYPE_FLIPFLOP&&
Math.random()<TWIDDLE_PROBABILITY)){for(var t=0;t<this.inputs.length;t++){var u=this.inputs_negated[t],z=this.inputs[t];if(z){if(0==UPDATE_ALGORITHM)var y=z.value;else 1==UPDATE_ALGORITHM?y=z.value:2==UPDATE_ALGORITHM?y=z.prevvalue:3==UPDATE_ALGORITHM&&(y=z.prevvalue);this.ff&&this.type==TYPE_FLIPFLOP&&(0==UPDATE_ALGORITHM||1==UPDATE_ALGORITHM)&&1<=this.input_ff_types[t]&&4>=this.input_ff_types[t]&&this.ff.numcC&&(y=z.prevvalue);(y=y!=u)?a++:b++;this.type==TYPE_FLIPFLOP&&this.ff&&(u=void 0==this.previnputs[t]?
y:this.previnputs[t],this.previnputs[t]=y,1==this.input_ff_types[t]?y?g++:e++:2==this.input_ff_types[t]?y?m++:k++:3==this.input_ff_types[t]?y?(g++,k++):(e++,m++):4==this.input_ff_types[t]?y?(g++,m++):(e++,k++):5==this.input_ff_types[t]?y&&q++:6==this.input_ff_types[t]?y&&l++:7==this.input_ff_types[t]?y?p++:r++:(y&&c++,y&&!u&&d++,!y&&u&&f++));if(this.type==TYPE_COUNTER||this.type==TYPE_RANDOM)u=void 0==this.previnputs[t]?y:this.previnputs[t],(this.previnputs[t]=y)&&c++,y&&!u&&d++,!y&&u&&f++;if(this.type==
TYPE_ROM||this.type==TYPE_MUX||this.type==TYPE_LED_RGB||this.type==TYPE_VTE)v[t]=y}else console.log("undefined input")}if(this.type==TYPE_ROM)this.master&&(this.rom&&this.rom.update(v),this.value=(this.rom||this.master.rom).output[this.rom_out_pos]);else if(this.type==TYPE_MUX)this.master&&(this.mux&&this.mux.update(v),this.value=(this.mux||this.master.mux).output[this.rom_out_pos]);else if(this.type==TYPE_VTE)this.master&&(this.vte&&this.vte.update(v),this.value=(this.vte||this.master.vte).output[this.rom_out_pos]);
else if(this.type==TYPE_IC)this.value=!1;else if(this.type==TYPE_LED_RGB){this.value=0<a;for(t=a=0;t<v.length&&3>t;t++)a+=v[t]<<t;this.rgbcolor=a}else if(this.type==TYPE_FLIPFLOP)if(a=d&1,this.ff&&(r=r&&!p,p?this.ff.numcC||(a=!0):r&&(a=!1),l&&q?r||(this.ff.value=!this.ff.value):l?r||(this.ff.value=!1):q?r||(this.ff.value=!0):a&&(g&&m||!(g||e||m||k)&&this.ff.numcC?this.ff.value=!this.ff.value:g?this.ff.value=!0:m&&(this.ff.value=!1))),a=this.ff||this.master&&this.master.ff){a=a.value;if("Q"==this.corecell.circuitsymbol||
"k"==this.corecell.circuitsymbol)a=!a;this.value=a}else console.log("suspicious: ff component without ff field");else if(this.type==TYPE_COUNTER)d&1&&(this.value=!this.value);else if(this.type==TYPE_RANDOM)d+f&1&&(this.value=.5>Math.random());else if(this.type==TYPE_DELAY)if(e=this.number,0>e&&(e=1),256<e&&(e=0),2!=UPDATE_ALGORITHM&&3!=UPDATE_ALGORITHM||e--,0<e){if(!this.reg)for(this.reg=[],g=this.regpos=0;g<e+1;g++)this.reg[g]=!1;!!this.reg[0==this.regpos?e-1:this.regpos-1]!=!!a&&(this.changedticks=
e);0<this.changedticks&&(this.changed=!0);this.changedticks--;this.reg[this.regpos]=a;this.regpos++;this.regpos>=e+1&&(this.regpos=0);this.value=this.reg[this.regpos]}else this.value=a;else this.type==TYPE_TRISTATE||this.type==TYPE_TRISTATE_INV?this.value=this.tristate.update():this.type==TYPE_TIMER_OFF?this.value=!1:(this.value=this.getNewValue(a,b),this.value!=this.prevvalue?this.ff_cycle_time++:this.ff_cycle_time=0);this.value!=this.prevvalue&&(this.changed=!0)}}};this.mousedown=function(a,b,c){if(a.shiftKey)isPaused()&&
highlightedcomponent==this?(highlightedcomponent=null,unpause(),render()):(pause(),highlightedcomponent=this,render(),autopaused=!0);else if(a.ctrlKey&&this.type!=TYPE_ROM){b=!0;this.type!=TYPE_PUSHBUTTON_OFF&&this.type!=TYPE_PUSHBUTTON_ON&&(this.type==TYPE_SWITCH_OFF?this.type=TYPE_SWITCH_ON:this.type==TYPE_SWITCH_ON?this.type=TYPE_SWITCH_OFF:this.type==TYPE_TIMER_OFF?this.type=TYPE_TIMER_ON:this.type==TYPE_TIMER_ON?this.type=TYPE_TIMER_OFF:this.type==TYPE_AND?this.type=TYPE_NAND:this.type==TYPE_NAND?
this.type=TYPE_AND:this.type==TYPE_OR?this.type=TYPE_NOR:this.type==TYPE_NOR?this.type=TYPE_OR:this.type==TYPE_XOR?this.type=TYPE_XNOR:this.type==TYPE_XNOR?this.type=TYPE_XOR:this.type==TYPE_TRISTATE?this.type=TYPE_TRISTATE_INV:this.type==TYPE_TRISTATE_INV?this.type=TYPE_TRISTATE:this.type==TYPE_CONSTANT||this.type==TYPE_COUNTER||this.type==TYPE_RANDOM?this.value=!this.value:b=!1);if(b){b=typesymbols[this.type];if(this.type==TYPE_CONSTANT||this.type==TYPE_COUNTER)b=this.value?"C":"c";b&&(this.corecell.symbol=
b,this.corecell.displaysymbol=b,this.corecell.circuitsymbol=b,this.corecell.initDiv2())}render()}else if(changeMode)if(changeDropdown.selectedIndex=0,c=this.value,a=changeMode,b=typesymbols[a],"rem_inputs"==changeMode)this.inputs=[];else{if("c"==changeMode&&(a=this.inputs.length?TYPE_COUNTER:TYPE_CONSTANT,c=!1,b="c"),"C"==changeMode&&(a=this.inputs.length?TYPE_COUNTER:TYPE_CONSTANT,c=!0,b="C"),a==TYPE_RANDOM&&(c=.5>Math.random()),this.type=a,this.value=c,changeMode=null,b)for(c=0;c<this.cells.length;c++)a=
world[this.cells[c][1]][this.cells[c][0]],devicemap[a.circuitsymbol]&&(a.symbol=b,a.displaysymbol=b,a.circuitsymbol=b,a.initDiv(a.x,a.y))}else{this.type==TYPE_SWITCH_OFF?(this.type=TYPE_SWITCH_ON,this.corecell.renderer.setLook(this.corecell,this.type)):this.type==TYPE_SWITCH_ON&&(this.type=TYPE_SWITCH_OFF,this.corecell.renderer.setLook(this.corecell,this.type));this.type==TYPE_PUSHBUTTON_OFF?(this.type=TYPE_PUSHBUTTON_ON,this.corecell.renderer.setLook(this.corecell,this.type)):this.type==TYPE_PUSHBUTTON_ON&&
(this.type=TYPE_PUSHBUTTON_OFF,this.corecell.renderer.setLook(this.corecell,this.type));if(this.type==TYPE_TIMER_OFF||this.type==TYPE_TIMER_ON)this.type=this.type==TYPE_TIMER_OFF?TYPE_TIMER_ON:TYPE_TIMER_OFF,this.corecell.renderer.setLook(this.corecell,this.type);this.type==TYPE_VTE&&(a=this.vte,a||(a=this.master.vte),a&&0<a.numoutputs&&(activeVTE=a));if(this.type==TYPE_ROM){a=this;this.master&&(a=this.master);a.rom&&(a=a.rom);if(!a.array||a.decoder||a.encoder)return;if(1==a.worddir){var d=a.bits_inv[b-
a.x0];b=a.lines_inv[a.wordlsbpos?a.y1-1-c:c-a.y0]}else d=a.bits_inv[c-a.y0],b=a.lines_inv[a.wordlsbpos?a.x1-1-b:b-a.x0];if(!a.array[b])return;a.array[b][d]=!a.array[b][d];a.updateRamDisplay(d,b)}global_changed_something=!0}};this.mouseup=function(a){if(this.type==TYPE_PUSHBUTTON_OFF)a.shiftKey||(this.type=TYPE_PUSHBUTTON_ON,this.corecell.renderer.setLook(this.corecell,this.type));else if(this.type==TYPE_PUSHBUTTON_ON)a.shiftKey||(this.type=TYPE_PUSHBUTTON_OFF,this.corecell.renderer.setLook(this.corecell,
this.type));else return!1;global_changed_something=!0;return!a.shiftKey}}var activeVTE=null;document.body.onkeypress=function(a){activeVTE&&!editmode&&("Backspace"!=a.code&&activeVTE.typeKeyboard(a.which||a.charCode||a.keyCode||0),global_changed_something=!0,update())};document.body.onkeydown=function(a){activeVTE&&a&&"Backspace"==a.code&&!editmode&&(activeVTE.doBackspace(),global_changed_something=!0,update())};
var lastmousedowncomponent=null,changeMode=null,led_off_fg_colors,led_off_bg_colors,led_off_border_colors,led_on_fg_colors,led_on_bg_colors,led_on_border_colors,rgb_led_fg_colors,rgb_led_bg_colors,ONCOLOR,OFFCOLOR,BGCOLOR,TEXTFGCOLOR,TEXTBGCOLOR,SWITCHON_FGCOLOR,SWITCHON_BGCOLOR,SWITCHON_BORDERCOLOR,SWITCHOFF_FGCOLOR,SWITCHOFF_BGCOLOR,SWITCHOFF_BORDERCOLOR,GATEBGCOLOR,LINKCOLOR,TITLECOLOR,TERMINALBGCOLOR,TERMINALFGCOLOR,BUSCOLORS;
function setColorScheme(a){0==a?(ONCOLOR="black",OFFCOLOR="#aaa",BGCOLOR="white",TEXTFGCOLOR="#000",TEXTBGCOLOR="#fff6ea",led_off_fg_colors="#d66 #d96 #dd6 #6d6 #66d #60d #d66 #666".split(" "),led_off_bg_colors="#fffafa #fffcfa #fffff4 #fafffa #fbfdff #faf8ff #fffdfd #fcfcfc".split(" "),led_off_border_colors="#fcc #fa8 #cc2 #afa #ddf #d8f #fac #fff".split(" "),led_on_fg_colors="red #a40 #880 green #44f #80f #d58 white".split(" "),led_on_bg_colors="#faa #fca #ff4 #afa #bdf #a8f #fdd #ccc".split(" "),
led_on_border_colors=led_on_fg_colors,rgb_led_fg_colors="#888 #f77 #dfd #dd0 #ccf #f8f #0dd #888".split(" "),rgb_led_bg_colors="#000 #f00 #0f0 #ff0 #00f #f0f #0ff #eee".split(" "),BUSCOLORS="#aaa #aab #aba #baa #bba #bab #abb #bbb".split(" "),SWITCHON_FGCOLOR=led_on_fg_colors[3],SWITCHON_BGCOLOR=led_on_bg_colors[3],SWITCHOFF_FGCOLOR=led_off_fg_colors[3],SWITCHOFF_BGCOLOR=led_off_bg_colors[3],SWITCHON_BORDERCOLOR=SWITCHON_FGCOLOR,SWITCHOFF_BORDERCOLOR=SWITCHOFF_FGCOLOR,GATEBGCOLOR="#f7f7f7",LINKCOLOR=
"#00e",TERMINALBGCOLOR=TITLECOLOR="black",TERMINALFGCOLOR="#0d0"):1==a?(ONCOLOR="#f44",OFFCOLOR="#080",BGCOLOR="black",TEXTFGCOLOR="#da0",TEXTBGCOLOR="#210",led_off_fg_colors="#d66 #d96 #dd6 #6d6 #66d #60d #d66 #666".split(" "),led_off_bg_colors="#400 #420 #440 #040 #004 #204 #422 #444".split(" "),led_off_border_colors="#800 #840 #880 #080 #008 #408 #844 #888".split(" "),led_on_fg_colors="red #a40 #880 green #44f #80f #d58 white".split(" "),led_on_bg_colors="#faa #fca #ff4 #afa #bdf #a8f #fdd #ccc".split(" "),
led_on_border_colors=led_on_fg_colors,rgb_led_fg_colors="#888 #f77 #dfd #dd0 #ccf #f8f #0dd #888".split(" "),rgb_led_bg_colors="#222 #f00 #0f0 #ff0 #00f #f0f #0ff #fff".split(" "),BUSCOLORS="#aaa #aab #aba #baa #bba #bab #abb #bbb".split(" "),SWITCHON_FGCOLOR=ONCOLOR,SWITCHON_BGCOLOR=led_on_bg_colors[3],SWITCHOFF_FGCOLOR="#0e0",SWITCHOFF_BGCOLOR="black",SWITCHON_BORDERCOLOR=SWITCHON_FGCOLOR,SWITCHOFF_BORDERCOLOR=SWITCHOFF_FGCOLOR,GATEBGCOLOR="#020",LINKCOLOR="#880",TITLECOLOR=TEXTFGCOLOR,TERMINALBGCOLOR=
"#00f",TERMINALFGCOLOR="#fff"):2==a?(setColorScheme(0),BGCOLOR="#aaa",ONCOLOR="white",OFFCOLOR="black",TEXTFGCOLOR="#00a",a=GATEBGCOLOR="#9b9b9b",led_off_fg_colors="#f00 #f80 #dd0 #0d0 #00d #a0d #f99 #eee".split(" "),led_off_bg_colors=[a,a,a,a,a,a,a,a],led_off_border_colors=led_off_fg_colors,led_on_fg_colors="white white white white white white white white".split(" "),led_on_bg_colors=led_off_fg_colors,led_on_border_colors=led_off_border_colors,SWITCHON_FGCOLOR="white",SWITCHOFF_FGCOLOR=SWITCHON_BGCOLOR=
"#0e0",SWITCHOFF_BGCOLOR=a,SWITCHON_BORDERCOLOR="white",SWITCHOFF_BORDERCOLOR=SWITCHOFF_FGCOLOR,BUSCOLORS="#666 #665 #656 #566 #556 #565 #655 #555".split(" "),TEXTBGCOLOR="none"):3==a?(setColorScheme(0),BGCOLOR="#008",ONCOLOR="#fff",OFFCOLOR="#aaf",TEXTFGCOLOR="#aaa",led_off_fg_colors="#f00 #f80 #dd0 #0d0 #00d #a0d #f99 #eee".split(" "),led_off_bg_colors="black black black black black black black black".split(" "),led_off_border_colors=led_off_fg_colors,led_on_fg_colors="white white white white white white white white".split(" "),
led_on_bg_colors=led_off_fg_colors,led_on_border_colors=led_off_border_colors,SWITCHON_FGCOLOR="white",SWITCHOFF_FGCOLOR=SWITCHON_BGCOLOR="#0e0",SWITCHOFF_BGCOLOR="#028",SWITCHON_BORDERCOLOR="white",SWITCHOFF_BORDERCOLOR=SWITCHOFF_FGCOLOR,BUSCOLORS="#666 #665 #656 #566 #556 #565 #655 #555".split(" "),TEXTBGCOLOR="none",GATEBGCOLOR="#228",LINKCOLOR="#880",TITLECOLOR=TEXTFGCOLOR):(setColorScheme(a-4),negateColorScheme())}
function normalizeCSSColor(a){"black"==a&&(a="#000000");"white"==a&&(a="#ffffff");"red"==a&&(a="#ff0000");"green"==a&&(a="#00ff00");"blue"==a&&(a="#0000ff");4==a.length&&(a="#"+a[1]+a[1]+a[2]+a[2]+a[3]+a[3]);return a}function negateColor(a){a=normalizeCSSColor(a);var b=(255-parseInt(a.substr(1,2),16)).toString(16),c=(255-parseInt(a.substr(3,2),16)).toString(16);a=(255-parseInt(a.substr(5,2),16)).toString(16);1==b.length&&(b="0"+b);1==c.length&&(c="0"+c);1==a.length&&(a="0"+a);return"#"+b+c+a}
function negateLigntness(a){a=normalizeCSSColor(a);var b=parseInt(a.substr(1,2),16),c=parseInt(a.substr(3,2),16);a=parseInt(a.substr(5,2),16);var d=Math.min(Math.min(b,c),a)+Math.max(Math.max(b,c),a);c=255-d+c;a=255-d+a;b=(255-d+b).toString(16);c=c.toString(16);a=a.toString(16);1==b.length&&(b="0"+b);1==c.length&&(c="0"+c);1==a.length&&(a="0"+a);return"#"+b+c+a}
function negateColorScheme(){ONCOLOR=negateColor(ONCOLOR);OFFCOLOR=negateColor(OFFCOLOR);BGCOLOR=negateColor(BGCOLOR);TEXTFGCOLOR=negateColor(TEXTFGCOLOR);TEXTBGCOLOR=negateColor(TEXTBGCOLOR);for(var a=0;a<led_off_fg_colors.length;a++)led_off_fg_colors[a]=negateLigntness(led_off_fg_colors[a]);for(a=0;a<led_off_bg_colors.length;a++)led_off_bg_colors[a]=negateLigntness(led_off_bg_colors[a]);for(a=0;a<led_off_border_colors.length;a++)led_off_border_colors[a]=negateLigntness(led_off_border_colors[a]);
for(a=0;a<led_on_fg_colors.length;a++)led_on_fg_colors[a]=negateLigntness(led_on_fg_colors[a]);for(a=0;a<led_on_bg_colors.length;a++)led_on_bg_colors[a]=negateLigntness(led_on_bg_colors[a]);for(a=0;a<led_on_border_colors.length;a++)led_on_border_colors[a]=negateLigntness(led_on_border_colors[a]);for(a=0;a<BUSCOLORS.length;a++)BUSCOLORS[a]=negateColor(BUSCOLORS[a]);SWITCHON_FGCOLOR=negateLigntness(SWITCHON_FGCOLOR);SWITCHON_BGCOLOR=negateLigntness(SWITCHON_BGCOLOR);SWITCHOFF_FGCOLOR=negateLigntness(SWITCHOFF_FGCOLOR);
SWITCHOFF_BGCOLOR=negateLigntness(SWITCHOFF_BGCOLOR);SWITCHON_BORDERCOLOR=negateLigntness(SWITCHON_BORDERCOLOR);SWITCHOFF_BORDERCOLOR=negateLigntness(SWITCHOFF_BORDERCOLOR);GATEBGCOLOR=negateColor(GATEBGCOLOR);LINKCOLOR=negateColor(LINKCOLOR);TITLECOLOR=negateColor(TITLECOLOR);TERMINALBGCOLOR=negateColor(TERMINALBGCOLOR);TERMINALFGCOLOR=negateColor(TERMINALFGCOLOR)}var colorscheme=getLocalStorage("color_scheme")||0;setColorScheme(colorscheme);var globalSingleBlinkingCursor=null;
function registerBlinkingCursor(a){if(a!=globalSingleBlinkingCursor){globalSingleBlinkingCursor&&(globalSingleBlinkingCursor.style.backgroundColor=TERMINALBGCOLOR);var b=function(){globalSingleBlinkingCursor.parentNode?(globalSingleBlinkingCursor.blinkOn?(globalSingleBlinkingCursor.style.backgroundColor=TERMINALBGCOLOR,globalSingleBlinkingCursor.blinkOn=!1):(globalSingleBlinkingCursor.style.backgroundColor=TERMINALFGCOLOR,globalSingleBlinkingCursor.blinkOn=!0),window.setTimeout(b,500)):globalSingleBlinkingCursor=
null},c=!globalSingleBlinkingCursor;globalSingleBlinkingCursor=a;c&&b()}}function getNewRenderer(){if(0==graphics_mode_actual)return new RendererText;if(1==graphics_mode_actual)return new RendererImg}var CLICKDEBUG=!1;
function Cell(){this.metasymbol=this.circuitsymbol=this.displaysymbol=this.symbol="";this.circuitextra=0;this.skipparsing=!1;this.components=[null,null,null,null,null,null,null,null];this.comment=!1;this.numberh=this.numberv=this.number=this.y=this.x=-1;this.numbertype=NUMBER_NONE;this.bus=null;this.callsubindex=this.defsubindex=-2;this.callsub=null;this.commentalign=-1;this.commentlength=0;this.antennay=this.antennax=-1;this.drawchip=!1;this.clickFun=this.renderer=null;this.setValue=function(a){if("b"==
this.circuitsymbol||"B"==this.circuitsymbol){a=this.components[0];if(!a)return;a.master&&(a=a.master);a=a.rom;if(!a)return;var b=a.worddir?this.y-a.y0:this.x-a.x0;a.wordlsbpos&&(b=a.worddir?a.y1-this.y-1:a.x1-this.x-1);a=a.selected[a.lines_inv[b]]}digitmap[this.displaysymbol]&&(a=!1);if("T"==this.circuitsymbol){if(a=this.components[0])if(a.master&&(a=a.master),(a=a.vte)&&a.text){b=this.x-a.x0;var c=this.y-a.y0;this.renderer.setTerminal(a.text[c][b],a==activeVTE&&b==a.cursorx&&c==a.cursory)}}else this.renderer.setValue(this,
a,this.components[0]?this.components[0].type:TYPE_NULL)};this.markError=function(a){};this.getErrorText=function(){if(this.components[0]){var a=this.components[0].errormessage;!a&&this.components[0].master&&(a=this.components[0].master.errormessage);return a}return"unknown error"};this.initDiv2=function(){var a=this.circuitsymbol,b=this.displaysymbol,c=b;"#"!=b&&"$"!=b||!this.components[0]||(this.components[0].type==TYPE_SWITCH_ON&&(c="S"),this.components[0].type==TYPE_SWITCH_OFF&&(c="s"),this.components[0].type==
TYPE_LED&&(c="l"),this.components[0].type==TYPE_LED_RGB&&(c="L"),this.components[0].type==TYPE_PUSHBUTTON_ON&&(c="P"),this.components[0].type==TYPE_PUSHBUTTON_OFF&&(c="p"),this.components[0].type==TYPE_TIMER_ON&&(c="R"),this.components[0].type==TYPE_TIMER_OFF&&(c="r"));var d=null;if(!this.comment){var f=a;if("#"==f||"$"==f)f=this.components[0].corecell.circuitsymbol;if("-"==f||"|"==f||"*"==f)d="wire. Shift+click to highlight.";if("s"==f||"S"==f)d="switch";if("p"==f||"P"==f)d="pushbutton";if("r"==
f||"R"==f)d="timer";"l"==f&&(d="LED");"L"==f&&(d="RGB LED");"?"==f&&(d="random generator");"a"==f&&(d="AND gate");"A"==f&&(d="NAND gate");"o"==f&&(d="OR gate");"O"==f&&(d="NOR gate");"e"==f&&(d="XOR gate");"E"==f&&(d="XNOR gate");if("c"==f||"C"==f)this.components[0]&&this.components[0].type==TYPE_CONSTANT?("c"==f&&(d="constant off"),"C"==f&&(d="constant on")):this.components[0]&&this.components[0].type==TYPE_COUNTER?("c"==f&&(d="counter off"),"C"==f&&(d="counter on")):d="flipflop clock input";"d"==
f&&(d=this.components[0]&&this.components[0].type==TYPE_DELAY?"delay":"flipflop D input");"y"==f&&(d="flipflop enable input");"t"==f&&(d="flipflop T input");"j"==f&&(d="flipflop J input");"k"==f&&(d="flipflop K input");"q"==f&&(d="flipflop output and async set");"Q"==f&&(d="flipflop inverted output and async reset");"z"==f&&(d="tristate buffer, inputs to same z ANDed, multiple z to wire high when any z high (like OR but read on). Allowed to have multiple output to the same wire, but should be used as one-hot (max 1 high to wire, rest must be low) only to be electrically correct and realistic, but logicemu does not enforce that (does not emulate shorts).)");
"Z"==f&&(d="tristate buffer, inputs to same Z ORed, multiple Z to wire low when any Z low (like AND but read on). Allowed to have multiple output to the same wire, but should be used as one-cold (max 1 low to wire, rest must be high) only to be electrically correct and realistic, but logicemu does not enforce that (does not emulate shorts).)");"g"==f&&(d="global (backplane) wire, connects to all other g with matching (or matching absense of) number");"("==f&&(d="backplane wire that connects to one matching connector to the right");
")"==f&&(d="backplane wire that connects to one matching connector to the left");"n"==f&&(d="backplane wire that connects to one matching connector to below");"u"==f&&(d="backplane wire that connects to one matching connector to the top");"I"==f&&(d="IC definition");"i"==f&&(d="IC instance");if("b"==f||"B"==f)if(d="ROM/RAM bit (b=0, B=1)",this.components[0]){var e=this.components[0].master;if(e=e?e.rom:this.components[0].rom)e.ram&&e.array&&e.array[0]?(d=e.array.length,e=e.array[0].length,d="RAM with "+
d+" "+e+"-bit values (b=0, B=1). Note that the RAM may be bigger than the amount of bits shown, if so only the first lines are shown. Clicking bits with the mouse can toggle them."):e.decoder?d="decoder (binary to unary)":e.encoder?d="encoder (unary to binary)":e.priority?d="priority selector (unary to unary)":e.array&&e.array[0]&&(d=e.array.length,e=e.array[0].length,d="ROM with "+d+" "+e+"-bit values (b=0, B=1). Clicking bits with the mouse can toggle them.")}"="==f&&(d="bus (wire bundle)");if("M"==
f&&(d="mux",e=(e=this.components[0].master)?e.mux:this.components[0].mux)){if(e.demux){d="demux";1<e.bussize&&(d+=" of width-"+e.bussize+" buses");1==e.bussize&&2<e.numdataout&&(d=""+e.numdataout+"-output "+d);var g="",k="";e.dataindir&1||!e.datainlsbpos||(g="right",k="left");e.dataindir&1||e.datainlsbpos||(g="left",k="right");e.dataindir&1&&e.datainlsbpos&&(g="bottom",k="top");e.dataindir&1&&!e.datainlsbpos&&(g="top",k="bottom");d=d+". "+("Output 0 is at the "+g+", output "+(e.numdataout-1)+" is at the "+
k)}else e.swap?(d="controlled swap",1<e.bussize&&(d+=" of width-"+e.bussize+" buses")):(d="mux",1<e.bussize&&(d+=" of width-"+e.bussize+" buses"),0<e.numselout&&(d+=" (with selection passthrough)"),1==e.bussize&&2<e.numdatain&&(d=""+e.numdatain+"-input "+d),k=g="",e.dataindir&1||!e.datainlsbpos||(g="right",k="left"),e.dataindir&1||e.datainlsbpos||(g="left",k="right"),e.dataindir&1&&e.datainlsbpos&&(g="bottom",k="top"),e.dataindir&1&&!e.datainlsbpos&&(g="top",k="bottom"),d=d+". "+("Input 0 is at the "+
g+", input "+(e.numdatain-1)+" is at the "+k));1<e.numselin&&(g="",e.selindir&1||!e.selinlsbpos||(g="right"),e.selindir&1||e.selinlsbpos||(g="left"),e.selindir&1&&e.selinlsbpos&&(g="bottom"),e.selindir&1&&!e.selinlsbpos&&(g="top"),d=d+". "+("There are "+e.numselin+" selection inputs and their LSB is at the "+g))}"T"==f&&(d="terminal",this.components[0]&&(f=(e=this.components[0].master)?e.vte:this.components[0].vte))&&(0<f.numinputs&&!f.counter&&(d+=" (with keyboard input)"),0<f.numoutputs&&!f.counter&&
(d+=" (with ascii output)"),f.counter&&(d+=" (as counter)"),f.decimaldisplay&&!f.counter&&(d+=" (as decimal display)"),f.decimalinput&&!f.counter&&(d+=" (as decimal input)"))}this.renderer.init2(this,b,c,d);this.comment||(b="s"==a||"S"==a||"p"==a||"P"==a||"r"==a||"R"==a||"b"==a||"B"==a,"#"!=a&&"$"!=a||!this.components[0]||(a=this.components[0].type,a!=TYPE_SWITCH_OFF&&a!=TYPE_SWITCH_ON&&a!=TYPE_PUSHBUTTON_OFF&&a!=TYPE_PUSHBUTTON_ON&&a!=TYPE_TIMER_OFF&&a!=TYPE_TIMER_ON)||(b=!0),b&&this.renderer.setCursorPointer())};
this.initDiv=function(a,b){if(" "!=this.displaysymbol||0==a&&b==h-1){this.renderer&&this.renderer.cleanup();this.renderer=getNewRenderer();var c=bind(function(a,b,c,g){clearSelection();g.stopPropagation();g.preventDefault();changeMode||(lastmousedowncomponent=a);1==AUTOUPDATE&&update();a&&a.mousedown(g,b,c);autopaused&&isPaused()&&!g.shiftKey&&unpause();if(CLICKDEBUG)for(console.log("==================="),console.log("CLICKDEBUG enabled!"),console.log("==================="),a=world[c][b],b="x: "+
b+", y: "+c+", circuitsymbol: "+a.circuitsymbol,-2<=a.number&&(b+=", number: "+a.number),console.log(b),-1==a.antennax&&-1==a.antennay||console.log("antennax: "+a.antennax+", antennay: "+a.antennay),b=0;b<a.components.length;b++)if(c=a.components[b])for(console.log("component: index: "+c.index+",  type: "+c.type+", corecell: "+c.corecell.circuitsymbol+", corecell.x: "+c.corecell.x+", corecell.y: "+c.corecell.y),g=0;g<c.inputs.length;g++)console.log("input "+g+": index: "+c.inputs[g].index+", type: "+
c.inputs[g].type+", corecell: "+(c.inputs[g].corecell?c.inputs[g].corecell.circuitsymbol+", corecell.x: "+c.inputs[g].corecell.x+", corecell.y: "+c.inputs[g].corecell.y:""+c.inputs[g].corecell));global_changed_something=!0;return!1},this.components[0],a,b);this.clickFun=c;this.renderer.init(this,a,b,c);this.initDiv2()}}}
function Renderer(){this.globalInit=function(){};this.cleanup=function(){};this.init=function(a,b,c,d){};this.init2=function(a,b,c){};this.markError=function(a,b){};this.setValue=function(a,b,c){};this.setLook=function(a,b){};this.setTerminal=function(a,b){}}
function setTocHTML(a,b){b.innerText="";for(var c=0,d=0;d<allRegisteredCircuits.length;d++)if(1!=a||0==allRegisteredCircuits[d].group)if(2!=a||0!=allRegisteredCircuits[d].group||"helpindex"==allRegisteredCircuits[d].linkid||"mainhelp"==allRegisteredCircuits[d].linkid){var f=makeDiv(0,c*th,tw,th,b);f.style.width="800px";var e=makeElementAt("span",0,0,f),g=allRegisteredCircuits[d].linkid,k=allRegisteredCircuits[d].text,m=allRegisteredCircuits[d].title;e.innerText=m;f.style.textAlign="left";allRegisteredCircuits[d].istitle?
e.style.color=TITLECOLOR:(e.style.color=LINKCOLOR,e.style.textDecoration="underline",e.style.cursor="pointer",e.onclick=bind(function(a,b,c,d){parseText(a,b,allRegisteredCircuits[d]);currentSelectedCircuit=d},k,m,g,d));c++}}
function findNearestSwitch(a,b,c,d,f,e){c=Math.floor(c/tw);f=Math.ceil(f/tw);e=Math.ceil(e/th);var g=Infinity,k=null;for(d=Math.floor(d/th);d<e;d++)for(var m=c;m<f;m++)if(!(0>m||0>d||m>=w||d>=h)){var q=world[d][m],l=q.circuitsymbol;if("s"==l||"S"==l||"p"==l||"P"==l||"r"==l||"R"==l){l=m*tw+(tw>>1)-a;var p=d*th+(th>>1)-b;l=l*l+p*p;l<g&&(g=l,k=q)}}return k}var AROUNDBUTTONRADIUS=32,MAINZINDEX=2,AROUNDZINDEX=1,BGZINDEX=0;
function RendererText(){this.prevchar=this.prevvalue=-1;this.div1=this.div0=null;this.init2done=!1;this.clickDiv=null;this.globalInit=function(){document.body.style.backgroundColor=BGCOLOR;worldDiv.onmousedown=function(a){var b=a.pageX-worldDiv.offsetLeft,c=a.pageY-worldDiv.offsetTop;(b=findNearestSwitch(b,c,b-AROUNDBUTTONRADIUS-tw,c-AROUNDBUTTONRADIUS-th,b+AROUNDBUTTONRADIUS+tw,c+AROUNDBUTTONRADIUS+th))&&b.clickFun(a)}};this.cleanup=function(){removeElement(this.div0);removeElement(this.div1)};this.init=
function(a,b,c,d){this.div0=makeDiv(b*tw,c*th,tw,th,worldDiv);this.div0.onmousedown=d;'"'!=a.circuitsymbol&&(this.div1=makeDiv(b*tw,c*th,tw,th,worldDiv),this.div1.onmousedown=d);a=a.circuitsymbol;"s"==a||"S"==a||"p"==a||"P"==a||"r"==a||"R"==a?(this.clickDiv=makeDiv(b*tw+(tw>>1)-AROUNDBUTTONRADIUS-tw,c*th+(th>>1)-AROUNDBUTTONRADIUS-th,2*AROUNDBUTTONRADIUS+2*tw,2*AROUNDBUTTONRADIUS+2*th,worldDiv),this.clickDiv.style.zIndex=AROUNDZINDEX):this.clickDiv=null};this.init2=function(a,b,c,d){if(" "!=b){this.init2done||
(this.div0.style.color=OFFCOLOR,this.div0.style.textAlign="center",this.div0.style.fontSize=tw+"px",this.div0.style.fontFamily="monospace",this.div0.style.backgroundColor="",this.div0.style.zIndex=MAINZINDEX,this.div1&&(this.div1.style.color=ONCOLOR,this.div1.style.textAlign="center",this.div1.style.fontSize=tw+"px",this.div1.style.fontFamily="monospace",this.div1.style.fontWeight="bold",this.div1.style.backgroundColor="",this.div1.style.zIndex=MAINZINDEX));a.comment||(this.div0.innerText=b,this.div1.innerText=
b);if(a.comment){c=TEXTFGCOLOR;var f=TEXTBGCOLOR;this.div0.style.color=c;this.div0.style.backgroundColor=f;if(0<=a.commentalign&&2>=a.commentalign){this.div0.innerText="";this.div0.style.backgroundColor="unset";var e=makeElement("span",this.div0);e.innerText=b;e.style.color=c;e.style.backgroundColor=f;e.style.whiteSpace="pre";e.style.fontSize=Math.floor(.9*tw)+"px";e.style.height=th+"px";e.style.lineHeight=th+"px";e.style.verticalAlign="top";this.div0.style.width=""+tw*a.commentlength+"px";0==a.commentalign?
this.div0.style.textAlign="left":1==a.commentalign?this.div0.style.textAlign="center":2==a.commentalign&&(this.div0.style.textAlign="right")}else this.div0.innerText=b;this.div0.onmousedown=null}else if("toc"==b)setTocHTML(a.circuitextra,this.div0);else{"l"==c&&(f=a.components[0]?a.components[0].number:0,-1==f&&(f=0),f>led_off_fg_colors.length&&(f=0),this.div0.style.color=led_off_fg_colors[f],this.div0.style.backgroundColor=led_off_bg_colors[f],this.div1.style.color=led_on_fg_colors[f],this.div1.style.backgroundColor=
led_on_bg_colors[f]);"L"==c&&(this.div0.style.color="#888",this.div0.style.backgroundColor="#888",this.div0.style.visibility="visible",this.div1.style.visibility="hidden");if("s"==c||"S"==c)this.div0.style.color=SWITCHOFF_FGCOLOR,this.div1.style.color=SWITCHON_FGCOLOR,this.div0.style.backgroundColor=SWITCHOFF_BGCOLOR,this.div1.style.backgroundColor=SWITCHON_BGCOLOR;if("p"==c||"P"==c)this.div0.style.color=SWITCHOFF_FGCOLOR,this.div1.style.color=SWITCHON_FGCOLOR,this.div0.style.backgroundColor=SWITCHOFF_BGCOLOR,
this.div1.style.backgroundColor=SWITCHON_BGCOLOR;if("r"==c||"R"==c)this.div0.style.color=SWITCHOFF_FGCOLOR,this.div1.style.color=SWITCHON_FGCOLOR,this.div0.style.backgroundColor=SWITCHOFF_BGCOLOR,this.div1.style.backgroundColor=SWITCHON_BGCOLOR;"T"==b&&(this.div0.style.visibility="hidden",this.div1.style.visibility="visible",this.div1.style.backgroundColor=TERMINALBGCOLOR,this.div1.style.color=TERMINALFGCOLOR,this.div1.innerText=" ",this.div1.style.fontSize=Math.floor(.9*tw)+"px");"|"==b&&(this.div0.style.marginTop=
"-"+(th>>2)+"px",this.div1.style.marginTop="-"+(th>>2)+"px")}a.components[0]&&a.components[0].error?this.markError(a,a.getErrorText()):d&&(this.div0.title=d,this.div1.title=d);this.init2done=!0}};this.markError=function(a,b){b||(b="parse error @ "+a.x+" "+a.y+"("+a.symbol+")");this.div0.style.backgroundColor="yellow";this.div1.style.backgroundColor="yellow";this.div0.style.color="red";this.div1.style.color="#f88";this.div0.title=b;this.div1.title=b};this.setCursorPointer=function(){this.div0.style.cursor=
"pointer";this.div1.style.cursor="pointer";this.clickDiv&&(this.clickDiv.style.cursor="pointer")};this.setValue=function(a,b,c){this.div1&&(c!=TYPE_LED_RGB||"L"!=a.circuitsymbol&&"#"!=a.circuitsymbol&&"$"!=a.circuitsymbol?b!=this.prevvalue&&(b?(this.div0.style.visibility="hidden",this.div1.style.visibility="visible"):(this.div0.style.visibility="visible",this.div1.style.visibility="hidden")):(b=a.components[0].rgbcolor,b!=this.prevvalue&&(this.div0.style.color=rgb_led_fg_colors[b],this.div0.style.backgroundColor=
rgb_led_bg_colors[b])),this.prevvalue=b)};this.setLook=function(a,b){if(b==TYPE_TIMER_ON||b==TYPE_TIMER_OFF)a=b==TYPE_TIMER_ON,"R"!=this.div0.innerText&&a&&(this.div0.innerText="R"),"r"==this.div0.innerText||a||(this.div0.innerText="r"),"R"!=this.div1.innerText&&a&&(this.div1.innerText="R"),"r"==this.div1.innerText||a||(this.div1.innerText="r");if(b==TYPE_SWITCH_ON||b==TYPE_SWITCH_OFF)a=b==TYPE_SWITCH_ON,"S"!=this.div0.innerText&&a&&(this.div0.innerText="S"),"s"==this.div0.innerText||a||(this.div0.innerText=
"s"),"S"!=this.div1.innerText&&a&&(this.div1.innerText="S"),"s"==this.div1.innerText||a||(this.div1.innerText="s");if(b==TYPE_PUSHBUTTON_ON||b==TYPE_PUSHBUTTON_OFF)a=b==TYPE_PUSHBUTTON_ON,"P"!=this.div0.innerText&&a&&(this.div0.innerText="P"),"p"==this.div0.innerText||a||(this.div0.innerText="p"),"P"!=this.div1.innerText&&a&&(this.div1.innerText="P"),"p"==this.div1.innerText||a||(this.div1.innerText="p")};this.setTerminal=function(a,b){a!=this.prevchar&&(this.div1.innerText=a,b?(this.div1.innerText=
"",registerBlinkingCursor(this.div1)):void 0!=this.div1.style.animation&&(this.div1.style.animation=void 0))}}function hasDevice(a,b,c){a=getNeighbor(a,b,c);if(!a)return!1;a=world[a.y][a.x].circuitsymbol;return devicemap[a]||"#"==a||"$"==a}
function connected2g(a,b,c){if(!connected2(a,b,c))return!1;if(3<c)return!0;if(a=getNeighbor(a,b,c)){b=a.x;var d=a.y,f=world[d][b].circuitsymbol;a=-1;"&"==f&&(a=0==c?3:1==c?2:2==c?1:0);"%"==f&&(a=0==c?1:1==c?0:2==c?3:2);if(-1!=a&&!connected2(b,d,a))return!1;if(b=getNeighbor(b,d,a))if(c=b.x,b=b.y,d=world[b][c].circuitsymbol,f=-1,"&"==d&&(f=0==a?3:1==a?2:2==a?1:0),"%"==d&&(f=0==a?1:1==a?0:2==a?3:2),-1!=f&&!connected2(c,b,f))return!1}return!0}
function connected2b(a,b,c){var d=world[b][a].circuitsymbol;world[b][a].circuitsymbol="g";c=connected2(a,b,c);world[b][a].circuitsymbol=d;return c}function isInterestingComponent(a,b){return a.components[b]&&a.components[b].type!=TYPE_NULL&&a.components[b].type!=TYPE_LOOSE_WIRE_IMPLICIT&&a.components[b].type!=TYPE_UNKNOWN_DEVICE?!0:!1}
function sameDevice(a,b,c){var d=getNeighbor(a,b,c);if(!d)return!1;c=d.x;d=d.y;var f=world[b][a].circuitsymbol,e=world[d][c].circuitsymbol;return"M"==f&&"M"==e||"i"==f&&"i"==e||!("b"!=f&&"B"!=f||"b"!=e&&"B"!=e)?!0:ffmap[f]&&ffmap[e]?(a=world[b][a].components[0],b=world[d][c].components[0],a=a.master?a.master.ff:a.ff,b=b.master?b.master.ff:b.ff,!!a&&a==b):devicemap[f]&&devicemap[e]?!1:("#"!=f&&"$"!=f||!devicemap[e]&&"#"!=e&&"$"!=e)&&("#"!=e&&"$"!=e||!devicemap[f]&&"#"!=f&&"$"!=f)?!1:!0}
function RendererDrawer(){this.ty=this.tx=0;this.drawLineCore_=function(a,b,c,d,f){var e=Math.floor(b*tw),g=Math.floor(c*th),k=Math.floor(d*tw),m=Math.floor(f*th);if(USE_BRESENHAM)if(e==k)e==tw&&(e--,k--),a.moveTo(this.tx+e+.5,this.ty+g),a.lineTo(this.tx+k+.5,this.ty+m);else if(g==m)g==th&&(g--,m--),a.moveTo(this.tx+e,this.ty+g+.5),a.lineTo(this.tx+k,this.ty+m+.5);else{e=Math.floor(b*(tw-1));g=Math.floor(c*(th-1));k=Math.floor(d*(tw-1));m=Math.floor(f*(th-1));d-b==c-f&&b==1-c&&(e=Math.ceil(b*(tw-
1)),g=Math.floor(c*(th-1)),k=Math.ceil(d*(tw-1)),m=Math.floor(f*(th-1)));var q=Math.abs(k-e),l=Math.abs(m-g);f=d=c=b=0;q>=l?(c=k>=e?1:-1,d=m>=g?1:-1,k=q,m=l):(b=k>=e?1:-1,f=m>=g?1:-1,k=l,m=q);q=k>>1;l=k;for(var p=0;p<=l;p++)a.fillRect(this.tx+e,this.ty+g,1,1),q+=m,q>=k&&(q-=k,e+=b,g+=d),e+=c,g+=f}else e==k?(e==tw&&(e--,k--),a.moveTo(this.tx+e+.5,this.ty+g),a.lineTo(this.tx+k+.5,this.ty+m)):g==m?(g==th&&(g--,m--),a.moveTo(this.tx+e,this.ty+g+.5),a.lineTo(this.tx+k,this.ty+m+.5)):(Math.abs(d-b)==Math.abs(f-
c)&&Math.abs(k-e)!=Math.abs(m-g)&&(e=b*tw,g=c*th,k=d*tw,m=f*th),a.moveTo(this.tx+e,this.ty+g),a.lineTo(this.tx+k,this.ty+m))};this.drawLine_=function(a,b,c,d,f){a.beginPath();this.drawLineCore_(a,b,c,d,f);a.stroke()};this.drawArrowCore_=function(a,b,c,d,f,e){e=e||.3;this.drawLineCore_(a,b,c,d,f);c==f&&d>b?(this.drawLineCore_(a,d-e,f-e,d,f),this.drawLineCore_(a,d-e,f+e,d,f)):c==f?(this.drawLineCore_(a,d+e,f-e,d,f),this.drawLineCore_(a,d+e,f+e,d,f)):b==d&&f>c?(this.drawLineCore_(a,d-e,f-e,d,f),this.drawLineCore_(a,
d+e,f-e,d,f)):b==d?(this.drawLineCore_(a,d-e,f+e,d,f),this.drawLineCore_(a,d+e,f+e,d,f)):d>b&&f>c?(this.drawLineCore_(a,d-e,f,d,f),this.drawLineCore_(a,d,f-e,d,f)):d>b&&f<c?(this.drawLineCore_(a,d-e,f,d,f),this.drawLineCore_(a,d,f+e,d,f)):d<b&&f>c?(this.drawLineCore_(a,d+e,f,d,f),this.drawLineCore_(a,d,f-e,d,f)):(this.drawLineCore_(a,d+e,f,d,f),this.drawLineCore_(a,d,f+e,d,f))};this.drawArrow_=function(a,b,c,d,f,e){a.beginPath();this.drawArrowCore_(a,b,c,d,f,e);a.stroke()};this.drawAntiArrowCore_=
function(a,b,c,d,f,e){e=e||.25;var g=2*e,k=g-.1;c==f&&d>b?(this.drawCircleCore_(a,d-e,f,e),this.drawLineCore_(a,b,c,d-g,f)):c==f?(this.drawCircleCore_(a,d+e,f,e),this.drawLineCore_(a,b,c,d+g,f)):b==d&&f>c?(this.drawCircleCore_(a,d,f-e,e),this.drawLineCore_(a,b,c,d,f-g)):b==d?(this.drawCircleCore_(a,d,f+e,e),this.drawLineCore_(a,b,c,d,f+g)):d>b&&f>c?(this.drawCircleCore_(a,d-e,f-e,e),this.drawLineCore_(a,b,c,d-k,f-k)):d>b&&f<c?(this.drawCircleCore_(a,d-e,f+e,e),this.drawLineCore_(a,b,c,d-k,f+k)):d<
b&&f>c?(this.drawCircleCore_(a,d+e,f-e,e),this.drawLineCore_(a,b,c,d+k,f-k)):(this.drawCircleCore_(a,d+e,f+e,e),this.drawLineCore_(a,b,c,d+k,f+k))};this.drawAntiArrow_=function(a,b,c,d,f,e){a.beginPath();this.drawAntiArrowCore_(a,b,c,d,f,e);a.stroke()};this.drawCircleCore_=function(a,b,c,d){a.arc(this.tx+Math.floor(b*tw),this.ty+Math.floor(c*th),Math.floor(d*th),0,2*Math.PI,!0)};this.drawCircle_=function(a,b,c,d){a.beginPath();this.drawCircleCore_(a,b,c,d);a.stroke()};this.drawArc_=function(a,b,c,
d,f,e){b=Math.floor(b*tw);c=Math.floor(c*th);e=Math.floor(e*th);a.beginPath();a.arc(this.tx+b,this.ty+c,e,2*Math.PI*d,2*Math.PI*f,!1);a.stroke()};this.drawFilledCircle_=function(a,b,c,d){b=Math.floor(b*tw);c=Math.floor(c*th);d=Math.floor(d*th);a.beginPath();a.arc(this.tx+b,this.ty+c,d,0,2*Math.PI,!1);a.fill();a.stroke()};this.drawBGSplit_=function(a,b){var c=0;b.beginPath();connected2b(a.x,a.y,0)&&(c++,this.drawLineCore_(b,.5,0,.5,.5));connected2b(a.x,a.y,1)&&(c++,this.drawLineCore_(b,.5,.5,1,.5));
connected2b(a.x,a.y,2)&&(c++,this.drawLineCore_(b,.5,.5,.5,1));connected2b(a.x,a.y,3)&&(c++,this.drawLineCore_(b,0,.5,.5,.5));connected2b(a.x,a.y,4)&&(c++,this.drawLineCore_(b,.5,.5,1,0));connected2b(a.x,a.y,5)&&(c++,this.drawLineCore_(b,.5,.5,1,1));connected2b(a.x,a.y,6)&&(c++,this.drawLineCore_(b,.5,.5,0,1));connected2b(a.x,a.y,7)&&(c++,this.drawLineCore_(b,.5,.5,0,0));b.stroke();return c};this.drawSplit_=function(a,b,c){c=c||0;b.beginPath();connected2g(a.x,a.y,0)&&(c++,this.drawLineCore_(b,.5,
0,.5,.5));connected2g(a.x,a.y,1)&&(c++,this.drawLineCore_(b,.5,.5,1,.5));connected2g(a.x,a.y,2)&&(c++,this.drawLineCore_(b,.5,.5,.5,1));connected2g(a.x,a.y,3)&&(c++,this.drawLineCore_(b,0,.5,.5,.5));connected2g(a.x,a.y,4)&&(c++,this.drawLineCore_(b,.5,.5,1,0));connected2g(a.x,a.y,5)&&(c++,this.drawLineCore_(b,.5,.5,1,1));connected2g(a.x,a.y,6)&&(c++,this.drawLineCore_(b,.5,.5,0,1));connected2g(a.x,a.y,7)&&(c++,this.drawLineCore_(b,.5,.5,0,0));b.stroke();3<=c&&b.fillRect(this.tx+(tw>>1)-1.5,this.ty+
(th>>1)-1.5,3.5,3.5);return c};this.drawSplitDiag_=function(a,b,c){var d=0;c&&(d+=c);connected2g(a.x,a.y,4)&&(d++,this.drawLine_(b,.5,.5,1,0));connected2g(a.x,a.y,5)&&(d++,this.drawLine_(b,.5,.5,1,1));connected2g(a.x,a.y,6)&&(d++,this.drawLine_(b,.5,.5,0,1));connected2g(a.x,a.y,7)&&(d++,this.drawLine_(b,.5,.5,0,0));3<=d&&b.fillRect(this.tx+(tw>>1)-1.5,this.ty+(th>>1)-1.5,3.5,3.5);return d};this.drawSplit_h_=function(a,b,c){c=c||0;b.beginPath();connected2g(a.x,a.y,0)&&isInterestingComponent(a,1)&&
(c++,this.drawLineCore_(b,.5,0,.5,.5));connected2g(a.x,a.y,1)&&isInterestingComponent(a,0)&&(c++,this.drawLineCore_(b,.5,.5,1,.5));connected2g(a.x,a.y,2)&&isInterestingComponent(a,1)&&(c++,this.drawLineCore_(b,.5,.5,.5,1));connected2g(a.x,a.y,3)&&isInterestingComponent(a,0)&&(c++,this.drawLineCore_(b,0,.5,.5,.5));connected2g(a.x,a.y,4)&&isInterestingComponent(a,3)&&(c++,this.drawLineCore_(b,.5,.5,1,0));connected2g(a.x,a.y,5)&&isInterestingComponent(a,2)&&(c++,this.drawLineCore_(b,.5,.5,1,1));connected2g(a.x,
a.y,6)&&isInterestingComponent(a,3)&&(c++,this.drawLineCore_(b,.5,.5,0,1));connected2g(a.x,a.y,7)&&isInterestingComponent(a,2)&&(c++,this.drawLineCore_(b,.5,.5,0,0));b.stroke();3<=c&&b.fillRect(this.tx+(tw>>1)-1.5,this.ty+(th>>1)-1.5,3.5,3.5)};this.drawCrossing_=function(a,b){var c=0,d=0;if(connected2g(a.x,a.y,0)||connected2g(a.x,a.y,2))d|=1,c++;if(connected2g(a.x,a.y,1)||connected2g(a.x,a.y,3))d|=2,c++;if(connected2g(a.x,a.y,4)||connected2g(a.x,a.y,6))d|=4,c++;if(connected2g(a.x,a.y,5)||connected2g(a.x,
a.y,7))d|=8,c++;a=d&2?2:d&1?1:d&4?4:8;b.beginPath();if(d&1)if(1==a)this.drawLineCore_(b,.5,0,.5,1);else{var f=.2;this.drawLineCore_(b,.5,0,.5,.5-f+.1);this.drawLineCore_(b,.5,.5+f,.5,1)}d&2&&(2==a?this.drawLineCore_(b,0,.5,1,.5):(f=.2,this.drawLineCore_(b,0,.5,.5-f+.1,.5),this.drawLineCore_(b,.5+f,.5,1,.5)));d&4&&(4==a?this.drawLineCore_(b,0,1,1,0):(this.drawLineCore_(b,0,1,.4,.6),this.drawLineCore_(b,.6,.4,1,0)));d&8&&(8==a?this.drawLineCore_(b,0,0,1,1):(this.drawLineCore_(b,0,0,.4,.4),this.drawLineCore_(b,
.6,.6,1,1)));b.stroke();return[c,d]};this.drawCrossing2_=function(a,b,c,d,f){var e=b&2?2:b&1?1:b&4?4:8;var g=c&2?f:d;a.strokeStyle=g;a.fillStyle=g;a.beginPath();b&1&&(1==e?this.drawLineCore_(a,.5,0,.5,1):(g=.2,this.drawLineCore_(a,.5,0,.5,.5-g+.1),this.drawLineCore_(a,.5,.5+g,.5,1)));a.stroke();g=c&1?f:d;a.strokeStyle=g;a.fillStyle=g;a.beginPath();b&2&&(2==e?this.drawLineCore_(a,0,.5,1,.5):(g=.2,this.drawLineCore_(a,0,.5,.5-g+.1,.5),this.drawLineCore_(a,.5+g,.5,1,.5)));a.stroke();g=c&8?f:d;a.strokeStyle=
g;a.fillStyle=g;a.beginPath();b&4&&(4==e?this.drawLineCore_(a,0,1,1,0):(this.drawLineCore_(a,0,1,.4,.6),this.drawLineCore_(a,.6,.4,1,0)));a.stroke();g=c&4?f:d;a.strokeStyle=g;a.fillStyle=g;a.beginPath();b&8&&(8==e?this.drawLineCore_(a,0,0,1,1):(this.drawLineCore_(a,0,0,.4,.4),this.drawLineCore_(a,.6,.6,1,1)));a.stroke()};this.fillBg_=function(a,b){var c=a.fillStyle;a.fillStyle=b;a.fillRect(this.tx,this.ty,tw,th);c!=b&&(a.fillStyle=c)};this.doDrawPlusDiagSplit_=function(a,b){var c=!1,d=!1,f=!1,e=!1;
b.beginPath();a&2&&(this.drawLineCore_(b,.5,0,1,0),c=!0);a&4&&(this.drawLineCore_(b,1,.5,1,0),d=!0);a&16&&(this.drawLineCore_(b,.5,1,1,1),f=!0);a&8&&(this.drawLineCore_(b,1,.5,1,1),d=!0);a&32&&(this.drawLineCore_(b,0,1,.5,1),f=!0);a&64&&(this.drawLineCore_(b,0,.5,0,1),e=!0);a&1&&(this.drawLineCore_(b,0,0,.5,0),c=!0);a&128&&(this.drawLineCore_(b,0,.5,0,0),e=!0);b.stroke();c&&b.fillRect(this.tx+(tw>>1)-1.5,this.ty+0,3.5,3.5);d&&b.fillRect(this.tx+tw-4,this.ty+(th>>1)-1.5,3.5,3.5);f&&b.fillRect(this.tx+
(tw>>1)-1.5,this.ty+th-4,3.5,3.5);e&&b.fillRect(this.tx+0,this.ty+(th>>1)-1.5,3.5,3.5)};this.drawPlusDiagSplit_=function(a,b){var c=0;if((n=getNeighbor(a.x,a.y,4))&&2==n.circuitextra){var d=n.circuitsymbol;if("^"==d||"m"==d)c|=2;if(">"==d||"]"==d)c|=4}if((n=getNeighbor(a.x,a.y,5))&&2==n.circuitextra){d=n.circuitsymbol;if("v"==d||"w"==d)c|=16;if(">"==d||"]"==d)c|=8}if((n=getNeighbor(a.x,a.y,6))&&2==n.circuitextra){d=n.circuitsymbol;if("v"==d||"w"==d)c|=32;if("<"==d||"["==d)c|=64}if((n=getNeighbor(a.x,
a.y,7))&&2==n.circuitextra){d=n.circuitsymbol;if("^"==d||"m"==d)c|=1;if("<"==d||"["==d)c|=128}this.doDrawPlusDiagSplit_(c,b);return c}}
function MultiCanvas(){this.MAX_S=USE_BRESENHAM?4096:255;this.S=0;this.contexts=this.canvases=null;this.h=this.w=0;this.make=function(a,b,c,d,f){this.S=Math.floor(this.MAX_S/tw)*tw;this.w=c;this.h=d;var e=Math.ceil(c/this.S),g=Math.ceil(d/this.S);this.canvases=[];this.contexts=[];for(var k=0;k<g;k++){this.canvases[k]=[];this.contexts[k]=[];for(var m=0;m<e;m++){var q=Math.min(this.S,d-k*this.S),l=Math.min(this.S,c-m*this.S);this.canvases[k][m]=makeAbsElement("canvas",a+m*this.S,b+k*this.S,l,q,f);this.canvases[k][m].width=
l;this.canvases[k][m].height=q;this.canvases[k][m].style.display="block";this.contexts[k][m]=this.canvases[k][m].getContext("2d")}}};this.remove=function(){if(this.canvases){for(var a=0;a<this.canvases.length;a++)for(var b=0;b<this.canvases[a].length;b++)removeElement(this.canvases[a][b]);this.contexts=this.canvases=null}};this.getCanvasAt=function(a,b){return this.canvases[Math.floor(b/this.S)][Math.floor(a/this.S)]};this.getCanvasForCell=function(a){return this.getCanvasAt(a.x*tw,a.y*th)};this.getContextAt=
function(a,b){return this.contexts[Math.floor(b/this.S)][Math.floor(a/this.S)]};this.getContextForCell=function(a){return this.getContextAt(a.x*tw,a.y*th)};this.getXOffsetAt=function(a){return-Math.floor(a/this.S)*this.S|0};this.getYOffsetAt=function(a){return-Math.floor(a/this.S)*this.S|0};this.getXOffsetForCell=function(a){return this.getXOffsetAt(a.x*tw)};this.getYOffsetForCell=function(a){return this.getYOffsetAt(a.y*th)};this.forEach=function(a){for(var b=0;b<this.canvases.length;b++)for(var c=
0;c<this.canvases[b].length;c++)a(this.canvases[b][c],this.contexts[b][c])}}
function RendererImgGlobal(){this.maincanvas=new MultiCanvas;this.offcanvas0=new MultiCanvas;this.offcanvas1=new MultiCanvas;this.extracanvas=new MultiCanvas;this.init=function(){var a=worldDiv;this.maincanvas.remove();this.offcanvas0.remove();this.offcanvas1.remove();this.extracanvas.remove();this.maincanvas.make(0,0,tw*w,th*h,a);this.offcanvas0.make(0,0,tw*w,th*h,a);this.offcanvas1.make(0,0,tw*w,th*h,a);this.extracanvas.make(0,0,128*tw,4*th,a);this.offcanvas0.forEach(function(a,c){a.style.display=
"none"});this.offcanvas1.forEach(function(a,c){a.style.display="none"});this.extracanvas.forEach(function(a,c){a.style.display="none"});this.maincanvas.forEach(function(a,c){c.imageSmoothingEnabled=!1});this.offcanvas0.forEach(function(a,c){c.imageSmoothingEnabled=!1});this.offcanvas1.forEach(function(a,c){c.imageSmoothingEnabled=!1});this.extracanvas.forEach(function(a,c){c.imageSmoothingEnabled=!1})}}
function hasRealComponent(a){for(var b=0;b<a.components.length;b++)if(a.components[b]){var c=a.components[b].type;if(c!=TYPE_NULL&&c!=TYPE_LOOSE_WIRE_IMPLICIT)return!0}return!1}var rglobal=new RendererImgGlobal,NOUSETEXTMAP={"-":!0,"|":!0,"*":!0,"+":!0,x:!0,X:!0,">":!0,v:!0,"<":!0,"^":!0,"]":!0,w:!0,"[":!0,m:!0,U:!0,G:!0,V:!0,W:!0},drawer=new RendererDrawer;
function RendererImg(){this.fallback=new RendererText;this.prevvalue=this.ctx1=this.ctx0=this.canvas1=this.canvas0=null;this.usefallbackonly=!1;this.usetext=!0;this.init2done=!1;this.text1=this.text0=null;this.ty=this.tx=0;this.drawextra=!1;this.drawonly=this.drawextrag=this.drawextrai1=this.drawextrai0=0;this.dynamicdraw=!1;this.dynamicdrawcode=0;this.globalInit=function(){this.fallback.globalInit();rglobal.init();this.drawGlobalExtras_()};this.cleanup=function(){this.text0&&(removeElement(this.text0),
removeElement(this.text1));this.fallback.cleanup()};this.init=function(a,b,c,d){NOUSETEXTMAP[a.circuitsymbol]&&(this.usetext=!1);this.usetext&&this.fallback.init(a,b,c,d);this.tx=tw*a.x+rglobal.offcanvas0.getXOffsetForCell(a);this.ty=th*a.y+rglobal.offcanvas0.getYOffsetForCell(a);a.comment||" "==a.circuitsymbol||(this.canvas0=rglobal.offcanvas0.getCanvasForCell(a),this.canvas1=rglobal.offcanvas1.getCanvasForCell(a),this.ctx0=rglobal.offcanvas0.getContextForCell(a),this.ctx1=rglobal.offcanvas1.getContextForCell(a),
this.usetext?(this.text0=this.fallback.div0,this.text1=this.fallback.div1):(this.text0=makeDiv(b*tw,c*th,tw,th,worldDiv),this.text0.onmousedown=d))};this.init2=function(a,b,c,d){if(this.canvas0){drawer.tx=this.tx;drawer.ty=this.ty;this.init2done&&(this.ctx0.clearRect(0,0,tw,th),this.ctx1.clearRect(0,0,tw,th));this.init2done=!0;drawer.fillBg_(this.ctx0,BGCOLOR);drawer.fillBg_(this.ctx1,BGCOLOR);var f=tw-2;7>f&&(f=7);this.text0.style.color=OFFCOLOR;this.text0.style.textAlign="center";this.text0.style.fontSize=
f+"px";this.text0.style.fontFamily="monospace";this.text0.style.zIndex=MAINZINDEX;this.text1&&(this.text1.style.color=ONCOLOR,this.text1.style.textAlign="center",this.text1.style.fontSize=f+"px",this.text1.style.fontFamily="monospace",this.text1.style.zIndex=MAINZINDEX);this.ctx0.strokeStyle=OFFCOLOR;this.ctx1.strokeStyle=ONCOLOR;this.ctx0.fillStyle=OFFCOLOR;this.ctx1.fillStyle=ONCOLOR;this.ctx0.lineWidth=1;this.ctx1.lineWidth=1;f=!1;a.components[0]&&a.components[0].error?(f=!0,this.markError(a,a.getErrorText()),
drawer.fillBg_(this.ctx0,"yellow"),drawer.fillBg_(this.ctx1,"yellow")):d&&(this.text0.title=d,this.text1&&(this.text1.title=d));d=a.circuitsymbol;for(var e=0;2>e;e++){var g=0==e?this.ctx0:this.ctx1,k=0==e?this.text0:this.text1;if(1==e&&a.components[0]){var m=a.components[0].type;if(m==TYPE_FLIPFLOP||m==TYPE_IC||m==TYPE_IC_PASSTHROUGH||m==TYPE_ROM||m==TYPE_MUX)if(devicemap[d]||"#"==d||"$"==d)g.strokeStyle=OFFCOLOR,g.fillStyle=OFFCOLOR}if("-"==d)drawer.drawLine_(g,0,.5,1,.5),drawer.drawSplitDiag_(a,
g,2);else if("|"==d)drawer.drawLine_(g,.5,0,.5,1),drawer.drawSplitDiag_(a,g,2);else if("/"==d)drawer.drawLine_(g,0,1,1,0);else if("\\"==d)drawer.drawLine_(g,0,0,1,1);else if("x"==d)this.drawextra=isInterestingComponent(a,0)&&isInterestingComponent(a,1),isInterestingComponent(a,1)&&!isInterestingComponent(a,0)&&drawer.drawLine_(g,0,0,1,1),isInterestingComponent(a,1)&&(drawer.drawLine_(g,0,0,.4,.4),drawer.drawLine_(g,.6,.6,1,1)),isInterestingComponent(a,0)&&drawer.drawLine_(g,0,1,1,0);else if("+"==
d)k=drawer.drawPlusDiagSplit_(a,g),drawer.drawLine_(g,0,.5,1,.5),drawer.drawLine_(g,.5,0,.5,.4),drawer.drawLine_(g,.5,.7,.5,1),0==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=0),1==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=24),2==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=25),4==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=26),8==k&&(this.drawextra=!0,this.drawextrai0=2,
this.drawextrai1=1,this.drawextrag=27),16==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=28),32==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=29),64==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=30),128==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=31);else if("*"==d||","==d)drawer.drawSplit_(a,g);else if("^"==d)2==a.circuitextra?(k=0,hasDevice(a.x,a.y,7)&&(drawer.drawArrow_(g,
1,1,0,0),k++),hasDevice(a.x,a.y,4)&&(drawer.drawArrow_(g,0,1,1,0),k++),2==k&&(this.drawextra=!0)):(drawer.drawSplit_(a,g,1),drawer.drawArrow_(g,.5,.5,.5,0));else if(">"==d)2==a.circuitextra&&hasRealComponent(a)?(k=0,hasDevice(a.x,a.y,4)&&(drawer.drawArrow_(g,0,1,1,0),k++),hasDevice(a.x,a.y,5)&&(drawer.drawArrow_(g,0,0,1,1),k++),2==k&&(this.drawextra=!0)):(drawer.drawSplit_(a,g,1),drawer.drawArrow_(g,.5,.5,1,.5));else if("v"==d)2==a.circuitextra&&hasRealComponent(a)?(k=0,hasDevice(a.x,a.y,6)&&(drawer.drawArrow_(g,
1,0,0,1),k++),hasDevice(a.x,a.y,5)&&(drawer.drawArrow_(g,0,0,1,1),k++),2==k&&(this.drawextra=!0)):(drawer.drawSplit_(a,g,1),drawer.drawArrow_(g,.5,.5,.5,1));else if("<"==d)2==a.circuitextra&&hasRealComponent(a)?(k=0,hasDevice(a.x,a.y,7)&&(drawer.drawArrow_(g,1,1,0,0),k++),hasDevice(a.x,a.y,6)&&(drawer.drawArrow_(g,1,0,0,1),k++),2==k&&(this.drawextra=!0)):(drawer.drawSplit_(a,g,1),drawer.drawArrow_(g,.5,.5,0,.5));else if("m"==d)2==a.circuitextra&&hasRealComponent(a)?(k=0,hasDevice(a.x,a.y,7)&&(drawer.drawAntiArrow_(g,
1,1,0,0),k++),hasDevice(a.x,a.y,4)&&(drawer.drawAntiArrow_(g,0,1,1,0),k++),2==k&&(this.drawextra=!0)):(drawer.drawSplit_(a,g,1),drawer.drawAntiArrow_(g,.5,.5,.5,0));else if("]"==d)2==a.circuitextra&&hasRealComponent(a)?(k=0,hasDevice(a.x,a.y,4)&&(drawer.drawAntiArrow_(g,0,1,1,0),k++),hasDevice(a.x,a.y,5)&&(drawer.drawAntiArrow_(g,0,0,1,1),k++),2==k&&(this.drawextra=!0)):(drawer.drawSplit_(a,g,1),drawer.drawAntiArrow_(g,.5,.5,1,.5));else if("w"==d)2==a.circuitextra&&hasRealComponent(a)?(k=0,hasDevice(a.x,
a.y,6)&&(drawer.drawAntiArrow_(g,1,0,0,1),k++),hasDevice(a.x,a.y,5)&&(drawer.drawAntiArrow_(g,0,0,1,1),k++),2==k&&(this.drawextra=!0)):(drawer.drawSplit_(a,g,1),drawer.drawAntiArrow_(g,.5,.5,.5,1));else if("["==d)2==a.circuitextra&&hasRealComponent(a)?(k=0,hasDevice(a.x,a.y,7)&&(drawer.drawAntiArrow_(g,1,1,0,0),k++),hasDevice(a.x,a.y,6)&&(drawer.drawAntiArrow_(g,1,0,0,1),k++),2==k&&(this.drawextra=!0)):(drawer.drawSplit_(a,g,1),drawer.drawAntiArrow_(g,.5,.5,0,.5));else if("U"==d)k=0,hasDevice(a.x,
a.y,0)&&(k++,drawer.drawArrow_(g,.5,.5,.5,0,.19)),hasDevice(a.x,a.y,1)&&(k++,drawer.drawArrow_(g,.5,.5,1,.5,.19)),hasDevice(a.x,a.y,2)&&(k++,drawer.drawArrow_(g,.5,.5,.5,1,.19)),hasDevice(a.x,a.y,3)&&(k++,drawer.drawArrow_(g,.5,.5,0,.5,.19)),drawer.drawSplit_(a,g,k);else if("G"==d)k=0,hasDevice(a.x,a.y,0)&&(k++,drawer.drawAntiArrow_(g,.5,.5,.5,0)),hasDevice(a.x,a.y,1)&&(k++,drawer.drawAntiArrow_(g,.5,.5,1,.5)),hasDevice(a.x,a.y,2)&&(k++,drawer.drawAntiArrow_(g,.5,.5,.5,1)),hasDevice(a.x,a.y,3)&&(k++,
drawer.drawAntiArrow_(g,.5,.5,0,.5)),drawer.drawSplit_(a,g,k);else if("V"==d)drawer.drawSplit_h_(a,g,-8),k=0,hasDevice(a.x,a.y,0)&&isInterestingComponent(a,1)&&(drawer.drawArrow_(g,.5,.5,.5,0,.19),k|=1),hasDevice(a.x,a.y,1)&&isInterestingComponent(a,0)&&(drawer.drawArrow_(g,.5,.5,1,.5,.19),k|=2),hasDevice(a.x,a.y,2)&&isInterestingComponent(a,1)&&(drawer.drawArrow_(g,.5,.5,.5,1,.19),k|=4),hasDevice(a.x,a.y,3)&&isInterestingComponent(a,0)&&(drawer.drawArrow_(g,.5,.5,0,.5,.19),k|=8),hasDevice(a.x,a.y,
4)&&isInterestingComponent(a,3)&&(drawer.drawArrow_(g,.5,.5,1,0),k|=16),hasDevice(a.x,a.y,5)&&isInterestingComponent(a,2)&&(drawer.drawArrow_(g,.5,.5,1,1),k|=32),hasDevice(a.x,a.y,6)&&isInterestingComponent(a,3)&&(drawer.drawArrow_(g,.5,.5,0,1),k|=64),hasDevice(a.x,a.y,7)&&isInterestingComponent(a,2)&&(drawer.drawArrow_(g,.5,.5,0,0),k|=128),1==k&&(this.drawextra=!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=32),2==k&&(this.drawextra=!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=
33),4==k&&(this.drawextra=!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=34),8==k&&(this.drawextra=!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=35),144==k&&(this.drawextra=!0,this.drawextrai0=8,this.drawextrai1=4,this.drawextrag=2),48==k&&(this.drawextra=!0,this.drawextrai0=4,this.drawextrai1=8,this.drawextrag=3),96==k&&(this.drawextra=!0,this.drawextrai0=4,this.drawextrai1=8,this.drawextrag=4),192==k&&(this.drawextra=!0,this.drawextrai0=8,this.drawextrai1=4,this.drawextrag=
5),3==k&&(this.drawextra=!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=16),6==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=17),12==k&&(this.drawextra=!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=18),9==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=19);else if("W"==d)drawer.drawSplit_h_(a,g,-8),k=0,hasDevice(a.x,a.y,0)&&(drawer.drawAntiArrow_(g,.5,.5,.5,0),k|=1),hasDevice(a.x,a.y,1)&&(drawer.drawAntiArrow_(g,.5,.5,
1,.5),k|=2),hasDevice(a.x,a.y,2)&&(drawer.drawAntiArrow_(g,.5,.5,.5,1),k|=4),hasDevice(a.x,a.y,3)&&(drawer.drawAntiArrow_(g,.5,.5,0,.5),k|=8),hasDevice(a.x,a.y,4)&&(drawer.drawAntiArrow_(g,.5,.5,1,0),k|=16),hasDevice(a.x,a.y,5)&&(drawer.drawAntiArrow_(g,.5,.5,1,1),k|=32),hasDevice(a.x,a.y,6)&&(drawer.drawAntiArrow_(g,.5,.5,0,1),k|=64),hasDevice(a.x,a.y,7)&&(drawer.drawAntiArrow_(g,.5,.5,0,0),k|=128),1==k&&(this.drawextra=!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=36),2==k&&(this.drawextra=
!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=37),4==k&&(this.drawextra=!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=38),8==k&&(this.drawextra=!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=39),144==k&&(this.drawextra=!0,this.drawextrai0=8,this.drawextrai1=4,this.drawextrag=6),48==k&&(this.drawextra=!0,this.drawextrai0=4,this.drawextrai1=8,this.drawextrag=7),96==k&&(this.drawextra=!0,this.drawextrai0=4,this.drawextrag=this.drawextrai1=8),192==k&&(this.drawextra=!0,
this.drawextrai0=8,this.drawextrai1=4,this.drawextrag=9),3==k&&(this.drawextra=!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=20),6==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=21),12==k&&(this.drawextra=!0,this.drawextrai0=1,this.drawextrai1=2,this.drawextrag=22),9==k&&(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=23);else if("X"==d)k=drawer.drawCrossing_(a,g)[1],3==k?(this.drawextra=!0,this.drawextrai0=2,this.drawextrai1=1,this.drawextrag=
0):12==k?(this.drawextra=!0,this.drawextrai0=8,this.drawextrai1=4,this.drawextrag=1):6==k?(this.drawextra=!0,this.drawextrai0=8,this.drawextrai1=1,this.drawextrag=12):10==k?(this.drawextra=!0,this.drawextrai0=4,this.drawextrai1=1,this.drawextrag=13):5==k?(this.drawextra=!0,this.drawextrai0=8,this.drawextrai1=2,this.drawextrag=14):9==k?(this.drawextra=!0,this.drawextrai0=4,this.drawextrai1=2,this.drawextrag=15):(this.dynamicdraw=!0,this.dynamicdrawcode=k);else if("&"==d)k=connected2g(a.x,a.y,0)&&connected2g(a.x,
a.y,1)&&isInterestingComponent(a,1),(m=connected2g(a.x,a.y,2)&&connected2g(a.x,a.y,3)&&isInterestingComponent(a,0))&&k?(k=.3,drawer.drawLine_(g,0,.5,k,.5),drawer.drawLine_(g,.5,1,.5,1-k),drawer.drawLine_(g,k,.5,.5,1-k),drawer.drawLine_(g,1,.5,1-k,.5),drawer.drawLine_(g,.5,0,.5,k),drawer.drawLine_(g,1-k,.5,.5,k),this.drawextra=!0):m?(drawer.drawLine_(g,.5,.5,0,.5),drawer.drawLine_(g,.5,.5,.5,1),this.drawonly=1):k&&(drawer.drawLine_(g,.5,.5,1,.5),drawer.drawLine_(g,.5,.5,.5,0),this.drawonly=2);else if("%"==
d)k=connected2g(a.x,a.y,0)&&connected2g(a.x,a.y,3)&&isInterestingComponent(a,1),(m=connected2g(a.x,a.y,1)&&connected2g(a.x,a.y,2)&&isInterestingComponent(a,0))&&k?(k=.3,drawer.drawLine_(g,0,.5,k,.5),drawer.drawLine_(g,.5,0,.5,k),drawer.drawLine_(g,k,.5,.5,k),drawer.drawLine_(g,1,.5,1-k,.5),drawer.drawLine_(g,.5,1,.5,1-k),drawer.drawLine_(g,1-k,.5,.5,1-k),this.drawextra=!0):m?(drawer.drawLine_(g,.5,.5,1,.5),drawer.drawLine_(g,.5,.5,.5,1),this.drawonly=1):k&&(drawer.drawLine_(g,.5,.5,0,.5),drawer.drawLine_(g,
.5,.5,.5,0),this.drawonly=2);else if(antennamap[d])drawer.drawBGSplit_(a,g),")"==d?(drawer.drawArc_(g,.5,.5,.75,.25,.4),drawer.drawFilledCircle_(g,.5,.5,.3)):"("==d?(drawer.drawArc_(g,.5,.5,.25,.75,.4),drawer.drawFilledCircle_(g,.5,.5,.3)):"u"==d?(drawer.drawArc_(g,.5,.5,0,.5,.4),drawer.drawFilledCircle_(g,.5,.5,.3)):"n"==d&&(drawer.drawArc_(g,.5,.5,.5,0,.4),drawer.drawFilledCircle_(g,.5,.5,.3));else if("="==d)(k=a.bus)&&drawer.fillBg_(g,BUSCOLORS[k.index&7]),digitmap[b]&&(g.textAlign="center",g.textBaseline=
"middle",g.font=""+tw+"px serif",this.ctx0.strokeStyle=this.ctx0.fillStyle=BGCOLOR,g.fillText(b,drawer.tx+(tw>>1),drawer.ty+(th>>1)));else if("T"==d){this.fallback.init2(a,b,c);this.usefallbackonly=!0;break}else if("L"==c){this.fallback.init2(a,b,c);this.usefallbackonly=!0;break}else if("g"==c)drawer.drawBGSplit_(a,g),drawer.drawFilledCircle_(g,.5,.5,.4);else if(a.comment){this.fallback.init2(a,b,c);this.usefallbackonly=!0;break}else if("toc"==d){this.fallback.init2(a,b,c);this.usefallbackonly=!0;
break}else{m=f;if(!f){if("s"==c||"S"==c||"p"==c||"P"==c||"r"==c||"R"==c)m=!0,drawer.fillBg_(g,0==e?SWITCHOFF_BGCOLOR:SWITCHON_BGCOLOR),this.ctx0.strokeStyle=this.ctx0.fillStyle=SWITCHOFF_BORDERCOLOR,this.ctx1.strokeStyle=this.ctx1.fillStyle=SWITCHON_BORDERCOLOR,this.text0.style.color=SWITCHOFF_FGCOLOR,this.text1.style.color=SWITCHON_FGCOLOR;if("l"==c){m=!0;var q=a.components[0]?a.components[0].number:0;-1==q&&(q=0);q>led_off_fg_colors.length&&(q=0);drawer.fillBg_(g,0==e?led_off_bg_colors[q]:led_on_bg_colors[q]);
this.ctx0.strokeStyle=this.ctx0.fillStyle=led_off_border_colors[q];this.ctx1.strokeStyle=this.ctx1.fillStyle=led_on_border_colors[q];this.text0.style.color=led_off_fg_colors[q];this.text1.style.color=led_on_fg_colors[q]}"B"==c&&(m=!0,drawer.fillBg_(g,k.style.color),k.style.color=BGCOLOR)}if(devicemap[d]||"#"==d||"$"==d)m||drawer.fillBg_(g,GATEBGCOLOR),"$"==d?(sameDevice(a.x,a.y,0)||(m=(m=getNeighbor(a.x,a.y,0))?m.circuitsymbol:"","$"!=d||"^"!=m&&"v"!=m&&"m"!=m&&"w"!=m&&"|"!=m&&"+"!=m?drawer.drawLine_(g,
0,0,1,0):(drawer.drawLine_(g,0,0,.5,.25),drawer.drawLine_(g,.5,.25,1,0))),sameDevice(a.x,a.y,1)||(m=(m=getNeighbor(a.x,a.y,1))?m.circuitsymbol:"","$"!=d||">"!=m&&"<"!=m&&"]"!=m&&"["!=m&&"-"!=m&&"+"!=m?drawer.drawLine_(g,1,0,1,1):(drawer.drawLine_(g,1,0,.75,.5),drawer.drawLine_(g,.75,.5,1,1))),sameDevice(a.x,a.y,2)||(m=(m=getNeighbor(a.x,a.y,2))?m.circuitsymbol:"","$"!=d||"^"!=m&&"v"!=m&&"m"!=m&&"w"!=m&&"|"!=m&&"+"!=m?drawer.drawLine_(g,1,1,0,1):(drawer.drawLine_(g,0,1,.5,.75),drawer.drawLine_(g,.5,
.75,1,1))),sameDevice(a.x,a.y,3)||(m=(m=getNeighbor(a.x,a.y,3))?m.circuitsymbol:"","$"!=d||">"!=m&&"<"!=m&&"]"!=m&&"["!=m&&"-"!=m&&"+"!=m?drawer.drawLine_(g,0,1,0,0):(drawer.drawLine_(g,0,0,.25,.5),drawer.drawLine_(g,.25,.5,0,1)))):(sameDevice(a.x,a.y,0)||drawer.drawLine_(g,0,0,1,0),sameDevice(a.x,a.y,1)||drawer.drawLine_(g,1,0,1,1),sameDevice(a.x,a.y,2)||drawer.drawLine_(g,1,1,0,1),sameDevice(a.x,a.y,3)||drawer.drawLine_(g,0,1,0,0));g=!0;if("#"==d||"$"==d)g=!1;"i"!=d||a.drawchip||digitmap[a.metasymbol]||
(g=!1);g&&(k.innerText=b)}}this.prevvalue=-1}else this.usefallbackonly=!0,this.fallback.init2(a,b,c,d)};this.drawGlobalExtras_=function(){var a=new RendererDrawer;rglobal.extracanvas.forEach(function(a,b){b.strokeStyle=BGCOLOR;b.fillStyle=BGCOLOR;b.fillRect(0,0,a.width,a.height)});for(var b,c=function(c,d){c=c*tw*2;d=d*th*2;b=rglobal.extracanvas.getContextAt(c,d);a.tx=c+rglobal.extracanvas.getXOffsetAt(c);a.ty=d+rglobal.extracanvas.getYOffsetAt(d)},d=0;2>d;d++){if(0==d){var f=OFFCOLOR;var e=ONCOLOR}else f=
ONCOLOR,e=OFFCOLOR;var g=0==d?0:1;c(0,g);var k=.2;b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,1,.5);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,.5,0,.5,.5-k+.1);a.drawLine_(b,.5,.5+k,.5,1);c(1,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,0,.4,.4);a.drawLine_(b,.6,.6,1,1);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,0,1,1,0);c(2,g);b.strokeStyle=b.fillStyle=f;a.drawArrow_(b,1,1,0,0);b.strokeStyle=b.fillStyle=e;a.drawArrow_(b,0,1,1,0);c(3,g);b.strokeStyle=b.fillStyle=f;a.drawArrow_(b,0,1,1,0);b.strokeStyle=
b.fillStyle=e;a.drawArrow_(b,0,0,1,1);c(4,g);b.strokeStyle=b.fillStyle=f;a.drawArrow_(b,1,0,0,1);b.strokeStyle=b.fillStyle=e;a.drawArrow_(b,0,0,1,1);c(5,g);b.strokeStyle=b.fillStyle=f;a.drawArrow_(b,1,1,0,0);b.strokeStyle=b.fillStyle=e;a.drawArrow_(b,1,0,0,1);c(6,g);b.strokeStyle=b.fillStyle=f;a.drawAntiArrow_(b,1,1,0,0);b.strokeStyle=b.fillStyle=e;a.drawAntiArrow_(b,0,1,1,0);c(7,g);b.strokeStyle=b.fillStyle=f;a.drawAntiArrow_(b,0,1,1,0);b.strokeStyle=b.fillStyle=e;a.drawAntiArrow_(b,0,0,1,1);c(8,
g);b.strokeStyle=b.fillStyle=f;a.drawAntiArrow_(b,1,0,0,1);b.strokeStyle=b.fillStyle=e;a.drawAntiArrow_(b,0,0,1,1);c(9,g);b.strokeStyle=b.fillStyle=f;a.drawAntiArrow_(b,1,1,0,0);b.strokeStyle=b.fillStyle=e;a.drawAntiArrow_(b,1,0,0,1);c(10,g);k=.3;b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,k,.5);a.drawLine_(b,.5,1,.5,1-k);a.drawLine_(b,k,.5,.5,1-k);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,1,.5,1-k,.5);a.drawLine_(b,.5,0,.5,k);a.drawLine_(b,1-k,.5,.5,k);c(11,g);k=.3;b.strokeStyle=b.fillStyle=f;
a.drawLine_(b,0,.5,k,.5);a.drawLine_(b,.5,0,.5,k);a.drawLine_(b,k,.5,.5,k);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,1,.5,1-k,.5);a.drawLine_(b,.5,1,.5,1-k);a.drawLine_(b,1-k,.5,.5,1-k);c(12,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,1,.5);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,0,1,.4,.6);a.drawLine_(b,.6,.4,1,0);c(13,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,1,.5);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,0,0,.4,.4);a.drawLine_(b,.6,.6,1,1);c(14,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,
.5,0,.5,1);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,0,1,.4,.6);a.drawLine_(b,.6,.4,1,0);c(15,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,.5,0,.5,1);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,0,0,.4,.4);a.drawLine_(b,.6,.6,1,1);c(16,g);b.strokeStyle=b.fillStyle=f;a.drawArrow_(b,.5,1,.5,0,.19);b.strokeStyle=b.fillStyle=e;a.drawArrow_(b,0,.5,1,.5,.19);c(17,g);b.strokeStyle=b.fillStyle=f;a.drawArrow_(b,0,.5,1,.5,.19);b.strokeStyle=b.fillStyle=e;a.drawArrow_(b,.5,0,.5,1,.19);c(18,g);b.strokeStyle=b.fillStyle=
f;a.drawArrow_(b,.5,0,.5,1,.19);b.strokeStyle=b.fillStyle=e;a.drawArrow_(b,1,.5,0,.5,.19);c(19,g);b.strokeStyle=b.fillStyle=f;a.drawArrow_(b,1,.5,0,.5,.19);b.strokeStyle=b.fillStyle=e;a.drawArrow_(b,.5,1,.5,0,.19);c(20,g);b.strokeStyle=b.fillStyle=f;a.drawAntiArrow_(b,.5,1,.5,0);b.strokeStyle=b.fillStyle=e;a.drawAntiArrow_(b,0,.5,1,.5);c(21,g);b.strokeStyle=b.fillStyle=f;a.drawAntiArrow_(b,0,.5,1,.5);b.strokeStyle=b.fillStyle=e;a.drawAntiArrow_(b,.5,0,.5,1);c(22,g);b.strokeStyle=b.fillStyle=f;a.drawAntiArrow_(b,
.5,0,.5,1);b.strokeStyle=b.fillStyle=e;a.drawAntiArrow_(b,1,.5,0,.5);c(23,g);b.strokeStyle=b.fillStyle=f;a.drawAntiArrow_(b,1,.5,0,.5);b.strokeStyle=b.fillStyle=e;a.drawAntiArrow_(b,.5,1,.5,0);k=.2;c(24,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,1,.5);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,.5,0,.5,.5-k+.1);a.drawLine_(b,.5,.5+k,.5,1);a.doDrawPlusDiagSplit_(1,b);c(25,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,1,.5);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,.5,0,.5,.5-k+.1);a.drawLine_(b,
.5,.5+k,.5,1);a.doDrawPlusDiagSplit_(2,b);c(26,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,1,.5);a.doDrawPlusDiagSplit_(4,b);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,.5,0,.5,.5-k+.1);a.drawLine_(b,.5,.5+k,.5,1);c(27,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,1,.5);a.doDrawPlusDiagSplit_(8,b);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,.5,0,.5,.5-k+.1);a.drawLine_(b,.5,.5+k,.5,1);c(28,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,1,.5);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,.5,0,
.5,.5-k+.1);a.drawLine_(b,.5,.5+k,.5,1);a.doDrawPlusDiagSplit_(16,b);c(29,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,1,.5);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,.5,0,.5,.5-k+.1);a.drawLine_(b,.5,.5+k,.5,1);a.doDrawPlusDiagSplit_(32,b);c(30,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,1,.5);a.doDrawPlusDiagSplit_(64,b);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,.5,0,.5,.5-k+.1);a.drawLine_(b,.5,.5+k,.5,1);c(31,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,0,.5,1,.5);a.doDrawPlusDiagSplit_(128,
b);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,.5,0,.5,.5-k+.1);a.drawLine_(b,.5,.5+k,.5,1);c(32,g);b.strokeStyle=b.fillStyle=f;a.drawArrow_(b,.5,1,.5,0,.19);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,0,.5,1,.5);c(33,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,.5,1,.5,0);b.strokeStyle=b.fillStyle=e;a.drawArrow_(b,0,.5,1,.5,.19);c(34,g);b.strokeStyle=b.fillStyle=f;a.drawArrow_(b,.5,0,.5,1,.19);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,0,.5,1,.5);c(35,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,.5,1,
.5,0);b.strokeStyle=b.fillStyle=e;a.drawArrow_(b,1,.5,0,.5,.19);c(36,g);b.strokeStyle=b.fillStyle=f;a.drawAntiArrow_(b,.5,1,.5,0);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,0,.5,1,.5);c(37,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,.5,1,.5,0);b.strokeStyle=b.fillStyle=e;a.drawAntiArrow_(b,0,.5,1,.5);c(38,g);b.strokeStyle=b.fillStyle=f;a.drawAntiArrow_(b,.5,0,.5,1);b.strokeStyle=b.fillStyle=e;a.drawLine_(b,0,.5,1,.5);c(39,g);b.strokeStyle=b.fillStyle=f;a.drawLine_(b,.5,1,.5,0);b.strokeStyle=b.fillStyle=
e;a.drawAntiArrow_(b,1,.5,0,.5)}};this.setValue=function(a,b,c){if(this.usefallbackonly)this.fallback.setValue(a,b,c);else{if(b!=this.prevvalue){c=rglobal.maincanvas.getContextForCell(a);var d=rglobal.maincanvas.getXOffsetForCell(a),f=rglobal.maincanvas.getYOffsetForCell(a),e=d+a.x*tw,g=f+a.y*th;d+=a.x*tw;f+=a.y*th;var k=0;if(this.dynamicdraw){drawer.tx=d;drawer.ty=f;drawer.drawCrossing2_(c,this.dynamicdrawcode,b,OFFCOLOR,ONCOLOR);this.prevvalue=b;return}b&&this.drawonly&&(b&=this.drawonly);if(b){this.usetext&&
(this.text0.style.visibility="hidden",this.text1&&(this.text1.style.visibility="visible"));var m=rglobal.offcanvas1.getCanvasForCell(a);if(this.drawextra){a=a.circuitsymbol;var q=!0;if("x"==a&&1==b){var l=1;var p=0}else"x"==a&&2==b?p=l=1:"^"==a&&1==b?(l=2,p=1):"^"==a&&2==b?(l=2,p=0):">"==a&&1==b?(l=3,p=1):">"==a&&2==b?(l=3,p=0):"v"==a&&1==b?(l=4,p=0):"v"==a&&2==b?(l=4,p=1):"<"==a&&1==b?(l=5,p=0):"<"==a&&2==b?(l=5,p=1):"m"==a&&1==b?(l=6,p=1):"m"==a&&2==b?(l=6,p=0):"]"==a&&1==b?(l=7,p=1):"]"==a&&2==
b?(l=7,p=0):"w"==a&&1==b?(l=8,p=0):"w"==a&&2==b?(l=8,p=1):"["==a&&1==b?(l=9,p=0):"["==a&&2==b?(l=9,p=1):"&"==a&&1==b?(l=10,p=1):"&"==a&&2==b?(l=10,p=0):"%"==a&&1==b?(l=11,p=0):"%"==a&&2==b?(l=11,p=1):q=!1;if("X"==a||"V"==a||"W"==a||"+"==a)q=!0,b==this.drawextrai0?(l=this.drawextrag,p=0):b==this.drawextrai1?(l=this.drawextrag,p=1):q=!1;q&&(e=2*tw*l,p*=2*th,m=rglobal.extracanvas.getCanvasAt(e,p),k=0,e+=rglobal.extracanvas.getXOffsetAt(e),g=p+rglobal.extracanvas.getYOffsetAt(p))}}else this.usetext&&
(this.text0.style.visibility="visible",this.text1&&(this.fallback.div1.style.visibility="hidden")),m=rglobal.offcanvas0.getCanvasForCell(a);c.drawImage(m,e,g,tw+k,th+k,d,f,tw+k,th+k)}this.prevvalue=b}};this.markError=function(a,b){this.usefallbackonly?this.fallback.markError(a,b):(this.ctx0.strokeStyle="red",this.ctx1.strokeStyle="#f88",this.ctx0.fillStyle="red",this.ctx1.fillStyle="#f88",this.text0.style.color="red",this.text0.title=b,this.usetext&&(this.text1.style.color="#f88",this.text1.title=
b))};this.setCursorPointer=function(){this.fallback.setCursorPointer()};this.setLook=function(a,b){if(b==TYPE_TIMER_ON||b==TYPE_TIMER_OFF)a=b==TYPE_TIMER_ON,"R"!=this.text0.innerText&&a&&(this.text0.innerText="R"),"r"==this.text0.innerText||a||(this.text0.innerText="r"),"R"!=this.text1.innerText&&a&&(this.text1.innerText="R"),"r"==this.text1.innerText||a||(this.text1.innerText="r");if(b==TYPE_SWITCH_ON||b==TYPE_SWITCH_OFF)a=b==TYPE_SWITCH_ON,"S"!=this.text0.innerText&&a&&(this.text0.innerText="S"),
"s"==this.text0.innerText||a||(this.text0.innerText="s"),"S"!=this.text1.innerText&&a&&(this.text1.innerText="S"),"s"==this.text1.innerText||a||(this.text1.innerText="s");if(b==TYPE_PUSHBUTTON_ON||b==TYPE_PUSHBUTTON_OFF)a=b==TYPE_PUSHBUTTON_ON,"P"!=this.text0.innerText&&a&&(this.text0.innerText="P"),"p"==this.text0.innerText||a||(this.text0.innerText="p"),"P"!=this.text1.innerText&&a&&(this.text1.innerText="P"),"p"==this.text1.innerText||a||(this.text1.innerText="p")};this.setTerminal=function(a,
b){this.fallback.setTerminal(a,b)}}document.body.onmouseup=function(a){lastmousedowncomponent&&(a=lastmousedowncomponent.mouseup(a),lastmousedowncomponent=null,a&&1==AUTOUPDATE&&update());global_changed_something=!0};var components=[],components_order=[],world=[],w=0,h=0,line0=[],line1=[];
function render(){if(highlightedcomponent)renderHighlightComponent(highlightedcomponent);else{for(var a=0;a<h;a++)for(var b=line0[a];b<line1[a];b++){var c=world[a][b];if(c.renderer){var d=0;c.components[0]&&(d|=c.components[0].value);c.components[1]&&(d|=c.components[1].value<<1);c.components[2]&&(d|=c.components[2].value<<2);c.components[3]&&(d|=c.components[3].value<<3);c.components[4]&&(d|=c.components[4].value<<4);c.components[5]&&(d|=c.components[5].value<<5);c.components[6]&&(d|=c.components[6].value<<
6);c.components[7]&&(d|=c.components[7].value<<7);c.setValue(d)}}ticksCounterEl&&updateTicksDisplay()}}
function renderHighlightComponent(a){for(var b=0;b<h;b++)for(var c=line0[b];c<line1[b];c++){var d=world[b][c];if(d.renderer){var f=0;d.components[0]==a&&(f|=1);d.components[1]==a&&(f|=2);d.components[2]==a&&(f|=4);d.components[3]==a&&(f|=8);d.components[4]==a&&(f|=16);d.components[5]==a&&(f|=32);d.components[6]==a&&(f|=64);d.components[7]==a&&(f|=128);d.setValue(f)}}ticksCounterEl&&updateTicksDisplay()}global_changed_something=!0;
function updateComponents(a){if(3!=AUTOUPDATE||global_changed_something||!(0<=numticks)){for(var b=!1,c=0;c<a.length;c++)a[c].changed=!1,a[c].updated=!1,a[c].prevvalue=a[c].value;for(c=0;c<a.length;c++)a[c].update(),a[c].changed&&(b=!0);b||(global_changed_something=!1);(3!=AUTOUPDATE||b||0>numticks)&&numticks++;render()}}function update(){1==UPDATE_ALGORITHM?updateComponents(components_order):updateComponents(components)}var timerticks=0;
function toggleTimers(){for(var a=!1,b=0;b<components.length;b++)if(components[b].type==TYPE_TIMER_OFF||components[b].type==TYPE_TIMER_ON){var c=components[b].number;0==c&&(c=10);-1==c&&(c=5);timerticks%c==c-1&&(components[b].clocked=!components[b].clocked,a=!0)}1==AUTOUPDATE&&a&&update();a&&(global_changed_something=!0);timerticks++}
function parseNumbers(){for(var a=0;a<h;a++)for(var b=line0[a];b<line1[a];b++)if(!world[a][b].skipparsing){var c=world[a][b].metasymbol,d=NUMBER_NONE;"="==c&&(d=NUMBER_BUS);'"'==c&&'"'==world[a][b].symbol&&(d=NUMBER_COMMENT);"l"==c&&(d=NUMBER_LED);if("r"==c||"R"==c)d=NUMBER_TIMER;"I"==c&&(d=NUMBER_ICDEF);"i"==c&&(d=NUMBER_ICCALL);"g"==c&&(d=NUMBER_GLOBAL);if(d!=NUMBER_NONE)for(var f=0;4>f;f++)if(d!=NUMBER_COMMENT||3==f){var e=b+(1==f?1:3==f?-1:0),g=a+(0==f?-1:2==f?1:0);if(!(0>e||e>=w||0>g||g>=h)){var k=
world[g][e].metasymbol;digitmap[k]&&d>world[g][e].numbertype&&(world[g][e].numbertype=d)}}}for(a=0;a<h;a++)for(b=line0[a];b<line1[a];b++)if(!world[a][b].skipparsing&&(c=world[a][b].metasymbol,digitmap[c]&&(d=world[a][b].numbertype,d!=NUMBER_NONE)))for(f=0;4>f;f++)e=1==f?1:3==f?-1:0,g=0==f?-1:2==f?1:0,e=b+e,g=a+g,!(0>e||e>=w||0>g||g>=h)&&d>world[g][e].numbertype&&(world[g][e].numbertype=d);for(a=0;a<h;a++)for(b=line0[a];b<line1[a];b++)if(!world[a][b].skipparsing){c=world[a][b].metasymbol;d=[];for(f=
0;4>f;f++)e=1==f?1:3==f?-1:0,g=0==f?-1:2==f?1:0,e=b+e,g=a+g,0>e||e>=w||0>g||g>=h||world[g][e].comment||(k=world[g][e].metasymbol,digitmap[k]&&d.push(f));for(f=0;f<d.length;f++){var m=d[f];var q=1==m?1:3==m?-1:0;var l=0==m?-1:2==m?1:0;e=b;g=a;for(var p=0,r=1;;){e+=q;g+=l;if(0>e||e>=w||0>g||g>=h)break;k=world[g][e].metasymbol;if(digitmap[k])0==m||3==m?(p+=r*parseInt(k),r*=10):(p*=10,p+=parseInt(k)),"i"==c&&(world[g][e].circuitsymbol="#");else break}if(0<f&&p!=world[a][b].number){world[a][b].number=
-1;break}world[a][b].number=p}}for(c=0;c<h;c++)for(b=line0[c];b<line1[c];b++)if(!world[c][b].skipparsing){e=b;g=c;for(p=0;!(e>=w);){k=world[g][e].metasymbol;if(digitmap[k])p*=10,p+=parseInt(k);else break;e++}if(b!=e){for(--b;b<e+1;b++)0>b||b>=w||(world[c][b].numberh=p);b=e}}for(c=0;c<h;c++)for(b=line0[c];b<line1[c];b++)if(!(world[c][b].skipparsing||0<=world[c][b].numberv)){e=b;g=c;for(p=0;!(g>=h);){k=world[g][e].metasymbol;if(digitmap[k])p*=10,p+=parseInt(k);else break;g++}if(c!=g)for(a=c-1;a<g+1;a++)0>
a||a>=h||(world[a][b].numberv=p)}for(a=0;a<h;a++)for(b=line0[a];b<line1[a];b++)!world[a][b].skipparsing&&digitmap[world[a][b].metasymbol]&&(world[a][b].number=Math.max(world[a][b].numberh,world[a][b].numberv))}var PERFORMANCELOGENABLED=!1,PERFSTART=0;function logPerformance(a){if(PERFORMANCELOGENABLED){var b=(new Date).getTime()-PERFSTART;console.log("@"+b+": "+a)}}function startLogPerformance(){PERFSTART=(new Date).getTime()}
function parseAntennas(){logPerformance("parseAntennas start");for(var a=0;a<h;a++)for(var b=line0[a];b<line1[a];b++){var c=world[a][b].circuitsymbol;if("("==c)for(var d=1,f=a,e=b+1;e<w;e++){if(")"==world[f][e].circuitsymbol){d--;if(0!=d)continue;world[a][b].antennax=e;world[a][e].antennax=b;break}"("==world[f][e].circuitsymbol&&d++}if("n"==c)for(d=1,e=b,f=a+1;f<h;f++){if("u"==world[f][e].circuitsymbol){d--;if(0!=d)continue;world[a][b].antennay=f;world[f][b].antennay=a;break}"n"==world[f][e].circuitsymbol&&
d++}}logPerformance("parseAntennas done")}
function getNeighbor(a,b,c){var d=a+(1==c||4==c||5==c?1:3==c||6==c||7==c?-1:0),f=b+(0==c||4==c||7==c?-1:2==c||5==c||6==c?1:0);if(0>d||d>=w||0>f||f>=h)return null;var e=d-a,g=f-b,k=world[f][d];if(4>c)if(-1!=k.antennax){if(d=k.antennax+e,f+=g,0>d||d>=w||0>f||f>=h)return null}else{if(-1!=k.antennay&&(d+=e,f=k.antennay+g,0>d||d>=w||0>f||f>=h))return null}else{c=world[b][d];var m=world[f][a],q=-1!=k.antennax||-1!=k.antennay,l=-1!=c.antennax||-1!=c.antennay,p=-1!=m.antennax||-1!=m.antennay;if(q||l||p)if(a=
a>d&&c.antennax>d||a<d&&c.antennax<d,b=b>f&&m.antennay>f||b<f&&m.antennay<f,q&&l&&!p&&-1!=k.antennax&&k.antennax==c.antennax){if(d=k.antennax+e,0>d||d>=w)return null}else if(q&&p&&!l&&-1!=k.antennay&&k.antennay==m.antennay){if(f=k.antennay+g,0>f||f>=h)return null}else if(l&&p&&a&&b){if(q=!0,b=world[m.antennay+(m.antennay>f?-1:1)][d],k=world[f][c.antennax+(c.antennax>d?-1:1)],b.antennax!=c.antennax&&(q=!1),k.antennay!=m.antennay&&(q=!1),q&&(d=c.antennax+e,f=m.antennay+g,0>d||d>=w||0>f||f>=h))return null}else if(q&&
!l&&!p)if(-1!=k.antennax){e=k.antennax+e;g=f+g;if(0>e||e>=w||0>g||g>=h)return null;b=world[g][k.antennax];k=world[k.y][e];-1==b.antennax&&-1==b.antennay&&-1==k.antennax&&-1==k.antennay&&(d=e,f=g)}else if(-1!=k.antennay){e=d+e;g=k.antennay+g;if(0>e||e>=w||0>g||g>=h)return null;b=world[g][k.x];k=world[k.antennay][e];-1==b.antennax&&-1==b.antennay&&-1==k.antennax&&-1==k.antennay&&(d=e,f=g)}}return world[f][d]}function getOppositeDir(a){return a^2}
function parseCells(a){world=[];logPerformance("parseCells start");var b=a.split("\n");h=b.length;w=1;for(var c=0;c<b.length;c++)w=Math.max(w,b[c].length);for(a=0;a<h;a++){world[a]=[];var d=!1,f=-1;c=null;line0[a]=0;line1[a]=0;for(var e=!1,g=0,k=0,m=0,q=0,l=0;l<w;l++){var p=new Cell,r=l>=b[a].length?" ":b[a][l];r!=BACKSLASH_ALTERNATIVE||d||(r="\\");r==DQUOT_ALTERNATIVE&&(r='"');p.symbol=r;p.displaysymbol=r;d||r!=ASTERIX_ALTERNATIVE||(r="*");p.circuitsymbol=r;p.metasymbol=d?'"':r;world[a][l]=p;p.comment=
d;p.x=l;p.y=a;d||"0"!=p.symbol&&"1"!=p.symbol&&"2"!=p.symbol||!(0<l&&'"'==b[a][l-1]||l+1<w&&'"'==b[a][l+1])||(p.displaysymbol=" ");if(d){if('"'==p.symbol){p.displaysymbol=" ";p.circuitsymbol=" ";p.comment=!0;p.commentalign=f;d=!d;if(3<=f&&4>=f)for(q>l&&(l++,world[a][l]=new Cell,world[a][l].x=l,world[a][l].y=a),c=k;c<=q;c++){r=c;4==f&&(r=q-(c-k));var v=3==f?r+1+(g-k):r-1-(q-m);v>g&&v<m?(world[a][r].commentalign=-1,world[a][r].displaysymbol=world[a][v].displaysymbol,world[a][r].circuitsymbol=world[a][v].circuitsymbol,
world[a][r].metasymbol=world[a][v].metasymbol,world[a][r].symbol=world[a][v].symbol,world[a][r].comment=!0,world[a][r].nuber=!0):(world[a][r].commentalign=-1,world[a][r].displaysymbol=" ",world[a][r].circuitsymbol=" ",world[a][r].metasymbol=" ",world[a][r].symbol=" ",world[a][r].comment=!1)}f=c=null}}else if('"'==p.symbol){p.displaysymbol=" ";p.circuitsymbol=" ";p.comment=!0;p.commentlength=2;d=!d;f=-1;for(m=l+1;'"'!=b[a][m]&&!(m+1>=w);)m++;q=m;c=l-1;if(0<=c&&"0"==b[a][c])f=0;else if(0<=c&&"1"==b[a][c])f=
1;else if(0<=c&&"2"==b[a][c])f=2;else if(0<=c&&"3"==b[a][c])f=3;else if(0<=c&&"4"==b[a][c])f=4;else{for(c=l+1;c<w&&'"'!=b[a][c];c++);c++;q++;c<w&&"0"==b[a][c]?f=0:c<w&&"1"==b[a][c]?f=1:c<w&&"2"==b[a][c]?f=2:c<w&&"3"==b[a][c]?f=3:c<w&&"4"==b[a][c]?f=4:q=m}k=g=l;c==l-1&&0<=f&&(k=c);c=0<=f&&2>=f?c<l?world[a][c]:p:null;p.commentalign=f;c&&c!=p&&(c.circuitsymbol=c.metasymbol='"',c.comment=p.comment,c.commentlength=p.commentlength,c.commentalign=p.commentalign)}d&&(c&&(3==c.commentlength&&(c.displaysymbol=
""),c.displaysymbol+=p.circuitsymbol,p.displaysymbol=" ",c.commentlength++),p.circuitsymbol=" ");" "==p.metasymbol?p.skipparsing=!0:(line1[a]=l+1,e||(e=!0,line0[a]=l))}}d=[];for(a=0;a<h;a++){f=[];for(l=0;l<w;l++)p=world[a][l],b=world[a][l].circuitsymbol,":"==b?(d[l]||(f[l]=!0),p.comment=!0,p.circuitsymbol=" ",p.displaysymbol=" ",p.metasymbol='"'):d[l]&&(p.comment=!0,f[l]=!0,p.circuitsymbol=" ",p.metasymbol='"');d=f}parseAntennas();for(a=0;a<h;a++)for(l=line0[a];l<line1[a];l++){digitmap[world[a][l].symbol]&&
!world[a][l].comment&&(world[a][l].circuitsymbol=" ");world[a][l].symbol!=BACKSLASH_ALTERNATIVE||world[a][l].comment||(world[a][l].displaysymbol="\\",world[a][l].circuitsymbol="\\",world[a][l].metasymbol="\\");b=world[a][l].circuitsymbol;if("^"==b||"m"==b)p=getNeighbor(l,a,7),d=getNeighbor(l,a,0),f=getNeighbor(l,a,4);else if(">"==b||"]"==b)p=getNeighbor(l,a,4),d=getNeighbor(l,a,1),f=getNeighbor(l,a,5);else if("v"==b||"w"==b)p=getNeighbor(l,a,5),d=getNeighbor(l,a,2),f=getNeighbor(l,a,6);else if("<"==
b||"["==b)p=getNeighbor(l,a,6),d=getNeighbor(l,a,3),f=getNeighbor(l,a,7);else continue;k=g=e=" ";p&&(e=p.metasymbol);d&&(g=d.metasymbol);f&&(k=f.metasymbol);devicemapin[g]||digitmap[g]||!(devicemapin[e]||digitmap[e]||devicemapin[k]||digitmap[k])||(world[a][l].circuitextra=2);if(0==world[a][l].circuitextra){if("^"==b||"m"==b)p=getNeighbor(l,a,2);else if(">"==b||"]"==b)p=getNeighbor(l,a,3);else if("v"==b||"w"==b)p=getNeighbor(l,a,0);else if("<"==b||"["==b)p=getNeighbor(l,a,1);e=" ";p&&(e=p.metasymbol);
if(devicemapin[e]||digitmap[e]||"*"==e||"+"==e||","==e)world[a][l].circuitextra=1;"|"!=e||"^"!=b&&"v"!=b&&"m"!=b&&"w"!=b||(world[a][l].circuitextra=1);"-"!=e||">"!=b&&"<"!=b&&"]"!=b&&"["!=b||(world[a][l].circuitextra=1)}}logPerformance("parseCells done");return!0}
function toposort(a){var b={},c=[],d;for(d in a){var f;if(f=!b[d]){a:{for(f=[d];0<f.length;){var e=f.pop();if(Infinity==e)e=f.pop(),b[e]=2,c.push(e);else{if(1==b[e]){f=!1;break a}f.push(e);f.push(Infinity);if(!b[e]){b[e]=1;for(var g in a[e])f.push(g)}}}f=!0}f=!f}if(f)return null}c.reverse();for(a=0;a<c.length;a++)c[a]=parseInt(c[a]);return c}
function parseSubs(){logPerformance("parseSubs begin");var a={};var b=initUsed2();for(var c=0;c<h;c++)for(var d=line0[c];d<line1[c];d++)if(!b[c][d]&&"i"==world[c][d].circuitsymbol){var f=[[d,c]];b[c][d]=!0;for(var e=[],g=-2,k=null,m=-1,q=-1;f.length;){var l=f.pop(),p=l[0],r=l[1];if(!(0>p||p>=w||0>r||r>=h)){var v=world[r][p].circuitsymbol;if("#"==v||"$"==v||"i"==v||digitmap[v]){e.push(l);if("i"==v&&world[r][p].number>=g)for(g=world[r][p].number,k=world[r][p],l=0;4>l;l++){var t=p+(1==l?1:3==l?-1:0),
u=r+(0==l?-1:2==l?1:0);if(!(0>t||t>=w||0>u||u>=h)){var z=world[u][t].metasymbol;digitmap[z]&&world[u][t].numbertype==NUMBER_ICCALL&&(q==g&&m!=l?m=-1:(m=l,q=g))}}for(l=0;4>l;l++)t=p+(1==l?1:3==l?-1:0),u=r+(0==l?-1:2==l?1:0),0>t||t>=w||0>u||u>=h||b[u][t]||(f.push([t,u]),b[u][t]=!0)}}}if(-1<=g){f=new CallSub;callsubs.push(f);f.subindex=g;f.chipdir=m;for(l=0;l<e.length;l++)p=e[l][0],r=e[l][1],world[r][p].callsubindex=g,world[r][p].callsub=f,"$"!=world[r][p].circuitsymbol&&(world[r][p].circuitsymbol="i"),
f.cells.push([p,r]);k&&(k.drawchip=!0)}}logPerformance("parseSubs pass 2 begin");b=initUsed2();for(c=0;c<h;c++)for(d=line0[c];d<line1[c];d++)if(!b[c][d]&&"I"==world[c][d].circuitsymbol){f=[[d,c]];b[c][d]=!0;e=[];g=-2;k=!1;q={};for(m=0;f.length;)if(l=f.pop(),p=l[0],r=l[1],!(0>p||p>=w||0>r||r>=h)&&(v=world[r][p].metasymbol,knownmap[v]||digitmap[v]||"I"==v||"@"==world[r][p].symbol)){e.push(l);if("I"==v)for(-1<=g&&(console.log("parse error: multiple connected subs "+g+" "+world[r][p].number),k=!0),g=
world[r][p].number,l=0;4>l;l++)if(t=p+(1==l?1:3==l?-1:0),u=r+(0==l?-1:2==l?1:0),!(0>t||t>=w||0>u||u>=h)&&(z=world[u][t].metasymbol,digitmap[z]&&world[u][t].numbertype==NUMBER_ICDEF)){m=l;break}"i"==v&&(q[world[r][p].callsubindex]=!0);for(l=0;8>l;l++)t=p+(1==l||4==l||5==l?1:3==l||6==l||7==l?-1:0),u=r+(0==l||4==l||7==l?-1:2==l||5==l||6==l?1:0),0>t||t>=w||0>u||u>=h||b[u][t]||(f.push([t,u]),b[u][t]=!0)}if(-1<=g){for(l=0;l<e.length;l++)p=e[l][0],r=e[l][1],world[r][p].defsubindex=g;a[g]&&(console.log("error: multiple subs with same id: "+
g),k=!0);a[g]=q;f=new DefSub;f.index=g;defsubs[g]=f;f.error=k;f.chipdir=m;for(l=0;l<e.length;l++)p=e[l][0],r=e[l][1],"s"!=world[r][p].circuitsymbol&&"S"!=world[r][p].circuitsymbol||f.externalinputs.push([p,r])}}defsubs_order=toposort(a);if(!defsubs_order){for(var y in defsubs)defsubs[y].error=!0,defsubs[y].markError();for(l=0;l<callsubs.length;l++)callsubs[l].error=!0,callsubs[l].markError();defsubs_order=[];console.log("error: loop in defsubs, would create infinite loop, ALL ICs disabled!")}logPerformance("parseSubs done");
return!0}
function convertJunctionNumbers(){var a=initUsed2();for(var b=0;b<h;b++)for(var c=line0[b];c<line1[b];c++)if(!a[b][c]){var d=[[c,b]];a[b][c]=!0;for(var f=[],e=!1;d.length;){var g=d.pop(),k=g[0],m=g[1];if(!(0>k||k>=w||0>m||m>=h)){var q=world[m][k].metasymbol;if("="==q||digitmap[q])if(!digitmap[q]||world[m][k].numbertype==NUMBER_BUS||world[m][k].numbertype==NUMBER_NONE)for(digitmap[q]&&(world[m][k].numbertype=NUMBER_BUS),f.push(g),"="==q&&(e=!0),g=0;4>g;g++){q=k+(1==g?1:3==g?-1:0);var l=m+(0==g?-1:
2==g?1:0);0>q||q>=w||0>l||l>=h||a[l][q]||(d.push([q,l]),a[l][q]=!0,world[l][q].numbertype<NUMBER_BUS&&(world[l][q].numbertype=NUMBER_BUS))}}}if(e)for(g=0;g<f.length;g++)k=f[g][0],m=f[g][1],world[m][k].circuitsymbol="="}for(m=0;m<h;m++)for(k=line0[m];k<line1[m];k++)if(!world[m][k].skipparsing&&"="==world[m][k].circuitsymbol){b=a=!1;for(g=0;4>g;g++)if(c=0==g?-1:2==g?1:0,q=k+(1==g?1:3==g?-1:0),l=m+c,!(0>q||q>=w||0>l||l>=h)&&"="!=world[l][q].circuitsymbol&&connected2(k,m,g)){if(0==g||2==g)b=!0;if(1==
g||3==g)a=!0}a&&!b&&0<=world[m][k].numberh&&(world[m][k].number=world[m][k].numberh);b&&!a&&0<=world[m][k].numberv&&(world[m][k].number=world[m][k].numberv)}for(m=0;m<h;m++)for(k=line0[m];k<line1[m];k++)world[m][k].skipparsing||"="!=world[m][k].circuitsymbol||"="!=world[m][k].metasymbol||(world[m][k].number=world[m][k].numberh=world[m][k].numberv=-1)}
function convertBackplaneNumbers(){var a=initUsed2();for(var b=0;b<h;b++)for(var c=line0[b];c<line1[b];c++)if(!a[b][c]&&"g"==world[b][c].metasymbol){for(var d=world[b][c].number,f=-1,e=0;4>e;e++){var g=c+(1==e?1:3==e?-1:0),k=b+(0==e?-1:2==e?1:0);if(!(0>g||g>=w||0>k||k>=h)&&digitmap[world[k][g].metasymbol]&&world[k][g].numbertype==NUMBER_GLOBAL){f=e;break}}if(-1!=f){var m=[[c,b]];a[b][c]=!0;for(var q=[];m.length;)if(e=m.pop(),g=e[0],k=e[1],!(0>g||g>=w||0>k||k>=h)&&world[k][g].numbertype==NUMBER_GLOBAL){var l=
world[k][g].metasymbol;0<q.length&&!digitmap[l]||(q.push(e),e=f,g+=1==e?1:3==e?-1:0,k+=0==e?-1:2==e?1:0,0>g||g>=w||0>k||k>=h||a[k][g]||(m.push([g,k]),a[k][g]=!0,world[k][g].numbertype<NUMBER_GLOBAL&&(world[k][g].numbertype=NUMBER_GLOBAL)))}for(e=0;e<q.length;e++)g=q[e][0],k=q[e][1],digitmap[world[k][g].metasymbol]&&(world[k][g].circuitsymbol="g",world[k][g].number=d,world[k][g].circuitextra=(f&1)+1)}}}
function connected(a,b,c,d,f,e,g){if(antennamap[a]||antennamap[b])return!1;g=f;2==d&&("^"!=b&&"m"!=b||4!=f&&7!=f||(g=0),">"!=b&&"]"!=b||4!=f&&5!=f||(g=1),"v"!=b&&"w"!=b||5!=f&&6!=f||(g=2),"<"!=b&&"["!=b||6!=f&&7!=f||(g=3));if("$"==a&&!devicemaparea[b])return!1;if(3<f){var k=!1;diagonalmap[a]&&(k=!0);diagonalmap[b]&&(k=!0);dinputmap[a]&&2==c&&(k=!0);dinputmap[b]&&2==d&&(k=!0);if(!k)return!1}if(3>=f&&("x"==a||"x"==b)||3<e&&"i"!=a||1<e&&"i"!=a&&"V"!=a&&"W"!=a&&"V"!=b&&"W"!=b&&"X"!=a&&"X"!=b||"-"==a&&
(0==g||2==g||4<=g)||"|"==a&&(1==g||3==g||4<=g)||","==a&&","==b||ffmap[a]&&("#"==b||"$"==b)||ffmap[b]&&("#"==a||"$"==a)||rommap[a]&&("#"==b||"$"==b)||rommap[b]&&("#"==a||"$"==a)||"i"==a&&("#"==b||"$"==b)||"i"==b&&("#"==a||"$"==a)||!knownmap[b]||"="==a&&"="==b||"+"==a&&(0!=e||1!=g&&3!=g)&&(1!=e||0!=g&&2!=g)||"%"==a&&(0!=e||1!=g&&2!=g)&&(1!=e||0!=g&&3!=g)||"&"==a&&(0!=e||2!=g&&3!=g)&&(1!=e||0!=g&&1!=g)||"/"==a&&4!=f&&6!=f||"\\"==a&&5!=f&&7!=f||"x"==a&&(0!=e||4!=f&&6!=f)&&(1!=e||5!=f&&7!=f)||("V"==a||
"W"==a||"X"==a)&&(0!=e||1!=f&&3!=f)&&(1!=e||0!=f&&2!=f)&&(2!=e||5!=f&&7!=f)&&(3!=e||4!=f&&6!=f)||dinputmap[a]&&2!=c&&!(("^"!=a&&"m"!=a||0!=f)&&(">"!=a&&"]"!=a||1!=f)&&("v"!=a&&"w"!=a||2!=f)&&("<"!=a&&"["!=a||3!=f)&&("^"!=a&&"m"!=a||1!=c||!devicemapin[b]||1!=f&&3!=f)&&(">"!=a&&"]"!=a||1!=c||!devicemapin[b]||0!=f&&2!=f)&&("v"!=a&&"w"!=a||1!=c||!devicemapin[b]||1!=f&&3!=f)&&("<"!=a&&"["!=a||1!=c||!devicemapin[b]||0!=f&&2!=f))||dinputmap[a]&&2==c&&(4>f||!("^"!=a&&"m"!=a||5==f&&0==e||6==f&&1==e)||!(">"!=
a&&"]"!=a||6==f&&0==e||7==f&&1==e)||!("v"!=a&&"w"!=a||7==f&&0==e||4==f&&1==e)||!("<"!=a&&"["!=a||4==f&&0==e||5==f&&1==e))||("U"==a||"G"==a||"V"==a||"W"==a)&&devicemapin[b])return!1;if("g"==a&&"g"==b){if(3<f)return!1;g=(f&1)+1;if(c!=g&&d!=g)return!1}return dinputmap[a]&&inputmap[b]||inputmap[a]&&dinputmap[b]||devicemap[a]&&devicemap[b]||"i"==a&&e!=f||"M"==a&&((0==f||2==f)&&1!=e||(1==f||3==f)&&0!=e||3<f)?!1:!0}
function connected2(a,b,c){var d=getNeighbor(a,b,c);if(!d)return!1;var f=d.x,e=d.y;d=world[b][a].circuitsymbol;var g=world[e][f].circuitsymbol;a=world[b][a].circuitextra;f=world[e][f].circuitextra;b=3>=c?c+2&3:4+(c-2&3);for(e=0;8>e;e++){var k=getZ2(d,g,a,f,c,e);if(connected(d,g,a,f,c,e,k)&&connected(g,d,f,a,b,k,e))return!0}return!1}
function getZ2(a,b,c,d,f,e){e=0;var g=f;2==c&&("^"!=a||5!=f&&6!=f||(g=2),">"!=a||6!=f&&7!=f||(g=3),"v"!=a||4!=f&&7!=f||(g=0),"<"!=a||4!=f&&5!=f||(g=1));"+"!=b||0!=g&&2!=g||(e=1);if("X"==b||"V"==b||"W"==b)if(0==f||2==f)e=1;else if(4==f||6==f)e=3;else if(5==f||7==f)e=2;"%"!=b||1!=g&&2!=g||(e=1);"&"!=b||3!=g&&2!=g||(e=1);"x"!=b||5!=f&&7!=f||(e=1);"i"==b&&(e=4>f?f+2&3:4+(f+2&3));"M"!=b||0!=f&&2!=f||(e=1);if(dinputmap[b]&&2==d){if("^"==b||"m"==b)return 4==f?1:0;if(">"==b||"]"==b)return 5==f?1:0;if("v"==
b||"w"==b)return 6==f?1:0;if("<"==b||"["==b)return 7==f?1:0}return e}function resetForParse(){components=[];components_order=[];world=[];h=w=0;buses=[];defsubs={};callsubs=[];backplanes_g=[];line0=[];line1=[];pause();timerticks=0;global_changed_something=!0;numticks=-1;showingLinkIds=!1}
function initUsed3(){for(var a=[],b=0;b<h;b++){a[b]=[];var c=line0[b],d=line1[b];0<b&&(c=Math.min(line0[b-1],c),d=Math.max(line1[b-1],d));b+1<h&&(c=Math.min(line0[b+1],c),d=Math.max(line1[b+1],d));0<c&&c--;for(d<w&&d++;c<d;c++)a[b][c]=world[b][c].skipparsing?[!0,!0,!0,!0,!0,!0,!0,!0]:[!1,!1,!1,!1,!1,!1,!1,!1]}return a}function initUsed2(){for(var a=[],b=0;b<h;b++){a[b]=[];for(var c=line0[b];c<line1[b];c++)a[b][c]=world[b][c].skipparsing?!0:!1}return a}var backplanes_g=[];
function parseBackplanes(){for(var a=0;a<h;a++)for(var b=line0[a];b<line1[a];b++)if("g"==world[a][b].circuitsymbol){var c=world[a][b].number;backplanes_g[c]||(backplanes_g[c]=[]);backplanes_g[c].push([b,a])}}function handleBackPlaneConnections(a,b,c,d,f){if("g"==world[d][c].circuitsymbol)for(c=backplanes_g[world[d][c].number],d=0;d<c.length;d++){f=c[d][0];var e=c[d][1];a[e][f][0]||(b.push([f,e,0]),a[e][f][0]=!0)}}
function handleJunctionConnections(a,b,c,d){if("="==world[d][c].circuitsymbol){var f=world[d][c].bus;if(f){var e=world[d][c].number;if(world[d][c].numbertype==NUMBER_BUS&&-1!=e)if(c=f.connections[e])for(d=0;d<c.length;d++){f=c[d][0];e=c[d][1];var g=c[d][2];a[e][f][g]||(b.push([f,e,g]),a[e][f][g]=!0)}else console.log("no connections for this number? this should not happen")}}}var globalLooseWireInstanceI=null,globalLooseWireInstanceE=null;
function mergeComponents(a,b){if(!(0>b.index)){for(var c=0;c<b.cells.length;c++)a.cells.push(b.cells[c]),world[b.cells[c][1]][b.cells[c][0]].components[b.cells[c][2]]=a;b.index+1<components.length&&(components[b.index]=components[components.length-1],components[b.index].index=b.index,components[components.length-1]=null);components.length--;b.index=-1}}
function parseComponents(){logPerformance("parseComponents start");globalLooseWireInstanceE=globalLooseWireInstanceI=null;var a=initUsed3();for(var b=0;b<h;b++)for(var c=line0[b];c<line1[b];c++)if(!a[b][c][0]&&"="==world[b][c].circuitsymbol){var d=[[c,b,0]];a[b][c][0]=!0;for(var f=!1,e=[];d.length;){var g=d.pop(),k=g[0],m=g[1],q=g[2];if(!(0>k||k>=w||0>m||m>=h)){var l=world[m][k].circuitsymbol,p=world[m][k].circuitextra;if(knownmap[l]&&!world[m][k].comment){"="==l&&(f=!0,e.push(g));for(g=0;8>g;g++){var r=
getNeighbor(k,m,g);if(null!=r){var v=r.x,t=r.y,u=r.circuitsymbol;r=r.circuitextra;var z=getZ2(l,u,p,r,g,q);if(!a[t][v][z]){var y=world[m][k].number,x=world[t][v].number;if("="==l||"="==u)if("="!=l||"="!=u){if("="==l&&0<=y)continue;if("="==u&&0<=x)continue;if(!connected(l,u,p,r,g,q,z))continue;var E=3>=g?g+2&3:4+(g-2&3);if(!connected(u,l,r,p,E,z,q))continue}else{if(3<g)continue}else{if(!connected(l,u,p,r,g,q,z))continue;E=3>=g?g+2&3:4+(g-2&3);if(!connected(u,l,r,p,E,z,q))continue}d.push([v,t,z]);a[t][v][z]=
!0}}}handleBackPlaneConnections(a,d,k,m,q)}}}if(f)for(l=new Bus,l.index=buses.length,buses.push(l),g=0;g<e.length;g++)k=e[g][0],m=e[g][1],q=e[g][2],world[m][k].bus=l,y=world[m][k].number,0<=y&&(l.connections[y]||(l.connections[y]=[]),l.connections[y].push([k,m,q]))}logPerformance("parseComponents pass 1 begin");a=initUsed3();for(b=0;b<h;b++)for(c=line0[b];c<line1[b];c++){g=world[b][c].circuitsymbol;var B=1;"W"==g&&(B=4);if("x"==g||"+"==g||"%"==g||"&"==g)B=2;dinputmap[g]&&2==world[b][c].circuitextra&&
(B=2);for(var C=0;C<B;C++)if(!a[b][c][C]){d=[[c,b,C]];a[b][c][C]=!0;x=TYPE_NULL;e=[];var D=null;f=!1;var F=null;y=-1;for(var G=NUMBER_NONE,I=-2;d.length;)if(g=d.pop(),k=g[0],m=g[1],q=g[2],!(0>k||k>=w||0>m||m>=h)&&(l=world[m][k].circuitsymbol,p=world[m][k].circuitextra,knownmap[l]&&!world[m][k].comment)){e.push(g);if(devicemap[l]){x!=TYPE_NULL&&x!=TYPE_UNKNOWN_DEVICE&&(g=!1,null!=world[m][k].callsub&&world[m][k].callsub==D.callsub&&(g=!0),x==TYPE_TRISTATE&&"z"==l&&(g=!0),x==TYPE_TRISTATE_INV&&"Z"==
l&&(g=!0),g||(F=x==TYPE_TRISTATE&&"Z"==l||x==TYPE_TRISTATE_INV&&"z"==l?"error: cannot mix low and high tristate buffers (z and Z)":"error: multiple devices outputting to same wire at "+k+" "+m+" (type: "+x+")",console.log(F),f=!0));D=world[m][k];"s"==l&&(x=TYPE_SWITCH_OFF);"S"==l&&(x=TYPE_SWITCH_ON);"l"==l&&(x=TYPE_LED);"L"==l&&(x=TYPE_LED_RGB);"p"==l&&(x=TYPE_PUSHBUTTON_OFF);"P"==l&&(x=TYPE_PUSHBUTTON_ON);"r"==l&&(x=TYPE_TIMER_OFF);"R"==l&&(x=TYPE_TIMER_ON);"a"==l&&(x=TYPE_AND);"A"==l&&(x=TYPE_NAND);
"o"==l&&(x=TYPE_OR);"O"==l&&(x=TYPE_NOR);"e"==l&&(x=TYPE_XOR);"E"==l&&(x=TYPE_XNOR);if("b"==l||"B"==l)x=TYPE_ROM;"M"==l&&(x=TYPE_MUX);"i"==l&&(x=TYPE_IC);"T"==l&&(x=TYPE_VTE);"z"==l&&(x=TYPE_TRISTATE);"Z"==l&&(x=TYPE_TRISTATE_INV);"?"==l&&(x=TYPE_RANDOM);ffmap[l]&&(x=TYPE_FLIPFLOP)}"toc"==l&&(x=TYPE_TOC);x!=TYPE_NULL||"#"!=l&&"$"!=l||(x=TYPE_UNKNOWN_DEVICE);0<=world[m][k].number&&devicemapin[l]&&(0<=y&&world[m][k].number!=y&&(F="multiple numbers to same component not supported",console.log(F),f=!0),
y=world[m][k].number,G=world[m][k].numbertype);-1<=world[m][k].callsubindex&&(I=world[m][k].callsubindex);for(g=0;8>g;g++)r=getNeighbor(k,m,g),null!=r&&(v=r.x,t=r.y,u=r.circuitsymbol,r=r.circuitextra,z=getZ2(l,u,p,r,g,q),!a[t][v][z]&&connected(l,u,p,r,g,q,z)&&(E=3>=g?g+2&3:4+(g-2&3),connected(u,l,r,p,E,z,q)&&(d.push([v,t,z]),a[t][v][z]=!0)));handleBackPlaneConnections(a,d,k,m,q);handleJunctionConnections(a,d,k,m)}if(x==TYPE_NULL&&0<e.length)for(x=TYPE_LOOSE_WIRE_IMPLICIT,g=0;g<e.length;g++)if(l=world[e[g][1]][e[g][0]].circuitsymbol,
"-"==l||"|"==l||"/"==l||"\\"==l||","==l||"*"==l||"+"==l||"x"==l||dinputmap[l]&&0==world[e[g][1]][e[g][0]].circuitextra){x=TYPE_LOOSE_WIRE_EXPLICIT;break}x==TYPE_ROM&&2>e.length&&(x=TYPE_NULL);!D&&0<e.length&&(D=world[e[0][1]][e[0][0]]);if(x!=TYPE_NULL){if(x==TYPE_LOOSE_WIRE_IMPLICIT&&null!=globalLooseWireInstanceI)for(d=globalLooseWireInstanceI,g=0;g<e.length;g++)d.cells.push(e[g]);else if(x==TYPE_LOOSE_WIRE_EXPLICIT&&null!=globalLooseWireInstanceE)for(d=globalLooseWireInstanceE,g=0;g<e.length;g++)d.cells.push(e[g]);
else d=new Component,d.type=x,d.cells=e,d.corecell=D,d.index=components.length,components.push(d),d.error=f,d.errormessage=F,x==TYPE_LED?G==NUMBER_LED&&(d.number=y):x==TYPE_TIMER_OFF||x==TYPE_TIMER_ON?G==NUMBER_TIMER&&(d.number=y):d.number=y,D&&(d.defsubindex=D.defsubindex),d.callsubindex=I,x==TYPE_LOOSE_WIRE_IMPLICIT&&(globalLooseWireInstanceI=d),x==TYPE_LOOSE_WIRE_EXPLICIT&&(globalLooseWireInstanceE=d);for(g=0;g<e.length;g++)k=e[g][0],m=e[g][1],q=e[g][2],world[m][k].components[q]=d}}}logPerformance("parseComponents pass 2 begin");
a=initUsed3();for(b=0;b<h;b++)for(c=line0[b];c<line1[b];c++)if(!a[b][c][0]){g=world[b][c].circuitsymbol;d=[[c,b,0]];a[b][c][0]=!0;f=y=x=B=D=!1;for(e=[];d.length;)if(g=d.pop(),k=g[0],m=g[1],q=g[2],!(0>k||k>=w||0>m||m>=h)&&(l=world[m][k].circuitsymbol,p=world[m][k].circuitextra,knownmap[l]&&!world[m][k].comment)){e.push(g);ffmap[l]&&world[m][k].components[0].type==TYPE_FLIPFLOP&&(y=!0);"T"==l&&world[m][k].components[0].type==TYPE_VTE&&(x=!0);"M"==l&&world[m][k].components[0]&&world[m][k].components[0].type==
TYPE_MUX&&(B=!0);"M"==l&&world[m][k].components[1]&&world[m][k].components[1].type==TYPE_MUX&&(B=!0);for(g=0;8>g;g++)if(v=k+(1==g||4==g||5==g?1:3==g||6==g||7==g?-1:0),t=m+(0==g||4==g||7==g?-1:2==g||5==g||6==g?1:0),!(0>v||v>=w||0>t||t>=h||(u=world[t][v].circuitsymbol,r=world[t][v].circuitextra,z=getZ2(l,u,p,r,g,q),a[t][v][z]||rommap[l]&&"M"==u||rommap[u]&&"M"==l||rommap[l]&&"T"==u||rommap[u]&&"T"==l||(rommap[l]&&(D=!0),rommap[l]&&!rommap[u]&&"#"!=u&&"$"!=u||rommap[u]&&!rommap[l]&&"#"!=l&&"$"!=l||D&&
4<=g||("T"==l&&(x=!0),"T"==l&&"T"!=u)))))if("T"!=u||"T"==l)if("M"==l&&(B=!0),"M"!=l||"M"==u||"#"==u||"$"==u)if("M"!=u||"M"==l||"#"==l||"$"==l)if(ffmap[l]&&world[m][k].components[0].type==TYPE_FLIPFLOP&&(y=!0),("#"==l||"$"==l)&&ffmap[u]&&4>g&&world[t][v].components[0].type==TYPE_FLIPFLOP&&(y=!0),!(y&&4<=g||y&&!ffmap[u]&&"#"!=u&&"$"!=u||y&&!ffmap[l]&&"#"!=l&&"$"!=l||!("c"!=l&&"C"!=l||"c"!=u&&"C"!=u)||"d"==l&&"d"==u)){if(!(D||x||y||B)){if(!connected(l,u,p,r,g,q,z))continue;E=3>=g?g+2&3:4+(g-2&3);if(!connected(u,
l,r,p,E,z,q))continue;if(devicemaparea[l]||devicemaparea[u])continue}d.push([v,t,z]);a[t][v][z]=!0}"M"==l&&(v=k,t=m,z=0==q?1:0,a[t][v][z]||(d.push([v,t,z]),a[t][v][z]=!0));handleBackPlaneConnections(a,d,k,m,q);handleJunctionConnections(a,d,k,m)}if(D){l=new ROM;c=w;b=h;for(g=m=k=0;g<e.length;g++)c=Math.min(c,e[g][0]),b=Math.min(b,e[g][1]),k=Math.max(k,e[g][0]+1),m=Math.max(m,e[g][1]+1);l.init1(c,b,k,m)||(console.log("rom error @"+c+","+b+"-"+k+","+m),l.error=!0)}if(B){l=new Mux;c=w;b=h;for(g=m=k=0;g<
e.length;g++)c=Math.min(c,e[g][0]),b=Math.min(b,e[g][1]),k=Math.max(k,e[g][0]+1),m=Math.max(m,e[g][1]+1);l.init1(c,b,k,m)||(console.log("mux error @"+e[0][0]+" "+e[0][1]),l.error=!0)}if(x){l=new VTE;c=w;b=h;for(g=m=k=0;g<e.length;g++)c=Math.min(c,e[g][0]),b=Math.min(b,e[g][1]),k=Math.max(k,e[g][0]+1),m=Math.max(m,e[g][1]+1);l.init1(c,b,k,m)||(l.error=!0)}if(y)if(x=getFFType(e),x[0]==TYPE_FLIPFLOP)g=new FF,g.init1(e)||(g.error=!0);else if(0<e.length){D=-1;k=null;for(g=0;g<e.length;g++)if(l=world[e[g][1]][e[g][0]],
ffmap[l.circuitsymbol]){D=g;k=l.components[0];break}k.type=x[0];k.value=x[1];for(g=0;g<e.length;g++)m=world[e[g][1]][e[g][0]].components[0],m!=k&&0<=m.index&&mergeComponents(k,m),world[e[g][1]][e[g][0]].components[0]=k}}f=initUsed2();for(g=0;g<components.length;g++)for(d=components[g],p=0;p<d.cells.length;p++)if(a=d.cells[p],k=a[0],m=a[1],q=a[2],l=world[m][k],l=l.circuitsymbol,inputmap[l]){a=[];b=[];if("U"==l||"G"==l)for(var A=0;4>A;A++){if(r=getNeighbor(k,m,A))v=r.x,t=r.y,u=r.circuitsymbol,devicemapin[u]&&
(a.push(v),b.push(t),f[t][v]=!0)}else if("V"==l&&d.type!=TYPE_LOOSE_WIRE_IMPLICIT||"W"==l)for(A=0;8>A;A++){if(r=getNeighbor(k,m,A))v=r.x,t=r.y,0>q||3<q||0==q&&1!=A&&3!=A||1==q&&0!=A&&2!=A||2==q&&5!=A&&7!=A||3==q&&4!=A&&6!=A||(u=r.circuitsymbol,devicemapin[u]&&(a.push(v),b.push(t),f[t][v]=!0))}else if(2==world[m][k].circuitextra){e=c=null;if("^"==l||"m"==l)c=getNeighbor(k,m,7),e=getNeighbor(k,m,4);if(">"==l||"]"==l)c=getNeighbor(k,m,4),e=getNeighbor(k,m,5);if("v"==l||"w"==l)c=getNeighbor(k,m,5),e=
getNeighbor(k,m,6);if("<"==l||"["==l)c=getNeighbor(k,m,6),e=getNeighbor(k,m,7);if(0==q){if(!c)continue;devicemapin[c.circuitsymbol]&&(a.push(c.x),b.push(c.y),f[c.y][c.x]=!0)}if(1==q){if(!e)continue;devicemapin[e.circuitsymbol]&&(a.push(e.x),b.push(e.y),f[e.y][e.x]=!0)}}else{c=-1;if("^"==l||"m"==l)c=0;if(">"==l||"]"==l)c=1;if("v"==l||"w"==l)c=2;if("<"==l||"["==l)c=3;r=getNeighbor(k,m,c);if(!r)continue;a.push(r.x);b.push(r.y);f[r.y][r.x]=!0}c=!1;if("m"==l||"]"==l||"w"==l||"["==l||"G"==l||"W"==l)c=!0;
for(A=0;A<a.length;A++)if(v=a[A],t=b[A],e=world[t][v],u=e.circuitsymbol,devicemapin[u]&&(e=e.components[0]))e.master&&(e=e.master),l=c,e.inputs.push(d),e.inputs_negated.push(l),e.inputs_x.push(k),e.inputs_y.push(m),e.inputs_x2.push(v),e.inputs_y2.push(t),e.type==TYPE_FLIPFLOP&&("j"==u?e.input_ff_types.push(1):"k"==u?e.input_ff_types.push(2):"d"==u?e.input_ff_types.push(3):"t"==u?e.input_ff_types.push(4):"q"==u?e.input_ff_types.push(5):"Q"==u?e.input_ff_types.push(6):"y"==u?e.input_ff_types.push(7):
e.input_ff_types.push(0))}a=initUsed2();for(b=0;b<h;b++)for(c=line0[b];c<line1[b];c++)if(!a[b][c]&&!f[b][c]&&(g=world[b][c].circuitsymbol,"c"==g||"C"==g)){d=[[c,b]];a[b][c]=!0;for(e=[];d.length;)if(g=d.pop(),k=g[0],m=g[1],!(0>k||k>=w||0>m||m>=h)&&(l=world[m][k].circuitsymbol,"c"==l||"C"==l))for(e.push(g),g=0;4>g;g++)v=k+(1==g?1:3==g?-1:0),t=m+(0==g?-1:2==g?1:0),0>v||v>=w||0>t||t>=h||(u=world[t][v].circuitsymbol,"c"!=u&&"C"!=u||a[t][v]||(d.push([v,t]),a[t][v]=!0));l=[];for(g=0;g<e.length;g++)if(k=
e[g][0],m=e[g][1],f[m][k])for(d=world[m][k].components[0],d.master&&(d=d.master),p=0;p<d.inputs.length;p++)0==d.input_ff_types[p]&&l.push([d.inputs[p],d.inputs_negated[p],d.inputs_x[p],d.inputs_y[p]]);for(g=0;g<e.length;g++)if(k=e[g][0],m=e[g][1],!f[m][k])for(d=world[m][k].components[0],d.master&&(d=d.master),p=0;p<l.length;p++)d.inputs.push(l[p][0]),d.inputs_negated.push(l[p][1]),d.inputs_x.push(l[p][2]),d.inputs_y.push(l[p][3]),d.inputs_x2.push(-1),d.inputs_y2.push(-1),d.input_ff_types.push(0)}for(g=
0;g<components.length;g++)if(d=components[g],d.rom&&(d.rom.error||d.rom.init2()||(d.rom.error=!0,console.log("rom error with component "+g)),d.rom.error&&(d.error=!0,d.errormessage=d.rom.errormessage)),d.mux&&(d.mux.error||d.mux.init2()||(d.mux.error=!0,console.log("mux error with component "+g)),d.mux.error&&(d.error=!0,d.errormessage=d.mux.errormessage)),d.vte&&(d.vte.error||d.vte.init2()||(d.vte.error=!0),d.vte.error&&(d.error=!0)),d.type==TYPE_TRISTATE||d.type==TYPE_TRISTATE_INV)d.tristate=new TriState,
d.tristate.init(d);for(g=0;g<components.length;g++)d=components[g],d.master&&d.master.rom&&d.master.rom.error&&(d.error=!0),d.type!=TYPE_ROM||d.master||d.rom||d.markError("is rom but has no master"),d.master&&d.master.mux&&d.master.mux.error&&(d.error=!0),d.type!=TYPE_MUX||d.master||d.mux||d.markError("is mux but has no master"),d.master&&d.master.vte&&d.master.vte.error&&(d.error=!0),d.type!=TYPE_VTE||d.master||d.vte||d.markError("is vte but has no master"),d.type==TYPE_LED_RGB&&d.sortInputsNESW();
for(A in defsubs)defsubs[A].init();var H={};for(g=0;g<defsubs_order.length;g++)H[defsubs_order[g]]=g;callsubs.sort(function(a,b){return H[b.subindex]-H[a.subindex]});for(g=0;g<callsubs.length;g++)(f=!callsubs[g].init(null))&&callsubs[g].master&&(callsubs[g].master.error=f);for(g=0;g<callsubs.length;g++)callsubs[g].init2(null);m=k=A=!1;for(g=0;g<components.length;g++)l=components[g],l.type==TYPE_COUNTER&&0==l.inputs.length&&(l.type=TYPE_CONSTANT),l.ff_cycle=l.hasLength2CycleWithTwoInputs(),l.ff_cycle&&
(m=!0),l.type==TYPE_FLIPFLOP&&(A=!0),l.type==TYPE_COUNTER&&(A=!0),l.type==TYPE_RANDOM&&(A=!0),l.type==TYPE_DELAY&&(k=!0);g=!1;a={};for(g=0;g<components.length;g++)for(a[g]={},p=0;p<components[g].inputs.length;p++)a[g][components[g].inputs[p].index]=!0;g=null==toposort(a);AUTO_CHOOSE_MODE&&(UPDATE_ALGORITHM=m?3:g&&A||!g&&k||A&&k?1:g||k?3:1,AUTOUPDATE=3,g=origtext.indexOf("MODE:"),0<=g&&(textHasAt(origtext,g+5,"immediate")?(UPDATE_ALGORITHM=1,AUTOUPDATE=3):textHasAt(origtext,g+5,"electron")&&(AUTOUPDATE=
UPDATE_ALGORITHM=3)),updateRunningState(),updateModeButtonText(),updatePauseButtonText());for(g=0;g<components.length;g++)components[g].setInitialValue();components_order=[];for(g=0;g<components.length;g++)components[g].updated=!1,components[g].added=!1;for(g=0;g<components.length;g++)if(l=components[g],!l.updated)for(d=[l];0<d.length;)if(A=d[d.length-1],A.added)d.pop();else if(A.updated)A.added=!0,A.master&&!A.master.added&&(components_order.push(A.master),A.master.added=!0,A.master.updated=!0),
components_order.push(A),d.pop();else{A.updated=!0;for(p=A.inputs.length-1;0<=p;p--)A.inputs[p].updated||d.push(A.inputs[p]);if(A.master&&!A.master.updated){k=A.master;for(p=k.inputs.length-1;0<=p;p--)k.inputs[p].updated||d.push(k.inputs[p]);d.push(A.master)}}logPerformance("parseComponents done");return!0}
function initDivs(){worldDiv.style.display="none";worldDiv.innerText="";getNewRenderer().globalInit();for(var a=h-1;0<=a;a--)for(var b=line0[a];b<line1[a];b++)world[a][b].initDiv(b,a);makeDiv(w*tw,h*th,1,1,worldDiv);worldDiv.style.display="block";renderingMessageDiv.innerText=""}function countSlowGraphicalDivs(){for(var a=0,b=0;b<h;b++)for(var c=line0[b];c<line1[b];c++)world[b][c].comment||" "==world[b][c].circuitsymbol||a++;return a}
function setDocumentTitle(a){document.title="LogicEmu: "+a;circuitName.innerText="Current Circuit: "+a}var firstParse=!0;function parseText(a,b,c,d){editmode||(firstParse?parseText2(a,b,c,d):(renderingMessageDiv.innerText="rendering",worldDiv.style.display="none",window.setTimeout(bind(parseText2,a,b,c,d),0)))}
function parseText2(a,b,c,d){firstParse||window.scrollTo(0,0);firstParse=!1;worldDiv.style.display="none";origtext=a;origtitle=b;console.log(a);var f=c?c.linkid:void 0;d||(f&&f!=introId?setFragment("id",f):clearFragment());1==d&&(d=encodeBoard(a),2E3>d.length?setFragment("code",d):getFragmentParameterByName("code")&&clearFragment());updateCircuitDropdowns(c);"\n"==a[0]&&(a=a.substr(1));d=a.indexOf("INSERT:toc");f=0;a.indexOf("INSERT:toc_help")==d&&(f=1);a.indexOf("INSERT:toc_main")==d&&(f=2);var e=
0;if(0<=d){var g=d,k=d+10;if(1==f||2==f)k+=5;'"'==a[g-1]&&(g--,"0"==a[g-1]&&g--);'"'==a[k]&&k++;for(c=0;c<g;c++)"\n"==a[c]&&e++;var m="",q=allRegisteredCircuits.length;if(1==f)for(c=q=0;c<allRegisteredCircuits.length;c++)0==allRegisteredCircuits[c].group&&q++;if(2==f){for(c=q=0;c<allRegisteredCircuits.length;c++)0!=allRegisteredCircuits[c].group&&q++;q++}for(c=1;c<q;c++)m+="\n";a=a.substr(0,g)+m+a.substr(k)}resetForParse();startLogPerformance();if(!parseCells(a))return!1;0<=d&&(world[e][0].symbol=
"toc",world[e][0].circuitsymbol="toc",world[e][0].displaysymbol="toc",world[e][0].metasymbol="toc",world[e][0].skipparsing=!1,world[e][0].circuitextra=f,line0[e]=0,line1[e]=1);logPerformance("parseNumbers begin");parseNumbers();logPerformance("parseNumbers done");logPerformance("parseBackplanes begin");convertBackplaneNumbers();parseBackplanes();logPerformance("parseBackplanes done");if(!parseSubs())return!1;logPerformance("convertJunctionNumbers begin");convertJunctionNumbers();logPerformance("convertJunctionNumbers done");
if(!parseComponents())return!1;graphics_mode_actual=graphics_mode;graphics_mode_browser!=graphics_mode_actual&&2E3<countSlowGraphicalDivs()&&(graphics_mode_actual=graphics_mode_browser);c=origtext.indexOf("RENDER:");0<=c&&(textHasAt(origtext,c+7,"text")?graphics_mode_actual=0:textHasAt(origtext,c+7,"graphical")&&(graphics_mode_actual=1));rendererDropdown.selectedIndex=graphics_mode_actual;for(c=a=0;c<h;c++)for(d=0;d<w;d++)" "!=world[c][d].circuitsymbol&&'"'!=world[c][d].circuitsymbol&&(a=Math.max(a,
d)),'"'==world[c][d].symbol&&-1==world[c][d].commentalign&&(a=Math.max(a,d)),0<world[c][d].commentlength&&-1!=world[c][d].commentalign&&(f=0,0==world[c][d].commentalign&&(f=Math.ceil(.66*world[c][d].commentlength)),1==world[c][d].commentalign&&(f=Math.ceil(.825*world[c][d].commentlength)),2==world[c][d].commentalign&&(f=world[c][d].commentlength),a=Math.max(a,d+f));f=origtext.indexOf("FIT:y");d=0;if(0<=f)for(c=0;c<f;c++)"\n"==origtext[c]&&d++;f=origtext.indexOf("FIT:y",f+1);e=0;if(0<=f){for(c=0;c<
f;c++)"\n"==origtext[c]&&e++;d=e-d}e=origtext.indexOf("FIT:r");f=0;if(0<=e)for(c=0;c<e;c++)"\n"==origtext[c]&&(f=0),f++;c=0<=origtext.indexOf("FIT:w");e=!0;g=window.innerWidth-8;k=window.innerHeight-100-8;g||(g=1E3);k||(k=800);m=h;if(20*h>k||h>w)0<d?m=d:e=!1;c&&(0<d&&d<h?m=d:e=!1);f&&(a=f);tw=Math.floor(g/(a+2));th=Math.floor(k/(m+2));c=e?Math.min(tw,th):tw;9>c&&(c=9);40<c&&(c=40);80<h&&28<c&&(c=28);th=tw=c;logPerformance("initDivs start");initDivs();logPerformance("initDivs done");logPerformance("initial render start");
1==UPDATE_ALGORITHM?update():render();logPerformance("initial render done");setDocumentTitle(b||"unnamed circuit");worldDiv.style.display="block";return!0}var AUTOPAUSESECONDS=3E3,USEAUTOPAUSE=!0,autoupdateinterval=null,timerinterval=null,autopauseinterval=null;if(2==AUTOUPDATE||3==AUTOUPDATE)autoupdateinterval=setInterval(function(){update()},1E3*AUTOSECONDS);timerinterval=setInterval(function(){toggleTimers()},1E3*TIMERSECONDS);USEAUTOPAUSE&&setAutoPauseInterval();
function setAutoPauseInterval(){autopauseinterval=setInterval(function(){pause();autopaused=!0},1E3*AUTOPAUSESECONDS)}function pause(){autopaused=!1;autoupdateinterval&&(clearInterval(autoupdateinterval),autoupdateinterval=null);timerinterval&&(clearInterval(timerinterval),timerinterval=null);autopauseinterval&&(clearInterval(autopauseinterval),autopauseinterval=null);updatePauseButtonText();updateTimeButtonBorders()}
function pauseUpdateOnly(){autoupdateinterval&&(clearInterval(autoupdateinterval),autoupdateinterval=null);updateTimeButtonBorders()}
function unpause(){autopaused=!1;highlightedcomponent=null;2!=AUTOUPDATE&&3!=AUTOUPDATE||autoupdateinterval||(autoupdateinterval=setInterval(function(){update()},1E3*AUTOSECONDS));timerinterval||(timerinterval=setInterval(function(){toggleTimers()},1E3*TIMERSECONDS));USEAUTOPAUSE&&!autopauseinterval&&(setAutoPauseInterval(),updatePauseButtonText());updateTimeButtonBorders()}
function updateRunningState(){unpause();2!=AUTOUPDATE&&3!=AUTOUPDATE&&autoupdateinterval&&(timerinterval||(timerinterval=setInterval(function(){toggleTimers()},1E3*TIMERSECONDS)),clearInterval(autoupdateinterval),autoupdateinterval=null);updatePauseButtonText()}var menuRows=makeElementAt("div",0,0);menuRows.style.position="fixed";menuRows.style.display="block";menuRows.style.width="100%";menuRows.style.height="40px";var menuRow2El=makeElementAt("span",0,0,menuRows),menuRow3El=menuRow2El;
menuRows.style.zIndex=5;menuRow2El.style.background="#f8f8f8";menuRow2El.style.position="absolute";menuRow2El.style.width="100%";menuRow2El.style.height="48px";menuRow3El.style.background="#f8f8f8";menuRow3El.style.position="absolute";menuRow3El.style.width="100%";menuRow3El.style.height="48px";var modes=[["immediate",1,3],["electron",3,3]];function getMode(){for(var a=0;a<modes.length;a++)if(UPDATE_ALGORITHM==modes[a][1]&&AUTOUPDATE==modes[a][2])return a;return-1}
var modeDropdown=makeUIElement("select",menuRow3El);modeDropdown.title="Choose Emulation Algorithm. *) immediate: does fast updates (all gates at once in sorted order, or as sorted as possible in case of loops) when using a button or timer. Updates until things stop changing (1 tick for combinational circuits). *) electron: does slow update (gate-per-gate) every so many milliseconds, emulates flip-flops crafted from gates in more interesting way with even a randomness mechanism to get them out of metastable state. When loading a new circuit, a mode is automatically chosen as follows: by default, immediate. If a particular type of loop between gates (such as in SR latch) is detected, electron. If any other loop is present: immediate";
modeDropdown.onchange=function(){var a=modeDropdown.selectedIndex;a>=modes.length&&(a=0);UPDATE_ALGORITHM=modes[a][1];AUTOUPDATE=modes[a][2];updateModeButtonText();updatePauseButtonText();updateRunningState()};for(var i=0;i<modes.length;i++)var el=makeElement("option",modeDropdown).innerText=modes[i][0];function updateModeButtonText(){var a=getMode();modeDropdown.selectedIndex=-1==a?-1:a}var tickButton=makeUIElement("button",menuRow3El);tickButton.innerText="tick";tickButton.title="Tick once. This allows ticking the circuit when paused, to investigate the signal. Especially useful in paused electron mode, or paused immediate mode if there are flip-flops or other sequential parts.";
tickButton.onclick=update;function isPaused(){return!timerinterval&&!autoupdateinterval}function updatePauseButtonText(){pauseButton.innerText=isPaused()?"paused":"pause"}var pauseButton=makeUIElement("button",menuRow3El,3);pauseButton.innerText="pause";pauseButton.title="pauses running circuit and timers, or enables them again if already paused. If paused, use the tick button to manually advance circuit state step by step instead. If you press switches of the circuit while paused, the update will be visible after you use the tick button.";
pauseButton.onclick=function(){isPaused()?unpause():pause();updateTimeButtonBorders()};updatePauseButtonText();var slowerButton=makeUIElement("button",menuRow3El,3);slowerButton.title="slows down simulation";slowerButton.innerText="slow";slowerButton.onclick=function(){AUTOSECONDS=10*NORMALAUTOSECONDS;TIMERSECONDS=10*NORMALTIMERSECONDS;pause();unpause();updateTimeButtonBorders()};var normalButton=makeUIElement("button",menuRow3El,3);normalButton.title="set to standard speed";
normalButton.innerText="norm";normalButton.onclick=function(){AUTOSECONDS=NORMALAUTOSECONDS;TIMERSECONDS=NORMALTIMERSECONDS;pause();unpause();updateTimeButtonBorders()};var boostButton=makeUIElement("button",menuRow3El,3);boostButton.title="speeds up simulation, if possible within the computational resources of the web browser";boostButton.innerText="fast";boostButton.onclick=function(){AUTOSECONDS=NORMALAUTOSECONDS/10;TIMERSECONDS=NORMALTIMERSECONDS/10;pause();unpause();updateTimeButtonBorders()};
var timebuttons=[pauseButton,slowerButton,normalButton,boostButton];function updateTimeButtonBorders(){var a=0;isPaused()?a=0:AUTOSECONDS>NORMALAUTOSECONDS?a=1:AUTOSECONDS==NORMALAUTOSECONDS?a=2:AUTOSECONDS<NORMALAUTOSECONDS&&(a=3);for(var b=0;4>b;b++)b==a?highlightUIElementBorder(timebuttons[b],2==b?"black":"red"):styleUIElementBorder(timebuttons[b])}var ticksCounterEl=makeElement("div",menuRow3El);ticksCounterEl.innerHTML="&nbspticks:"+numticks;ticksCounterEl.style.width="95px";
ticksCounterEl.style.display="inline-block";ticksCounterEl.title="Amount of ticks so far. Click to reset to 0. If in electron mode, is per gate ticks. In immediate mode, one tick per full update.";ticksCounterEl.onclick=function(){numticks=0;updateTicksDisplay()};function updateTicksDisplay(){ticksCounterEl.innerHTML="&nbspticks: "+numticks}var rendererDropdown=makeUIElement("select",menuRow2El);rendererDropdown.title="Choose renderer: graphical or text. Graphical is with HTML5 canvas and has better looking wire connections but may be slower for huge circuits. Text mode is faster and is more closely related to how you edit circuits with ASCII text.";
rendererDropdown.onchange=function(){graphics_mode_actual=graphics_mode=rendererDropdown.selectedIndex;initDivs();render()};makeElement("option",rendererDropdown).innerText="text";makeElement("option",rendererDropdown).innerText="graphical";rendererDropdown.selectedIndex=graphics_mode;var colorDropdown=makeUIElement("select",menuRow2El,3);colorDropdown.title="Choose color scheme";
colorDropdown.onchange=function(){setLocalStorage(colorDropdown.selectedIndex,"color_scheme");setColorScheme(colorDropdown.selectedIndex);initDivs();render()};makeElement("option",colorDropdown).innerText="light";makeElement("option",colorDropdown).innerText="dark";makeElement("option",colorDropdown).innerText="gray";makeElement("option",colorDropdown).innerText="blue";makeElement("option",colorDropdown).innerText="inverted";colorDropdown.selectedIndex=colorscheme;
var zoomoutButton=makeUIElement("button",menuRow2El,1);zoomoutButton.innerText="-";zoomoutButton.title="Zoom out";zoomoutButton.onclick=function(){8>=tw&&8>=th||(tw=Math.floor(.66*tw),th=Math.floor(.66*th),8>tw&&(tw=8),8>th&&(th=8),initDivs(),render())};var zoominButton=makeUIElement("button",menuRow2El,1);zoominButton.innerText="+";zoominButton.title="Zoom in";zoominButton.onclick=function(){64<=tw&&64<=th||(tw=Math.floor(1.5*tw),th=Math.floor(1.5*th),64<tw&&(tw=64),64<th&&(th=64),initDivs(),render())};
makeUISpacer(16,menuRow2El);var changeDropdownElements=[],changeDropdown=makeUIElement("select",menuRow2El);changeDropdown.title='A simpler more primitive form of edit, but it works while a circuit is running. Change the type of a gate, switch or LED to this. First click an option from this list, then the main cell of a device (e.g. the "a" of an AND gate). This is a very limited form of editing. It doesn\'t support creating or removing wire connections. It can only change a device that has one of the types in the list to another type in the list. On other devices it may either do nothing, or cause unexpected behavior. Changes in IC templates have no effect on instances. Changes are not saved and not visible under the edit button. To do full editing, use the edit button instead.';
changeDropdown.onchange=function(){changeMode=changeDropdownElements[changeDropdown.selectedIndex]};function registerChangeDropdownElement(a){var b=void 0==typesymbols[a]?"[change]":typesymbols[a];"rem_inputs"==a&&(b="disconnect inputs");if("c"==a||"C"==a)b=a;makeElement("option",changeDropdown).innerText=b;changeDropdownElements.push(a)}registerChangeDropdownElement("change");registerChangeDropdownElement(TYPE_SWITCH_ON);registerChangeDropdownElement(TYPE_SWITCH_OFF);registerChangeDropdownElement(TYPE_PUSHBUTTON_ON);
registerChangeDropdownElement(TYPE_PUSHBUTTON_OFF);registerChangeDropdownElement(TYPE_TIMER_ON);registerChangeDropdownElement(TYPE_TIMER_OFF);registerChangeDropdownElement(TYPE_LED);registerChangeDropdownElement(TYPE_LED_RGB);registerChangeDropdownElement(TYPE_AND);registerChangeDropdownElement(TYPE_OR);registerChangeDropdownElement(TYPE_XOR);registerChangeDropdownElement(TYPE_NAND);registerChangeDropdownElement(TYPE_NOR);registerChangeDropdownElement(TYPE_XNOR);registerChangeDropdownElement("c");
registerChangeDropdownElement("C");registerChangeDropdownElement(TYPE_DELAY);registerChangeDropdownElement(TYPE_RANDOM);registerChangeDropdownElement("rem_inputs");var editmode=!1,textbeforeedit="",editdiv,editarea,editButton=makeUIElement("button",menuRow2El,3);editButton.innerText="edit";editButton.title='Opens text field to edit the map. Press this button again to stop editing and run the new circuit. Read the editing tutorial under "help" first. Advice: for large projects, do not actually edit in the text field because that is fiddly, use a good text editor (that has block selection), or copypaste a circuit in here from an external source. Once you use edit, the circuit will be saved in local storage (only the most recent one). To remove such save, press the forget button. Local storage is unreliable, so if you made a circuit you want to keep, copypaste it into a text editor and save it as a .txt file on disk instead. Note that nothing gets sent to any server or cloud, everything islocal to your computer only.';
editButton.onclick=function(){if(editmode){var a=editarea.value;document.body.removeChild(editarea);editButton.innerText="edit";editmode=!1;a!=textbeforeedit?(setLocalStorage(a,"circuit_text"),parseText(a,"edited circuit",void 0,1)):parseText(a,"edited circuit",void 0,2)}else{textbeforeedit=origtext;a=window.innerWidth-8;var b=window.innerHeight-100-8,c=Math.max(w,40),d=Math.min(Math.max(origtext.split("\n").length,16));editarea=makeAbsElement("textarea",30,128,a-80,b-80);editarea.rows=d;editarea.cols=
c;editarea.value=origtext;editarea.style.fontSize="10px";editarea.style.zIndex="1";pause();numticks=0;resetForParse();initDivs();editButton.innerText="done";editmode=!0}};
if(getLocalStorage("circuit_text")){var restoreButton=makeUIElement("button",menuRow2El,3);restoreButton.innerText="restore";restoreButton.title="Restore circuit you created before with edit. Only works if an actual circuit was found in local storage.";restoreButton.onclick=function(){maybeLoadFromLocalStorage()&&parseText(initialCircuitText,initialTitle,initialId?linkableCircuits[initialId]:null,1)};var forgetButton=makeUIElement("button",menuRow2El,3);forgetButton.innerText="forget";forgetButton.title=
"If you have edited a circuit, this removes the saved circuit from local storage. If you refresh after pressing this buttonand also remove URL fragments (#id=... or #code=...), you will no longer see the last circuit you edited, but the default introduction. WARNING! if you want to keep your circuit, make sure you save it to disk first! That can be done bycopypasting it from the edit field into a text editor and saving to your disk, e.g. as a .txt file.";forgetButton.onclick=function(){setLocalStorage("",
"circuit_text");clearFragment()}}
function transpose(a){a.indexOf("\\");for(a=a.split("\n");0<a.length&&0==a[0].length;)a.splice(0,1);for(;0<a.length&&0==a[a.length-1].length;)a.length--;h=a.length;for(var b=w=0;b<a.length;b++)w=Math.max(w,a[b].length);b=[];for(var c=[],d=0;d<h;d++){b[d]=[];for(var f=!1,e=[],g=0;g<w;g++){var k=g<a[d].length?a[d][g]:" ";if(f)'"'==k||"`"==k?(k=":",f=!1):":"==k&&(k="~");else if(c[g])e[g]=!0,":"==k?(e[g]=!1,k='"'):'"'==k||"`"==k?k=":":"~"==k&&(k=":");else if("|"==k)k="-";else if("-"==k)k="|";else if("^"==
k)k="<";else if(">"==k)k="v";else if("v"==k)k=">";else if("<"==k)k="^";else if("m"==k)k="[";else if("]"==k)k="w";else if("w"==k)k="]";else if("["==k)k="m";else if("n"==k)k="(";else if(")"==k)k="u";else if("u"==k)k=")";else if("("==k)k="n";else if(":"==k)k='"',e[g]=!0;else if('"'==k||"`"==k)k=":",f=!0;b[d][g]=k}c=e}a="\n";for(g=0;g<w;g++){for(d=0;d<h;d++)a+=b[d][g];a+="\n"}return a}
function mirror(a){var b=0<=a.indexOf("\\");for(a=a.split("\n");0<a.length&&0==a[0].length;)a.splice(0,1);for(;0<a.length&&0==a[a.length-1].length;)a.length--;h=a.length;for(var c=w=0;c<a.length;c++)w=Math.max(w,a[c].length);c=[];for(var d=[],f=0;f<h;f++){c[f]=[];for(var e=!1,g=[],k=0;k<w;k++){var m=k<a[f].length?a[f][k]:" ";e||d[k]?(d[k]&&(g[k]=!0),'"'==m?e=!1:":"==m&&(g[k]=!1)):">"==m?m="<":"<"==m?m=">":"]"==m?m="[":"["==m?m="]":")"==m?m="(":"("==m?m=")":"%"==m?m="&":"&"==m?m="%":"/"==m?m=b?"\\":
BACKSLASH_ALTERNATIVE:"\\"==m||m==BACKSLASH_ALTERNATIVE?m="/":":"==m?g[k]=!0:'"'==m&&(e=!0);c[f][k]=m}d=g}b="\n";for(f=0;f<h;f++){for(k=0;k<w;k++)b+=c[f][w-k-1];b+="\n"}return b}function transform(a,b){return 0==b?a:1==b?mirror(transpose(a)):2==b?mirror(transpose(mirror(transpose(a)))):3==b?transpose(mirror(a)):4==b?transpose(a):5==b?transpose(mirror(transpose(a))):6==b?mirror(transpose(mirror(a))):7==b?mirror(a):a}
function applyTransform(a){a=transform(origtext,a);parseText(a,"transformed circuit",void 0,1)}function applyAllTransforms(){for(var a="",b=0;8>b;b++)a+=transform(origtext,b)+"\n";parseText(a,"transformed circuit",void 0,1)}function printTransform(a,b){console.log(transform(a,b))}function maybeLoadFromLocalStorage(){var a=getLocalStorage("circuit_text");if(!a)return!1;""!=a&&a&&(initialCircuitText=a,initialTitle="stored circuit",initialId=null);return!0}
function maybeLoadFromLinkId(){var a=getFragmentParameterByName("id");if(!a)return!1;var b=linkableCircuits[a];b?(initialCircuitText=b.text,initialTitle=b.title,initialId=a,currentSelectedCircuit=b.index):(initialCircuitText="R>l 1\"Circuit with id '"+a+"' not found, loading intro instead.\" l<R\n\n"+introText,initialTitle=introTitle,initialId=introId);return!0}
function maybeLoadFromUrlCode(){var a=getFragmentParameterByName("code");if(!a)return!1;(a=decodeBoard(a))?(initialCircuitText=a,initialTitle="Decoded circuit",initialId=void 0):(initialCircuitText='R>l 1"Invalid #code in the URL" l<R\n\n'+introText,initialTitle=introTitle,initialId=introId);return!0}function toBase64(a){a=btoa(a);a=a.split("=")[0];a=a.replace(/\+/g,"-");return a=a.replace(/\//g,"_")}
function fromBase64(a){a=a.replace(/-/g,"+");a=a.replace(/_/g,"/");2==(a.length&3)?a+="==":3==(a.length&3)&&(a+="=");return atob(a)}function arrayToString(a){for(var b="",c=0;c<a.length;c++){var d=a[c];65536>d?b+=String.fromCharCode(d):1114111>=d?(b+=String.fromCharCode((d>>10)+55232),b+=String.fromCharCode((d&1023)+56320)):b+=" "}return b}function arrayToStringPart(a,b,c){for(var d="",f=b;f<b+c;f++)d+=String.fromCharCode(a[f]);return d}
function stringToArray(a){for(var b=[],c=0;c<a.length;c++){var d=a.charCodeAt(c);if(55296<=d&&56319>=d&&c+1<a.length){var f=a.charCodeAt(c+1);56320<=f&&57343>=f&&(d=(d<<10)+f-56613888,c++)}b.push(d)}return b}
function LZ77Coder(){this.lz77MatchLen=function(a,b,c){for(var d=0;c+d<a.length&&a[c+d]==a[b+d]&&255>d;)d++;return d};this.encodeString=function(a){return arrayToString(this.encode(stringToArray(a)))};this.decodeString=function(a){return arrayToString(this.decode(stringToArray(a)))};this.encode=function(a){for(var b=[],c={},d=function(a,b){128>a?b.push(a):16384>a?(b.push(128|a&127),b.push(a>>7)):(b.push(128|a&127),b.push(128|a>>7&127),b.push(a>>14&127))},f=0;f<a.length;f++){var e=0,g=0,k=arrayToStringPart(a,
f,4);if(k=c[k])for(var m=k.length-1;0<=m;m--){var q=k[m],l=f-q;if(2097151<l)break;q=this.lz77MatchLen(a,q,f);if(q>e&&(e=q,g=l,255<q))break}2097151<e&&(e=2097151);5<e||4<e&&16383>g||3<e&&127>g||(e=1);for(m=0;m<e;m++)k=arrayToStringPart(a,f+m,4),c[k]||(c[k]=[]),1E3<c[k].length&&(c[k]=[]),c[k].push(f+m);f+=e-1;3<=e?(130>e?b.push(128+e-3):(e-=128,b.push(255),d(e,b)),d(g,b)):(g=a[f],128>g?b.push(g):(b.push(255),d(g-128,b),b.push(0)))}return b};this.decode=function(a){for(var b=[],c=0;c<a.length;){var d=
a[c++];if(127<d){var f=d+3-128;255==d&&(f=a[c++],127<f&&(f+=(a[c++]<<7)-128),16383<f&&(f+=(a[c++]<<14)-16384),f+=128);dist=a[c++];127<dist&&(dist+=(a[c++]<<7)-128);16383<dist&&(dist+=(a[c++]<<14)-16384);if(0==dist)b.push(f);else for(d=0;d<f;d++)b.push(b[b.length-dist])}else b.push(d)}return b}}
function RangeCoder(){this.base=256;this.high=16777216;this.low=65536;this.num=256;this.values=[];this.inc=8;this.reset=function(){this.values=[];for(var a=0;a<=this.num;a++)this.values.push(a)};this.floordiv=function(a,b){return Math.floor(a/b)};this.mask32=function(a){return 2*(a>>1&2147483647)+(a&1)};this.update=function(a){if(this.getTotal()+this.inc>=this.low)for(var b=this.values[0],c=0;c<this.num;c++){var d=this.values[c+1]-b;d=1<d?this.floordiv(d,2):d;b=this.values[c+1];this.values[c+1]=this.values[c]+
d}for(c=a+1;c<this.values.length;c++)this.values[c]+=this.inc};this.getProbability=function(a){return[this.values[a],this.values[a+1]]};this.getSymbol=function(a){a=this.binSearch(this.values,a);var b=this.getProbability(a);b.push(a);return b};this.getTotal=function(){return this.values[this.values.length-1]};this.binSearch=function(a,b){var c=a.length-1,d=0,f=0;if(b>a[c])return c;for(;d<=c;){var e=this.floordiv(d+c,2);a[e]>=b?(f=e,c=e-1):d=e+1}0<f&&a[f]>b&&f--;return f};this.encodeString=function(a){return arrayToString(this.encode(stringToArray(a)))};
this.decodeString=function(a){return arrayToString(this.decode(stringToArray(a)))};this.encode=function(a){this.reset();var b=[1],c=0,d=4294967295;b.push(a.length&255);b.push(a.length>>8&255);b.push(a.length>>16&255);b.push(a.length>>24&255);for(var f=0;f<a.length;f++){var e=a[f],g=this.getProbability(e),k=this.getTotal(),m=g[0];g=g[1]-g[0];this.update(e);d=this.floordiv(d,k);c=this.mask32(m*d+c);for(d=this.mask32(d*g);;){if(0==c&&0==d)return null;if(this.mask32(c^c+d)>=this.high){if(d>=this.low)break;
d=this.mask32(-c&this.low-1)}b.push(this.floordiv(c,this.high)&this.base-1);d=this.mask32(d*this.base);c=this.mask32(c*this.base)}}for(f=this.high;0<f;f=this.floordiv(f,this.base))b.push(this.floordiv(c,this.high)&this.base-1),c=this.mask32(c*this.base);if(b.length>a.length)for(b=[0],f=0;f<a.length;f++)b[f+1]=a[f];return b};this.decode=function(a){if(1>a.length)return null;var b=[];if(0==a[0]){for(var c=1;c<a.length;c++)b[c-1]=a[c];return b}if(1!=a[0]||5>a.length)return null;this.reset();var d=0,
f=0,e=4294967295,g=1,k=a[g++];k|=a[g++]<<8;k|=a[g++]<<16;k|=a[g++]<<24;k=this.mask32(k);for(c=this.high;0<c;c=this.floordiv(c,this.base)){var m=g>=a.length?0:a[g++];d=this.mask32(d*this.base+m)}for(c=0;c<k;c++){m=this.getTotal();var q=this.floordiv(d-f,this.floordiv(e,m)),l=this.getSymbol(q);q=l[2];b.push(q);var p=l[0];l=l[1]-l[0];this.update(q);e=this.floordiv(e,m);f=this.mask32(p*e+f);for(e=this.mask32(e*l);;){if(0==f&&0==e)return null;if(this.mask32(f^f+e)>=this.high){if(e>=this.low)break;e=this.mask32(-f&
this.low-1)}m=g>=a.length?0:a[g++];d=this.mask32(d*this.base+m);e=this.mask32(e*this.base);f=this.mask32(f*this.base)}}return b}}function encodeBoard(a){a=(new LZ77Coder).encodeString(a);a=(new RangeCoder).encodeString(a);return"0"+toBase64(a)}function decodeBoard(a){if("0"!=a[0])return null;a=a.substr(1);a=fromBase64(a);return(a=(new RangeCoder).decodeString(a))||""==a?(new LZ77Coder).decodeString(a):null}
function testCompression(a){a||""==a||(a=origtext);var b=encodeBoard(a),c=decodeBoard(b)==a;console.log("o size: "+Math.ceil(8*a.length/6)+", e size: "+b.length+", ok: "+c);c||console.log("ERROR! not equal!");return c}function updateCircuitDropdowns(a){if(a)for(b=0;b<circuitGroups.length;b++)circuitGroups[b].dropdown.selectedIndex=b==a.group?a.groupindex+1:0;else for(var b=0;b<circuitGroups.length;b++)circuitGroups[b].dropdown.selectedIndex=0}
function CircuitGroup(a){this.circuits=[];this.main=makeElement("div",circuitDropdownSpan);this.main.style.display="inline-block";this.title=makeElement("span",this.main);this.title.innerText=a;makeElement("br",this.main);this.dropdown=makeUIElement("select",this.main);this.dropdown.style.width="120px";this.dropdown.title='Built-in circuit selector dropdown "'+a+'"';var b=this;this.dropdown.onchange=function(){var a=b.circuits[b.dropdown.selectedIndex-1];currentSelectedCircuit=a.index;parseText(a.text,
a.title,a)}}var currentCircuitGroup=null,circuitGroups=[];function registerCircuitGroup(a){currentCircuitGroup=new CircuitGroup(a);circuitGroups.push(currentCircuitGroup);makeElement("option",currentCircuitGroup.dropdown).innerHTML="[choose circuit]"}var allRegisteredCircuits=[],linkableCircuits={},linkableCircuitsOrder=[];
function registerCircuit(a,b,c,d){c||(c="circuit"+allRegisteredCircuits.length);var f=a;d&&"--------"!=a&&(f="--- "+a+" ---");var e=makeElement("option",currentCircuitGroup.dropdown);"mainhelp"==c&&(e.style.fontWeight="bold");e.innerHTML=f;f=allRegisteredCircuits.length;e={};e.text=b;e.title=a;e.linkid=c;e.istitle=d;e.group=circuitGroups.length-1;e.index=f;e.groupindex=currentCircuitGroup.circuits.length;currentCircuitGroup.circuits.push(e);allRegisteredCircuits.push(e);c&&(linkableCircuits[c]=e,
linkableCircuitsOrder.push(c))}function registerTitle(a){var b=a;a||(b="--------");registerCircuit(b,'0"This is a title section. Choose the next circuit to view the first one under this title.',void 0,1)}
var fallbackhelptext='0"Load any circuit from the dropdowns above, or press edit to make a new one."\n0"Use help if this is your first time"',introText='\n0"Welcome to LogicEmu, a digital logic simulator!"\n\n0"In circuits, press the green \'s\' inputs with the mouse to change values."\n0"Read results from the red \'l\' outputs. For example, below is an AND gate \'a\'."\n0"Only if both switches are on, the LED will go on. Try enabling both"\n0"switches by clicking them:""\n\n  s****>a****>l\n        ^\n  s******0"AND GATE"\n\n0"There are much more types of gates and devices available: logic gates,"\n0"flip-flops, integrated circuits, ROMs, displays, ... Explore the circuits"\n0"index below or read the help circuits first to learn more!"\n\n  s**>a**>o**>l"carry"0\n     >    ^            s--\x3ejq->l\n  s**>e**>a    0"ADDER"s--\x3ec#    0"JK FLIPFLOP"\n         >             s--\x3ekQ->l\n  s******>e**>l"sum"0\n\n\n0"Circuits Index"\n0"--------------"\n\n0"INSERT:toc_main"\n\n\n0"You can also use the \'help\', \'articles\' and \'circuits\' dropdowns"\n0"and the prev/next buttons in the top bar to navigate to these. You can also"\n0"edit or create your own circuits instead."\n\n0"Even this welcome page itself is a circuit, named \'Welcome\'"\n0"in the \'help\' dropdown but hidden in the list and help index above on"\n0"purpose to avoid such redundancy."\n\n0"A note about running in the browser"\n0"-----------------------------------"\n\n0"LogicEmu runs completely offline, even though it uses JavaScript in a"\n0"web browser. Once the HTML and JS got fetched, it does not make any"\n0"further connections to any server, cloud or remote storage."\n\n0"If you download the HTML file and the few JS files (with view source"\n0"or from github) and save them to disk, you can run LogicEmu locally"\n0"without internet."\n\n0"All circuits listed above are already loaded since they are hardcoded"\n0"in LogicEmu\'s source code (all of them, no dynamic requests are done)."\n\n0"If you edit your own circuit, it\'s only stored in your browsers local"\n0"storage (not a cookie), it\'s not sent anywhere. To share a circuit with"\n0"others, you must post its source or base64 URL code somewhere yourself."\n\n0"FIT:w"\n\n0"LogicEmu. Copyright (C) 2018 by Lode Vandevenne"',introTitle=
"Browser-Based Logic Simulator",introId="welcome";function printComponentsDebug(){for(var a=0;a<components.length;a++){var b=components[a],c="comp "+a+": "+b.corecell.symbol+" t:"+b.type+" @"+b.corecell.x+","+b.corecell.y;b.rom&&(c+=" rom");b.master&&(c+=" master:"+b.master.index);b.ff&&(c+=" ff");console.log(c);for(c=0;c<b.inputs.length;c++)console.log(""+b.inputs[c].index+(b.inputs_negated[c]?" -o ":" -> ")+a)}};
